<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bíblia Digital - Pesquisa e Navegação</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Lora:italic,wght@0,500;1,500&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        .font-serif { font-family: 'Lora', serif; }
        [lucide] { width: 20px; height: 20px; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .btn-nav:disabled { opacity: 0.3; cursor: not-allowed; }
        .result-card:active { transform: scale(0.98); }
        /* Custom scrollbar para resultados */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen pb-20 selection:bg-indigo-100">

    <!-- Header -->
    <header class="bg-white/95 backdrop-blur-md border-b border-slate-200 sticky top-0 z-40 shadow-sm">
        <div class="max-w-2xl mx-auto px-6 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-xl shadow-lg shadow-indigo-100 text-white">
                    <i data-lucide="book-open"></i>
                </div>
                <h1 class="font-bold text-lg tracking-tight">Bíblia Digital</h1>
            </div>
            <div class="flex items-center gap-2">
                <div id="statusBadge" class="hidden flex items-center gap-1.5 bg-emerald-50 text-emerald-700 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest border border-emerald-100">
                    <i data-lucide="shield-check" class="w-3 h-3"></i> Token Ativo
                </div>
                <button id="toggleSettings" class="p-2 rounded-full text-slate-500 hover:bg-slate-100 transition-all">
                    <i data-lucide="settings"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-2xl mx-auto px-4 py-6 space-y-6">
        
        <!-- Pesquisa por Palavra-Chave -->
        <section class="bg-white p-2 rounded-[2rem] border border-slate-200 shadow-sm flex items-center gap-2 pr-4">
            <div class="flex-1 relative">
                <input type="text" id="searchInput" placeholder="Pesquisar palavra (ex: Amor, Fé)..." class="w-full bg-transparent p-4 pl-12 text-sm font-medium outline-none" onkeypress="if(event.key === 'Enter') handleSearch()">
                <i data-lucide="search" class="absolute left-4 top-4 text-slate-400 w-5 h-5"></i>
            </div>
            <button onclick="handleSearch()" id="searchBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-2xl transition-all shadow-md active:scale-95">
                <i data-lucide="arrow-right"></i>
            </button>
        </section>

        <!-- Painel de Configurações (Oculto por padrão) -->
        <section id="settingsPanel" class="hidden bg-white p-6 rounded-3xl border border-slate-200 shadow-2xl space-y-6 animate-fade-in">
            <div class="flex items-center justify-between border-b border-slate-100 pb-4">
                <h2 class="font-bold text-slate-800 flex items-center gap-2">Painel de Controlo</h2>
                <button id="closeSettings" class="text-[10px] font-black text-indigo-600 uppercase tracking-widest bg-indigo-50 px-3 py-1.5 rounded-lg">Fechar</button>
            </div>
            
            <div class="space-y-3">
                <label class="text-xs font-bold text-slate-400 uppercase tracking-widest">Tradução</label>
                <select id="versionSelect" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 transition-all font-semibold text-sm">
                    <option value="nvi">NVI (Nova Versão Internacional)</option>
                    <option value="acf">ACF (Almeida Corrigida Fiel)</option>
                    <option value="ra">RA (Almeida Revista e Atualizada)</option>
                    <option value="kjv">KJV (King James Version)</option>
                </select>
            </div>

            <div class="space-y-4 pt-4 border-t border-slate-100">
                <div class="flex items-center justify-between">
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-widest">Acesso API</label>
                    <button id="logoutBtn" class="hidden flex items-center gap-1 text-[10px] text-rose-500 font-bold uppercase hover:underline">
                        <i data-lucide="log-out" class="w-3 h-3"></i> Sair
                    </button>
                </div>
                <!-- Auth UI Reused from previous version -->
                <div id="authNone" class="bg-slate-50 p-5 rounded-2xl border border-slate-100 text-center space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="setAuthMode('register')" class="p-3 text-[11px] font-black bg-white border border-slate-200 rounded-xl hover:border-indigo-300 transition-all uppercase shadow-sm">Registar</button>
                        <button onclick="setAuthMode('login')" class="p-3 text-[11px] font-black bg-white border border-slate-200 rounded-xl hover:border-indigo-300 transition-all uppercase shadow-sm">Login (PUT)</button>
                    </div>
                </div>
                <form id="authForm" class="hidden bg-white p-5 rounded-2xl space-y-4 border border-slate-100 shadow-inner">
                    <div class="space-y-3">
                        <input id="authName" type="text" placeholder="Nome" class="hidden w-full p-3.5 rounded-xl border border-slate-200 text-sm outline-none focus:ring-2 focus:ring-indigo-500">
                        <input id="authEmail" type="email" placeholder="E-mail" required class="w-full p-3.5 rounded-xl border border-slate-200 text-sm outline-none focus:ring-2 focus:ring-indigo-500">
                        <div class="relative">
                            <input id="authPass" type="password" placeholder="Senha" required class="w-full p-3.5 rounded-xl border border-slate-200 text-sm outline-none pr-12 focus:ring-2 focus:ring-indigo-500">
                            <button type="button" id="togglePass" class="absolute right-4 top-3.5 text-slate-300 hover:text-indigo-500"><i data-lucide="eye"></i></button>
                        </div>
                    </div>
                    <div id="authError" class="hidden p-3 bg-rose-50 text-rose-700 text-[10px] font-bold rounded-xl flex items-center gap-2 border border-rose-100">
                        <i data-lucide="alert-circle" class="w-3 h-4"></i> <span id="authErrorText"></span>
                    </div>
                    <div class="flex gap-2">
                        <button type="submit" id="authSubmit" class="flex-1 bg-indigo-600 text-white py-4 rounded-xl text-[10px] font-black uppercase tracking-widest">Confirmar</button>
                        <button type="button" onclick="setAuthMode('none')" class="px-4 py-4 text-slate-400 text-[10px] font-black uppercase">Voltar</button>
                    </div>
                </form>
                <div id="authSuccess" class="hidden bg-indigo-50/50 p-5 rounded-2xl border border-indigo-100 flex items-center justify-between">
                    <div class="overflow-hidden"><p id="connectedEmail" class="text-sm font-bold text-indigo-900 truncate"></p></div>
                    <i data-lucide="check-circle-2" class="w-5 h-5 text-emerald-500"></i>
                </div>
            </div>
        </section>

        <!-- Resultados da Pesquisa -->
        <section id="searchResultsSection" class="hidden space-y-4 animate-fade-in">
            <div class="flex items-center justify-between border-b border-slate-200 pb-2">
                <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-[0.4em]">Resultados da Pesquisa</h3>
                <button onclick="clearSearch()" class="text-[10px] font-bold text-indigo-600 uppercase hover:underline">Limpar</button>
            </div>
            <div id="searchResultsList" class="grid gap-4 max-h-[400px] overflow-y-auto custom-scroll pr-2"></div>
        </section>

        <!-- Versículo Card (Main Display) -->
        <section id="verseCard" class="min-h-[380px] flex flex-col justify-center">
            <div id="verseEmpty" class="text-center p-20 bg-white rounded-[3rem] border-2 border-dashed border-slate-200">
                <div class="bg-indigo-50 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl shadow-indigo-100/30 text-indigo-400">
                    <i data-lucide="quote" class="w-12 h-12"></i>
                </div>
                <h3 class="font-black text-2xl text-slate-800 tracking-tight">Palavra Viva</h3>
                <p class="text-slate-400 text-sm mt-3 max-w-[240px] mx-auto italic font-medium leading-relaxed">Pesquise uma palavra ou toque no botão abaixo para começar.</p>
            </div>

            <div id="verseLoading" class="hidden bg-white p-12 rounded-[2.5rem] border border-slate-200 flex flex-col items-center justify-center space-y-5 animate-pulse">
                <div class="text-indigo-500 animate-spin"><i data-lucide="refresh-cw" class="w-12 h-12"></i></div>
                <p class="text-slate-400 font-bold text-[10px] uppercase tracking-[0.4em]">A Consultar...</p>
            </div>

            <div id="verseContent" class="hidden bg-white p-8 md:p-14 rounded-[3rem] shadow-2xl shadow-slate-200/40 border border-slate-100 space-y-8 relative overflow-hidden animate-fade-in">
                <div class="text-indigo-50 absolute -top-10 -left-10 opacity-30 rotate-12 -z-0"><i data-lucide="quote" style="width: 120px; height: 120px;"></i></div>
                
                <div class="space-y-8 relative z-10">
                    <!-- Navegação Interna -->
                    <div class="flex items-center justify-between">
                        <button id="prevVerseBtn" class="btn-nav flex items-center gap-2 text-indigo-600 hover:text-indigo-800 font-black text-[10px] uppercase py-2.5 px-5 bg-indigo-50/50 rounded-2xl border border-indigo-100 transition-all">
                            <i data-lucide="chevron-left" class="w-4 h-4"></i> Anterior
                        </button>
                        <div class="flex gap-1.5"><div class="w-2 h-2 bg-indigo-200 rounded-full animate-pulse"></div></div>
                        <button id="nextVerseBtn" class="btn-nav flex items-center gap-2 text-indigo-600 hover:text-indigo-800 font-black text-[10px] uppercase py-2.5 px-5 bg-indigo-50/50 rounded-2xl border border-indigo-100 transition-all">
                            Próximo <i data-lucide="chevron-right" class="w-4 h-4"></i>
                        </button>
                    </div>

                    <p id="verseText" class="text-2xl md:text-4xl font-serif text-slate-800 leading-relaxed italic font-medium tracking-tight"></p>
                    
                    <div class="pt-8 border-t border-slate-100 flex flex-col md:flex-row md:items-end justify-between gap-8">
                        <div class="space-y-5">
                            <h4 class="font-black text-3xl md:text-4xl text-slate-900 tracking-tighter flex items-baseline gap-3">
                                <span id="verseBook">...</span> 
                                <span id="verseRef" class="text-indigo-600 font-bold text-xl md:text-2xl">...</span>
                            </h4>
                            <div id="verseMeta" class="flex flex-wrap gap-2.5"></div>
                        </div>
                        <div class="flex gap-3">
                            <button id="favBtn" class="p-5 rounded-2xl shadow-md active:scale-90 transition-all"><i data-lucide="heart" class="w-7 h-7"></i></button>
                            <button id="copyBtn" class="p-5 bg-indigo-600 text-white rounded-2xl shadow-xl active:scale-90 transition-all hover:bg-indigo-700"><i data-lucide="copy" class="w-7 h-7"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="verseError" class="hidden bg-rose-50 p-10 rounded-[2.5rem] border border-rose-100 text-center space-y-5 animate-fade-in">
                <i data-lucide="alert-circle" class="w-12 h-12 text-rose-500 mx-auto"></i>
                <div>
                    <p class="text-rose-900 font-bold text-lg tracking-tight">Erro na API</p>
                    <p id="verseErrorMsg" class="text-rose-600 text-xs mt-2 font-medium"></p>
                </div>
                <button onclick="fetchRandomVerse()" class="text-[10px] font-black text-rose-600 uppercase tracking-widest underline underline-offset-4">Tentar Novamente</button>
            </div>
        </section>

        <!-- Sorteio Principal -->
        <button id="mainActionBtn" class="group relative w-full h-24 bg-indigo-600 hover:bg-indigo-700 text-white rounded-[2rem] font-black text-2xl shadow-2xl shadow-indigo-200 flex items-center justify-center gap-6 transition-all active:scale-95 overflow-hidden">
            <i data-lucide="refresh-cw" class="w-8 h-8 transition-transform duration-700 group-hover:rotate-180"></i>
            <span class="tracking-[0.2em] uppercase text-xs font-black relative z-10">Sortear Versículo Aleatório</span>
        </button>

        <!-- Favoritos -->
        <section id="favoritesSection" class="hidden pt-14 space-y-8">
            <div class="flex items-center justify-between border-b border-slate-200 pb-5">
                <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-[0.4em] flex items-center gap-2">
                    <i data-lucide="heart" class="w-4 h-4 text-rose-500 fill-current"></i> Favoritos (<span id="favCount">0</span>)
                </h3>
                <button onclick="clearAllFavorites()" class="text-[9px] font-black text-slate-300 hover:text-rose-500 uppercase tracking-widest transition-colors">Apagar Tudo</button>
            </div>
            <div id="favoritesList" class="grid gap-6"></div>
        </section>
    </main>

    <footer class="text-center py-20 opacity-30">
        <p class="text-[9px] font-black text-slate-400 uppercase tracking-[0.4em]">abibliadigital API • Versão Premium 6.0</p>
    </footer>

    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed bottom-12 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-10 py-5 rounded-3xl text-[10px] font-black uppercase tracking-[0.3em] shadow-2xl z-50 flex items-center gap-4 animate-fade-in border border-slate-700">
        <i data-lucide="check-circle-2" class="w-5 h-5 text-emerald-400"></i> <span id="toastMsg">...</span>
    </div>

    <script>
        // --- ESTADO GLOBAL ---
        let state = {
            appId: 'bible-v6-search-final',
            version: 'nvi',
            token: '',
            email: '',
            favorites: [],
            searchResults: [],
            currentPassage: null,
            authMode: 'none',
            isNavigating: false
        };

        const elements = {
            settingsPanel: document.getElementById('settingsPanel'),
            verseEmpty: document.getElementById('verseEmpty'),
            verseLoading: document.getElementById('verseLoading'),
            verseContent: document.getElementById('verseContent'),
            verseError: document.getElementById('verseError'),
            verseText: document.getElementById('verseText'),
            verseBook: document.getElementById('verseBook'),
            verseRef: document.getElementById('verseRef'),
            verseMeta: document.getElementById('verseMeta'),
            versionSelect: document.getElementById('versionSelect'),
            authNone: document.getElementById('authNone'),
            authForm: document.getElementById('authForm'),
            authSuccess: document.getElementById('authSuccess'),
            connectedEmail: document.getElementById('connectedEmail'),
            logoutBtn: document.getElementById('logoutBtn'),
            statusBadge: document.getElementById('statusBadge'),
            favoritesSection: document.getElementById('favoritesSection'),
            favoritesList: document.getElementById('favoritesList'),
            searchResultsSection: document.getElementById('searchResultsSection'),
            searchResultsList: document.getElementById('searchResultsList'),
            favCount: document.getElementById('favCount'),
            favBtn: document.getElementById('favBtn'),
            mainActionBtn: document.getElementById('mainActionBtn'),
            prevVerseBtn: document.getElementById('prevVerseBtn'),
            nextVerseBtn: document.getElementById('nextVerseBtn'),
            searchInput: document.getElementById('searchInput'),
            authEmail: document.getElementById('authEmail'),
            authPass: document.getElementById('authPass'),
            authName: document.getElementById('authName'),
            authTitle: document.getElementById('authTitle'),
            authSubmit: document.getElementById('authSubmit'),
            authError: document.getElementById('authError')
        };

        function init() {
            lucide.createIcons();
            state.version = localStorage.getItem(`${state.appId}_version`) || 'nvi';
            state.token = localStorage.getItem(`${state.appId}_token`) || '';
            state.email = localStorage.getItem(`${state.appId}_email`) || '';
            state.favorites = JSON.parse(localStorage.getItem(`${state.appId}_favs`) || '[]');

            elements.versionSelect.value = state.version;
            updateAuthUI();
            updateFavoritesUI();

            // Listeners
            document.getElementById('toggleSettings').onclick = () => elements.settingsPanel.classList.toggle('hidden');
            document.getElementById('closeSettings').onclick = () => elements.settingsPanel.classList.add('hidden');
            elements.versionSelect.onchange = (e) => {
                state.version = e.target.value;
                localStorage.setItem(`${state.appId}_version`, state.version);
            };
            document.getElementById('togglePass').onclick = () => {
                elements.authPass.type = elements.authPass.type === 'password' ? 'text' : 'password';
            };
            elements.authForm.onsubmit = handleAuth;
            elements.logoutBtn.onclick = logout;
            elements.mainActionBtn.onclick = fetchRandomVerse;
            document.getElementById('copyBtn').onclick = copyCurrentVerse;
            elements.favBtn.onclick = toggleFavorite;
            elements.prevVerseBtn.onclick = () => navigateVerse('prev');
            elements.nextVerseBtn.onclick = () => navigateVerse('next');
        }

        // --- HELPER PARA ABREVIATURA (CRITICAL PARA NAVEGAÇÃO) ---
        function getBookAbbrev(p) {
            if (!p || !p.book) return "";
            if (typeof p.book.abbrev === 'object' && p.book.abbrev !== null) {
                return p.book.abbrev.pt || p.book.abbrev.en || "";
            }
            if (typeof p.book.abbrev === 'string') return p.book.abbrev;
            return "";
        }

        // --- AUTH ---
        function setAuthMode(mode) {
            state.authMode = mode;
            elements.authError.classList.add('hidden');
            if (mode === 'none') {
                elements.authNone.classList.remove('hidden');
                elements.authForm.classList.add('hidden');
            } else {
                elements.authNone.classList.add('hidden');
                elements.authForm.classList.remove('hidden');
                elements.authTitle.innerText = mode === 'register' ? 'Registar' : 'Obter Token (PUT)';
                elements.authName.classList.toggle('hidden', mode === 'login');
            }
        }

        async function handleAuth(e) {
            e.preventDefault();
            elements.authSubmit.disabled = true;
            const isReg = state.authMode === 'register';
            const body = isReg ? {
                name: elements.authName.value,
                email: elements.authEmail.value,
                password: elements.authPass.value,
                notifications: true
            } : { email: elements.authEmail.value, password: elements.authPass.value };

            try {
                const res = await fetch(`https://www.abibliadigital.com.br/api/users${isReg ? '' : '/token'}`, {
                    method: isReg ? 'POST' : 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'Erro na operação.');

                if (data.token) {
                    state.token = data.token;
                    state.email = elements.authEmail.value;
                    localStorage.setItem(`${state.appId}_token`, state.token);
                    localStorage.setItem(`${state.appId}_email`, state.email);
                    updateAuthUI();
                    showToast('Token Ativado!');
                    setAuthMode('none');
                } else if (isReg) {
                    showToast('Conta Criada!');
                    setAuthMode('login');
                }
            } catch (err) {
                document.getElementById('authErrorText').innerText = err.message;
                elements.authError.classList.remove('hidden');
            } finally { elements.authSubmit.disabled = false; }
        }

        function updateAuthUI() {
            const hasToken = !!state.token;
            elements.authNone.classList.toggle('hidden', hasToken);
            elements.authSuccess.classList.toggle('hidden', !hasToken);
            elements.logoutBtn.classList.toggle('hidden', !hasToken);
            elements.statusBadge.classList.toggle('hidden', !hasToken);
            elements.connectedEmail.innerText = state.email || 'Online';
        }

        function logout() {
            state.token = ''; state.email = '';
            localStorage.removeItem(`${state.appId}_token`);
            localStorage.removeItem(`${state.appId}_email`);
            updateAuthUI(); showToast('Desconectado');
        }

        // --- PESQUISA ---
        async function handleSearch() {
            const query = elements.searchInput.value.trim();
            if (!query) return;

            elements.verseEmpty.classList.add('hidden');
            elements.verseLoading.classList.remove('hidden');
            elements.searchResultsSection.classList.add('hidden');

            try {
                const headers = { 
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                };
                if (state.token) headers['Authorization'] = `Bearer ${state.token}`;

                const res = await fetch(`https://www.abibliadigital.com.br/api/verses/search`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ version: state.version, search: query })
                });

                if (!res.ok) throw new Error('Limite atingido ou erro na API.');
                
                const data = await res.json();
                // A API devolve { verses: [...] }
                state.searchResults = data.verses || [];
                
                if (state.searchResults.length === 0) {
                    showToast('Nenhum resultado encontrado.');
                    showView('empty');
                } else {
                    renderSearchResults();
                    elements.searchResultsSection.classList.remove('hidden');
                    showView('empty'); // Mostra vazio no card principal até clicar
                }
            } catch (err) {
                showToast(err.message);
                showView('empty');
            } finally {
                elements.verseLoading.classList.add('hidden');
            }
        }

        function renderSearchResults() {
            elements.searchResultsList.innerHTML = state.searchResults.map((v, i) => `
                <div class="result-card bg-white p-5 rounded-3xl border border-indigo-50 shadow-sm hover:shadow-md hover:border-indigo-200 transition-all cursor-pointer group" onclick="loadSearchResult(${i})">
                    <p class="text-sm text-slate-600 font-serif italic leading-relaxed mb-3 group-hover:text-slate-900">"${v.text}"</p>
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] font-black text-indigo-600 uppercase tracking-tighter">
                            ${v.book.name} ${v.chapter}:${v.number}
                        </span>
                        <i data-lucide="external-link" class="w-3 h-3 text-slate-300"></i>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        window.loadSearchResult = (idx) => {
            const res = state.searchResults[idx];
            // Converter estrutura do search para estrutura de passage
            state.currentPassage = {
                text: res.text,
                chapter: res.chapter,
                number: res.number,
                book: res.book
            };
            renderVerse();
            showView('content');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        function clearSearch() {
            state.searchResults = [];
            elements.searchInput.value = '';
            elements.searchResultsSection.classList.add('hidden');
        }

        // --- API & NAVEGAÇÃO ---
        async function fetchRandomVerse() {
            if (state.isNavigating) return;
            showView('loading');
            try {
                const headers = { 'Accept': 'application/json' };
                if (state.token) headers['Authorization'] = `Bearer ${state.token}`;
                const res = await fetch(`https://www.abibliadigital.com.br/api/verses/${state.version}/random`, { headers });
                state.currentPassage = await res.json();
                renderVerse();
                showView('content');
            } catch (err) {
                document.getElementById('verseErrorMsg').innerText = 'Falha na ligação.';
                showView('error');
            }
        }

        async function navigateVerse(dir) {
            if (!state.currentPassage || state.isNavigating) return;
            const abbrev = getBookAbbrev(state.currentPassage);
            if (!abbrev) { showToast('Sigla não identificada'); return; }

            const nextNum = state.currentPassage.number + (dir === 'next' ? 1 : -1);
            if (nextNum < 1) { showToast('Início do capítulo'); return; }

            state.isNavigating = true;
            elements.verseText.style.opacity = "0.3";

            try {
                const headers = { 'Accept': 'application/json' };
                if (state.token) headers['Authorization'] = `Bearer ${state.token}`;
                const url = `https://www.abibliadigital.com.br/api/verses/${state.version}/${abbrev}/${state.currentPassage.chapter}/${nextNum}`;
                const res = await fetch(url, { headers });

                if (!res.ok) {
                    showToast(dir === 'next' ? 'Fim do capítulo' : 'Início do capítulo');
                } else {
                    state.currentPassage = await res.json();
                    renderVerse();
                }
            } catch (err) { showToast('Erro de navegação'); }
            finally {
                elements.verseText.style.opacity = "1";
                state.isNavigating = false;
            }
        }

        function renderVerse() {
            if (!state.currentPassage) return;
            const p = state.currentPassage;
            elements.verseText.innerText = p.text;
            elements.verseBook.innerText = p.book.name;
            elements.verseRef.innerText = `${p.chapter}:${p.number}`;
            
            elements.verseMeta.innerHTML = `
                <span class="text-[9px] font-black bg-indigo-50 text-indigo-700 px-4 py-2 rounded-full uppercase tracking-widest border border-indigo-100">${p.book.author || 'Sagrado'}</span>
                <span class="text-[9px] font-black bg-slate-50 text-slate-500 px-4 py-2 rounded-full uppercase tracking-widest border border-slate-200">${p.book.group || 'Bíblia'}</span>
            `;
            const isFav = state.favorites.some(f => f.text === p.text);
            elements.favBtn.className = `p-5 rounded-2xl transition-all shadow-md active:scale-90 ${isFav ? 'bg-rose-500 text-white shadow-rose-200 border-rose-600' : 'bg-slate-50 text-slate-300 border-transparent hover:bg-white'}`;
            lucide.createIcons();
        }

        function showView(view) {
            elements.verseEmpty.classList.toggle('hidden', view !== 'empty');
            elements.verseLoading.classList.toggle('hidden', view !== 'loading');
            elements.verseContent.classList.toggle('hidden', view !== 'content');
            elements.verseError.classList.toggle('hidden', view !== 'error');
        }

        // --- FAVORITOS ---
        function toggleFavorite() {
            if (!state.currentPassage) return;
            const p = state.currentPassage;
            const idx = state.favorites.findIndex(f => f.text === p.text);
            if (idx > -1) { state.favorites.splice(idx, 1); } 
            else { state.favorites.push({ ...p, ver: state.version }); }
            localStorage.setItem(`${state.appId}_favs`, JSON.stringify(state.favorites));
            renderVerse(); updateFavoritesUI();
        }

        function updateFavoritesUI() {
            elements.favCount.innerText = state.favorites.length;
            elements.favoritesSection.classList.toggle('hidden', state.favorites.length === 0);
            elements.favoritesList.innerHTML = state.favorites.slice().reverse().map((f, i) => {
                const actualIdx = state.favorites.length - 1 - i;
                const txt = f.text.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                return `
                <div class="favorite-card bg-white p-7 rounded-[2rem] border border-slate-100 flex flex-col gap-4 shadow-sm hover:shadow-xl transition-all cursor-pointer group" onclick="loadFavorite(${actualIdx})">
                    <div class="flex-1">
                        <p class="text-base text-slate-600 font-serif italic leading-relaxed mb-3 group-hover:text-indigo-900 transition-colors">"${f.text}"</p>
                        <div class="flex justify-between items-center">
                           <span class="text-[11px] font-black text-indigo-600 uppercase tracking-tighter">${f.book.name} ${f.chapter}:${f.number} <span class="ml-1 opacity-40 font-bold">(${(f.ver || 'NVI').toUpperCase()})</span></span>
                           <button onclick="event.stopPropagation(); removeFavoriteByIndex(${actualIdx})" class="text-rose-100 hover:text-rose-500 p-2 transition-colors">
                              <i data-lucide="heart" class="w-6 h-6 fill-current"></i>
                           </button>
                        </div>
                    </div>
                </div>`}).join('');
            lucide.createIcons();
        }

        window.loadFavorite = (idx) => {
            state.currentPassage = state.favorites[idx];
            renderVerse();
            showView('content');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.removeFavoriteByIndex = (idx) => {
            state.favorites.splice(idx, 1);
            localStorage.setItem(`${state.appId}_favs`, JSON.stringify(state.favorites));
            updateFavoritesUI(); renderVerse();
        };

        window.clearAllFavorites = () => {
            if (confirm('Eliminar favoritos?')) { state.favorites = []; localStorage.removeItem(`${state.appId}_favs`); updateFavoritesUI(); renderVerse(); }
        };

        function copyCurrentVerse() {
            if (!state.currentPassage) return;
            const p = state.currentPassage;
            const txt = `"${p.text}" — ${p.book.name} ${p.chapter}:${p.number} (${state.version.toUpperCase()})`;
            const el = document.createElement('textarea');
            el.value = txt; document.body.appendChild(el);
            el.select(); document.execCommand('copy'); document.body.removeChild(el);
            showToast('Texto Copiado');
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            toast.classList.remove('hidden'); setTimeout(() => toast.classList.add('hidden'), 2500);
        }

        window.onload = init;
    </script>
</body>
</html>

