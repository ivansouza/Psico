<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Nó de Toro 3D - Edição Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body { 
            margin: 0; 
            overflow: hidden; 
            background-color: #020617; 
            font-family: 'Inter', sans-serif; 
            color: white;
        }
        canvas { display: block; }
        
        .glass-panel {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .panel-hidden { transform: translateX(100%); }
        
        /* Sliders Customizados */
        input[type=range] {
            width: 100%; height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px; appearance: none; outline: none;
        }
        input[type=range]::-webkit-slider-thumb {
            appearance: none; width: 18px; height: 18px;
            background: #38bdf8; border-radius: 50%;
            cursor: pointer; box-shadow: 0 0 12px rgba(56, 189, 248, 0.4);
        }

        /* ESTADOS DOS SLOTS - CORES DOS NÚMEROS */
        .slot-btn { 
            @apply border rounded-lg py-3 text-xs font-bold transition-all duration-300 transform active:scale-90 flex items-center justify-center; 
        }
        
        /* 1. Vazio: Número Cinza */
        .slot-empty { 
            @apply border-white/5 bg-transparent text-white/20; 
        }
        
        /* 2. Preenchido: Número Esmeralda */
        .slot-filled { 
            @apply border-emerald-500/20 bg-emerald-500/5 text-emerald-400 shadow-[inset_0_0_10px_rgba(16,185,129,0.05)]; 
        }
        
        /* 3. Selecionado: Número Azul Sky */
        .slot-selected { 
            @apply border-sky-400 bg-sky-500/10 text-sky-400 ring-1 ring-sky-400 shadow-[0_0_15px_rgba(56,189,248,0.2)]; 
        }

        /* Notificação */
        #toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #0ea5e9; color: white; padding: 12px 28px;
            border-radius: 99px; font-weight: 600; font-size: 13px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.4);
            opacity: 0; pointer-events: none; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 100;
        }

        .gear-rotate { transform: rotate(90deg); }
    </style>
</head>
<body>

    <div id="toast">Ação Concluída</div>

    <!-- Botão de Engrenagem -->
    <button id="gear-btn" class="fixed top-6 right-6 z-50 p-4 bg-sky-600 hover:bg-sky-500 rounded-full shadow-2xl transition-all active:scale-90 group border border-white/10">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="gear-icon" class="transition-transform duration-500">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
        </svg>
    </button>

    <!-- Painel Lateral -->
    <div id="side-panel" class="glass-panel fixed top-0 right-0 h-full w-80 p-8 z-40 panel-hidden flex flex-col gap-6 overflow-y-auto border-l border-white/5">
        <h2 class="text-2xl font-bold text-sky-400 mt-4 flex items-center gap-2 underline decoration-sky-500/20 underline-offset-8">
            Geometria
        </h2>

        <!-- Controlos de Parâmetros -->
        <div class="space-y-5 pt-4">
            <div>
                <div class="flex justify-between text-[10px] mb-2 uppercase tracking-widest text-white/40 font-bold"><span>Voltas (p)</span><span id="p-val" class="text-sky-400">2</span></div>
                <input type="range" id="p-input" min="1" max="30" step="1" value="2">
            </div>
            <div>
                <div class="flex justify-between text-[10px] mb-2 uppercase tracking-widest text-white/40 font-bold"><span>Espirais (q)</span><span id="q-val" class="text-sky-400">3</span></div>
                <input type="range" id="q-input" min="1" max="30" step="1" value="3">
            </div>
            <div>
                <div class="flex justify-between text-[10px] mb-2 uppercase tracking-widest text-white/40 font-bold"><span>Raio Maior (R)</span><span id="R-val" class="text-sky-400">10</span></div>
                <input type="range" id="R-input" min="2" max="25" step="0.5" value="10">
            </div>
            <div>
                <div class="flex justify-between text-[10px] mb-2 uppercase tracking-widest text-white/40 font-bold"><span>Espessura (r)</span><span id="r-val" class="text-sky-400">3</span></div>
                <input type="range" id="r-input" min="0.1" max="10" step="0.1" value="3">
            </div>
            <div>
                <div class="flex justify-between text-[10px] mb-2 uppercase tracking-widest text-white/40 font-bold"><span>Resolução</span><span id="res-val" class="text-sky-400">300</span></div>
                <input type="range" id="res-input" min="100" max="1000" step="10" value="300">
            </div>
        </div>

        <div class="h-[1px] bg-white/10 w-full my-1"></div>

        <!-- Opções de Visualização -->
        <div class="bg-white/5 p-4 rounded-2xl border border-white/5 flex items-center justify-between">
            <span class="text-xs font-bold uppercase tracking-wider text-white/70">Modo Wireframe</span>
            <button id="wireframe-toggle" class="w-12 h-6 rounded-full bg-white/10 relative transition-all border border-white/10">
                <div id="wireframe-dot" class="absolute top-1 left-1 w-4 h-4 rounded-full bg-white transition-transform"></div>
            </button>
        </div>

        <!-- Secção de Memória -->
        <div class="flex-grow flex flex-col">
            <h3 class="text-[10px] uppercase text-white/30 mb-4 tracking-[0.2em] font-bold">Memória Local</h3>
            <div id="slots-grid" class="grid grid-cols-5 gap-2 mb-4">
                <!-- Injetado via JavaScript -->
            </div>
            <div class="flex gap-2">
                <button id="save-btn" class="flex-1 bg-sky-600 hover:bg-sky-500 py-3 rounded-xl font-bold text-xs uppercase tracking-widest transition-all shadow-lg shadow-sky-900/20 active:scale-95">Gravar</button>
                <button id="clear-btn" class="px-4 bg-red-900/20 hover:bg-red-900/40 text-red-400 rounded-xl text-[10px] font-bold border border-red-500/10 transition-colors">Limpar</button>
            </div>
        </div>

        <div class="pt-4 text-[9px] text-white/10 uppercase tracking-[3px] text-center leading-relaxed">
            Orbit: Arrastar • Zoom: Scroll<br>Dados persistentes no browser
        </div>
    </div>

    <div id="canvas-container"></div>

    <script>
        // --- Estado Global ---
        let scene, camera, renderer, knot, controls, geometry, material;
        let config = { p: 2, q: 3, R: 10, r: 3, res: 300, wireframe: false };
        let currentSlot = 0;
        let updateTimeout;
        const STORAGE_KEY = 'torus_knot_mem_final_v1';

        // --- Elementos UI ---
        const sidePanel = document.getElementById('side-panel');
        const gearBtn = document.getElementById('gear-btn');
        const gearIcon = document.getElementById('gear-icon');
        const wireToggle = document.getElementById('wireframe-toggle');
        const wireDot = document.getElementById('wireframe-dot');

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(20, 25, 30);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // OrbitControls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            // Iluminação
            scene.add(new THREE.AmbientLight(0xffffff, 0.4));
            
            const light1 = new THREE.DirectionalLight(0xffffff, 0.8);
            light1.position.set(5, 10, 7.5);
            scene.add(light1);
            
            const light2 = new THREE.PointLight(0x38bdf8, 2);
            light2.position.set(-15, -10, 20);
            scene.add(light2);

            material = new THREE.MeshPhysicalMaterial({
                color: 0x3b82f6,
                metalness: 0.9,
                roughness: 0.1,
                clearcoat: 1.0,
                clearcoatRoughness: 0.1,
                wireframe: config.wireframe
            });

            createKnot();
            renderSlots();
            animate();
        }

        function createKnot() {
            if (knot) {
                scene.remove(knot);
                if (geometry) geometry.dispose();
            }

            // Resolução radial elevada (64) para suavidade máxima
            geometry = new THREE.TorusKnotGeometry(config.R, config.r, config.res, 64, config.p, config.q);
            knot = new THREE.Mesh(geometry, material);
            scene.add(knot);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        // --- Interface do Utilizador ---

        gearBtn.onclick = () => {
            sidePanel.classList.toggle('panel-hidden');
            gearIcon.classList.toggle('gear-rotate');
        };

        wireToggle.onclick = () => {
            config.wireframe = !config.wireframe;
            material.wireframe = config.wireframe;
            wireDot.style.transform = config.wireframe ? 'translateX(1.5rem)' : 'translateX(0)';
            wireToggle.classList.toggle('bg-sky-500', config.wireframe);
            notify(config.wireframe ? "Wireframe Ativado" : "Sólido Ativado");
        };

        // Sliders com Debounce
        ['p', 'q', 'R', 'r', 'res'].forEach(key => {
            const el = document.getElementById(`${key}-input`);
            const label = document.getElementById(`${key}-val`);
            
            el.oninput = (e) => {
                const val = parseFloat(e.target.value);
                config[key] = val;
                label.innerText = val;
                
                clearTimeout(updateTimeout);
                updateTimeout = setTimeout(createKnot, 10);
            };
        });

        // --- Sistema de Memória Local ---

        function getMem() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : new Array(10).fill(null);
        }

        function saveState() {
            const mem = getMem();
            mem[currentSlot] = {
                config: { ...config },
                camera: { 
                    pos: camera.position.toArray(), 
                    target: controls.target.toArray() 
                }
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(mem));
            renderSlots();
            notify(`Configuração Salva no Slot ${currentSlot + 1}`);
        }

        function loadState(index) {
            const mem = getMem();
            const data = mem[index];
            if (!data) return;

            config = { ...data.config };
            
            // Sincronizar Interface
            ['p', 'q', 'R', 'r', 'res'].forEach(key => {
                document.getElementById(`${key}-input`).value = config[key];
                document.getElementById(`${key}-val`).innerText = config[key];
            });

            material.wireframe = config.wireframe;
            wireDot.style.transform = config.wireframe ? 'translateX(1.5rem)' : 'translateX(0)';
            wireToggle.classList.toggle('bg-sky-500', config.wireframe);

            createKnot();
            camera.position.fromArray(data.camera.pos);
            controls.target.fromArray(data.camera.target);
            
            notify(`Slot ${index + 1} Carregado`);
        }

        function renderSlots() {
            const mem = getMem();
            const grid = document.getElementById('slots-grid');
            grid.innerHTML = '';
            
            mem.forEach((item, i) => {
                const btn = document.createElement('button');
                
                // Aplicar cores conforme o estado: Vazio, Preenchido ou Selecionado
                let statusClass = "slot-empty";
                if (item) statusClass = "slot-filled";
                if (i === currentSlot) statusClass = "slot-selected";
                
                btn.className = `slot-btn ${statusClass}`;
                btn.innerText = i + 1;
                
                btn.onclick = () => {
                    currentSlot = i;
                    renderSlots();
                    if(item) loadState(i);
                };
                grid.appendChild(btn);
            });
        }

        function notify(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.opacity = '1';
            t.style.transform = 'translateX(-50%) translateY(-10px)';
            setTimeout(() => {
                t.style.opacity = '0';
                t.style.transform = 'translateX(-50%) translateY(0)';
            }, 2000);
        }

        document.getElementById('save-btn').onclick = saveState;
        
        document.getElementById('clear-btn').onclick = () => {
            if(confirm("Deseja apagar todos os presets guardados?")) {
                localStorage.removeItem(STORAGE_KEY);
                renderSlots();
                notify("Memória Limpa");
            }
        };

        window.onresize = () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };

        window.onload = init;
    </script>
</body>
</html>

