<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T√©cnica de Subtra√ß√£o: Personalizada com Logs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .math-font {
            font-family: 'Courier New', Courier, monospace;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade {
            animation: fadeIn 0.4s ease-out forwards;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800 p-4 md:p-8 font-sans">

    <div class="max-w-4xl mx-auto">
        <!-- Cabe√ßalho -->
        <header class="text-center mb-10">
            <h1 class="text-4xl font-bold text-slate-900 mb-4">T√©cnica de Subtra√ß√£o F√°cil</h1>
            <p class="text-lg text-slate-600">Explore a propriedade da invari√¢ncia da diferen√ßa utilizando as suas pr√≥prias bases e n√∫meros.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Coluna de Entrada e Configura√ß√µes -->
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Subtrair de (Base):</label>
                            <input type="number" id="potencia" value="10000" class="w-full p-3 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="Ex: 10000">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">N√∫mero a subtrair:</label>
                            <input type="number" id="subtraendo" value="4362" class="w-full p-3 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="Ex: 4362">
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        <button onclick="calcular()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-colors shadow-lg shadow-blue-200">
                            Calcular
                        </button>
                        <button onclick="salvarExemplo()" class="bg-emerald-100 hover:bg-emerald-200 text-emerald-700 font-bold px-6 py-3 rounded-xl transition-colors">
                            Guardar Exemplo
                        </button>
                    </div>
                </div>

                <!-- Resultados Visuais -->
                <div id="resultado-container" class="hidden space-y-8 animate-fade">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-red-50 p-6 rounded-2xl border border-red-100">
                            <h3 class="text-red-700 font-bold mb-4 flex items-center italic">‚ùå Tradicional (Com "Empr√©stimos")</h3>
                            <div id="subtracao-original" class="math-font text-2xl text-center whitespace-pre leading-relaxed text-red-900"></div>
                        </div>

                        <div class="bg-green-50 p-6 rounded-2xl border border-green-100">
                            <h3 class="text-green-700 font-bold mb-4 flex items-center italic">‚úÖ F√°cil (Regra do -1)</h3>
                            <div id="subtracao-facil" class="math-font text-2xl text-center whitespace-pre leading-relaxed text-green-900"></div>
                        </div>
                    </div>

                    <!-- Gr√°fico da Reta Num√©rica -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-slate-800 mb-4 text-center">A L√≥gica da Dist√¢ncia Constante</h3>
                        <div class="overflow-x-auto py-8">
                            <svg id="linha" width="700" height="220" viewBox="0 0 700 220" class="mx-auto"></svg>
                        </div>
                        <p id="texto-explicativo" class="mt-4 text-slate-600 text-center italic"></p>
                    </div>
                </div>
            </div>

            <!-- Coluna de Hist√≥rico / Caderno de Notas -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 sticky top-8">
                    <h3 class="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2">
                        <span>üìì</span> Os Meus Exemplos
                    </h3>
                    <div id="lista-exemplos" class="space-y-3 max-h-[400px] overflow-y-auto pr-2">
                        <p class="text-slate-400 text-sm text-center py-8">Nenhum exemplo guardado.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- √Årea de Administra√ß√£o (Visualiza√ß√£o de Logs) -->
        <div class="mt-16 pt-8 border-t border-slate-200">
            <div class="flex justify-center">
                <button onclick="toggleAdmin()" class="text-slate-400 hover:text-slate-600 text-xs flex items-center gap-1 transition-colors">
                    <span>üõ°Ô∏è</span> √Årea de Administra√ß√£o (Logs de Sistema)
                </button>
            </div>
            
            <div id="admin-panel" class="hidden mt-8 bg-slate-900 text-slate-300 p-6 rounded-2xl shadow-2xl animate-fade overflow-hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-white">Registos de Utiliza√ß√£o (Firestore)</h2>
                    <div id="app-id-display" class="text-[10px] bg-slate-800 px-2 py-1 rounded"></div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="text-slate-500 border-b border-slate-800">
                            <tr>
                                <th class="pb-3 pr-4">Data/Hora</th>
                                <th class="pb-3 pr-4">IP</th>
                                <th class="pb-3">Localiza√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="logs-table-body">
                            <tr>
                                <td colspan="3" class="py-10 text-center text-slate-600 italic">A carregar registos do Firestore...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        document.getElementById('app-id-display').textContent = `APP_ID: ${appId}`;

        async function initLogging() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // Log de uso inicial
                        const geoResponse = await fetch('https://ipapi.co/json/');
                        const geoData = await geoResponse.json();

                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'usage_logs'), {
                            ip: geoData.ip || 'desconhecido',
                            localizacao: `${geoData.city}, ${geoData.region}, ${geoData.country_name}` || 'desconhecido',
                            horario: new Date().toLocaleString('pt-PT'),
                            timestamp: new Date().getTime(),
                            userId: user.uid
                        });

                        // Listener para exibir os logs na tabela em tempo real (Regra 2: sem filtros complexos)
                        const q = collection(db, 'artifacts', appId, 'public', 'data', 'usage_logs');
                        onSnapshot(q, (snapshot) => {
                            const tbody = document.getElementById('logs-table-body');
                            const docs = [];
                            snapshot.forEach(doc => docs.push(doc.data()));
                            
                            // Ordenar em mem√≥ria para respeitar a Regra 2
                            docs.sort((a, b) => b.timestamp - a.timestamp);

                            tbody.innerHTML = docs.map(log => `
                                <tr class="border-b border-slate-800">
                                    <td class="py-3 pr-4 text-emerald-400 font-mono text-xs">${log.horario}</td>
                                    <td class="py-3 pr-4 font-mono text-xs">${log.ip}</td>
                                    <td class="py-3 text-xs">${log.localizacao}</td>
                                </tr>
                            `).join('');
                            
                            if (docs.length === 0) {
                                tbody.innerHTML = `<tr><td colspan="3" class="py-10 text-center text-slate-600">Sem registos encontrados.</td></tr>`;
                            }
                        }, (error) => {
                            console.error("Erro ao ler logs:", error);
                        });
                    }
                });
            } catch (err) {
                console.error("Erro no logging:", err);
            }
        }

        initLogging();
    </script>

    <script>
        let exemplosSalvos = [];

        function toggleAdmin() {
            const panel = document.getElementById('admin-panel');
            panel.classList.toggle('hidden');
            if (!panel.classList.contains('hidden')) {
                panel.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function formatarNumero(n) {
            return n.toString();
        }

        function validarEntrada(potencia, subtraendo) {
            if (isNaN(potencia) || potencia <= 0) {
                mostrarMensagem("Por favor, introduza uma base positiva.");
                return false;
            }
            if (isNaN(subtraendo) || subtraendo <= 0) {
                mostrarMensagem("Por favor, introduza um n√∫mero a subtrair positivo.");
                return false;
            }
            if (subtraendo >= potencia) {
                mostrarMensagem(`O n√∫mero a subtrair (${subtraendo}) deve ser INFERIOR √† base (${potencia}).`);
                return false;
            }
            return true;
        }

        function calcular() {
            const potencia = parseInt(document.getElementById("potencia").value);
            const subtraendo = parseInt(document.getElementById("subtraendo").value);

            if (!validarEntrada(potencia, subtraendo)) {
                document.getElementById("resultado-container").classList.add("hidden");
                return;
            }

            const m1 = potencia - 1;
            const s1 = subtraendo - 1;
            const res = potencia - subtraendo;

            const pStr = formatarNumero(potencia);
            const sStr = formatarNumero(subtraendo);
            const m1Str = formatarNumero(m1);
            const s1Str = formatarNumero(s1);
            const resStr = formatarNumero(res);

            document.getElementById("resultado-container").classList.remove("hidden");

            const largura = Math.max(pStr.length, sStr.length, resStr.length) + 2;
            
            const formatView = (a, b, resShow = "") => {
                return a.padStart(largura) + "\n- " + b.padStart(largura - 2) + "\n" + "‚Äî".repeat(largura) + (resShow ? "\n" + resShow.padStart(largura) : "");
            };

            document.getElementById("subtracao-original").textContent = formatView(pStr, sStr, "?");
            document.getElementById("subtracao-facil").textContent = formatView(m1Str, s1Str, resStr);

            document.getElementById("texto-explicativo").innerHTML = 
                `Ao retirar 1 de cada valor, a <strong>dist√¢ncia</strong> mant√©m-se igual, e como eliminamos os zeros, o c√°lculo n√£o exige empr√©stimos!`;

            desenharLinha(s1, subtraendo, m1, potencia, res);
        }

        function salvarExemplo() {
            const potencia = parseInt(document.getElementById("potencia").value);
            const subtraendo = parseInt(document.getElementById("subtraendo").value);
            
            if (!validarEntrada(potencia, subtraendo)) return;

            const novoExemplo = { 
                id: Date.now(),
                pot: potencia, 
                sub: subtraendo,
                res: potencia - subtraendo
            };

            if (exemplosSalvos.length > 0 && 
                exemplosSalvos[0].pot == novoExemplo.pot && 
                exemplosSalvos[0].sub == novoExemplo.sub) {
                return;
            }

            exemplosSalvos.unshift(novoExemplo);
            renderizarLista();
            calcular();
        }

        function renderizarLista() {
            const lista = document.getElementById("lista-exemplos");
            if (exemplosSalvos.length === 0) {
                lista.innerHTML = `<p class="text-slate-400 text-sm text-center py-8">Nenhum exemplo guardado.</p>`;
                return;
            }

            lista.innerHTML = exemplosSalvos.map((ex, index) => `
                <div class="p-4 bg-slate-50 border border-slate-200 rounded-xl flex justify-between items-center group animate-fade">
                    <div>
                        <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Exemplo #${exemplosSalvos.length - index}</div>
                        <div class="font-mono text-slate-700">${ex.pot} - ${ex.sub} = <span class="text-blue-600 font-bold">${ex.res}</span></div>
                    </div>
                    <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="carregarExemplo(${ex.pot}, ${ex.sub})" class="p-2 hover:bg-blue-100 text-blue-600 rounded-lg">
                            üëÅÔ∏è
                        </button>
                        <button onclick="excluirExemplo(${ex.id})" class="p-2 hover:bg-red-100 text-red-600 rounded-lg">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function carregarExemplo(pot, sub) {
            document.getElementById("potencia").value = pot;
            document.getElementById("subtraendo").value = sub;
            calcular();
        }

        function excluirExemplo(id) {
            exemplosSalvos = exemplosSalvos.filter(ex => ex.id !== id);
            renderizarLista();
        }

        function desenharLinha(s1, s0, m1, m0, dist) {
            const svg = document.getElementById("linha");
            svg.innerHTML = "";
            const pad = 60;
            const w = 700 - 2 * pad;
            const y = 110; 
            const getX = (val) => pad + (val / m0) * w;
            const posS1 = getX(s1), posS0 = getX(s0), posM1 = getX(m1), posM0 = getX(m0);
            svg.innerHTML += `<line x1="${pad}" y1="${y}" x2="${pad+w}" y2="${y}" stroke="#cbd5e1" stroke-width="2"/>`;
            const point = (x, label, color, off, isTop) => `
                <circle cx="${x}" cy="${y}" r="5" fill="${color}"/>
                <text x="${x}" y="${isTop ? y - off : y + off}" text-anchor="middle" font-size="11" fill="${color}" font-weight="bold">${label}</text>
            `;
            svg.innerHTML += point(posS1, s1, "#16a34a", 15, true);
            svg.innerHTML += point(posM1, m1, "#16a34a", 15, true);
            svg.innerHTML += point(posS0, s0, "#2563eb", 25, false);
            svg.innerHTML += point(posM0, m0, "#2563eb", 25, false);
            const arc = (x1, x2, color, label, height) => `
                <path d="M ${x1} ${y-10} Q ${(x1+x2)/2} ${y-height} ${x2} ${y-10}" stroke="${color}" fill="none" stroke-width="2" stroke-dasharray="4" marker-end="url(#arrow)"/>
                <text x="${(x1+x2)/2}" y="${y-height-5}" text-anchor="middle" font-size="12" fill="${color}" font-weight="bold">${label}</text>
            `;
            svg.innerHTML += `<defs><marker id="arrow" markerWidth="10" markerHeight="10" refX="0" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="context-stroke"/></marker></defs>`;
            svg.innerHTML += arc(posS1, posM1, "#16a34a", "Resultado: " + dist, 80);
            svg.innerHTML += arc(posS0, posM0, "#2563eb", "Mesma Dist√¢ncia", 45);
        }

        function mostrarMensagem(msg) {
            alert(msg);
        }

        window.onload = calcular;
    </script>
</body>
</html>

