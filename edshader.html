<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Editor GLSL Mobile - Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-glsl.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body, html {
            margin: 0; padding: 0; height: 100%; overflow: hidden;
            background: #1a1a1a;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        }

        .app-container {
            display: grid; grid-template-rows: 40% 60%; height: 100vh;
            background: #1a1a1a; transition: all 0.3s ease;
        }

        @media (min-width: 768px) {
            .app-container { grid-template-rows: 1fr; grid-template-columns: 1fr 1fr; }
        }

        /* Estilos de Tela Cheia Limpa */
        body.is-fullscreen #editor-container,
        body.is-fullscreen .ui-overlay,
        body.is-fullscreen .status-badge { 
            display: none !important; 
        }
        
        body.is-fullscreen .app-container { 
            grid-template-rows: 100% 0%; 
            grid-template-columns: 100% 0%; 
        }

        #canvas-container {
            position: relative; background: #000;
            display: flex; align-items: center; justify-content: center; overflow: hidden;
            cursor: pointer;
        }
        canvas { width: 100%; height: 100%; object-fit: contain; touch-action: none; }

        #editor-container {
            position: relative; background: #2d2d2d;
            border-top: 1px solid #444;
            display: flex; flex-direction: column; overflow: hidden;
        }

        #code-area { position: relative; flex-grow: 1; overflow: hidden; }

        #editing, #highlighting {
            margin: 0; padding: 20px;
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            border: none; outline: none;
            font-family: inherit !important;
            font-size: 14px !important;
            line-height: 22px !important; 
            tab-size: 4; white-space: pre;
            overflow-wrap: normal; box-sizing: border-box;
        }

        #editing {
            z-index: 1; color: transparent; background: transparent;
            caret-color: #60a5fa; resize: none;
            -webkit-text-fill-color: transparent; overflow: auto;
        }

        #highlighting { z-index: 0; pointer-events: none; overflow: hidden; background: #0d0d0d; }

        #error-log {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: rgba(185, 28, 28, 0.9); color: white;
            padding: 10px 20px; font-size: 12px; max-height: 30%;
            overflow-y: auto; display: none; z-index: 50;
        }

        .ui-overlay {
            position: absolute; top: 10px; right: 10px;
            display: flex; flex-direction: column; gap: 8px; z-index: 20;
        }

        .btn {
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2); color: white;
            padding: 8px 12px; border-radius: 6px; font-size: 11px;
            cursor: pointer; transition: all 0.2s; text-align: center;
            font-weight: bold; text-transform: uppercase;
        }
        .btn:hover { background: rgba(255, 255, 255, 0.2); }

        .status-badge {
            position: absolute; bottom: 10px; left: 10px;
            padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold;
            text-transform: uppercase;
        }

        /* Painel Lateral */
        #slots-panel {
            position: fixed; top: 0; right: -100%; width: 320px; height: 100%;
            background: #121212; border-left: 1px solid #333; z-index: 300;
            transition: right 0.3s ease; display: flex; flex-direction: column;
        }
        #slots-panel.open { right: 0; }

        .carousel-btn {
            background: #222; color: white; width: 24px; height: 24px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 4px; font-size: 14px; transition: 0.2s;
            border: 1px solid #444;
        }
        .carousel-btn:hover { background: #60a5fa; }
        .carousel-btn:active { transform: scale(0.9); }

        #toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #22c55e; color: white; padding: 10px 20px;
            border-radius: 20px; font-size: 13px; font-weight: bold;
            z-index: 500; display: none;
        }

        /* Área de Importação */
        #import-area {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #121212; z-index: 310; display: none; flex-direction: column;
            padding: 20px;
        }

        .slot-item {
            background: #1e1e1e; border: 1px solid #333; margin-bottom: 8px;
            border-radius: 6px; padding: 10px; display: flex; flex-direction: column; gap: 8px;
        }

        .slot-name-input { background: transparent; border: none; color: #fbbf24; font-weight: bold; width: 100%; outline: none; }
    </style>
</head>
<body id="body-root">

<div id="toast">Pronto!</div>
<div id="overlay" class="fixed inset-0 bg-black/50 z-[250] hidden" onclick="toggleSlots()"></div>

<!-- Painel de Gerenciamento -->
<div id="slots-panel">
    <div class="p-4 border-b border-white/10 flex justify-between items-center bg-black">
        <span class="text-xs font-bold uppercase text-zinc-500">Gerenciar Memória</span>
        <button onclick="toggleSlots()" class="text-zinc-500 text-xl">✕</button>
    </div>
    
    <div class="p-3 grid grid-cols-2 gap-2 border-b border-white/5">
        <button onclick="exportBackup()" class="py-2 text-[10px] bg-zinc-800 hover:bg-zinc-700 rounded uppercase font-bold text-zinc-300">Exportar JSON</button>
        <button onclick="showImportUI()" class="py-2 text-[10px] bg-zinc-800 hover:bg-zinc-700 rounded uppercase font-bold text-zinc-300">Importar JSON</button>
    </div>

    <div id="import-area">
        <div class="flex justify-between items-center mb-4">
            <span class="text-xs font-bold uppercase text-zinc-400">Colar Backup</span>
            <button onclick="hideImportUI()" class="text-zinc-500">Voltar</button>
        </div>
        <textarea id="import-input" class="flex-grow bg-black border border-white/10 p-3 rounded text-[10px] text-green-500 font-mono outline-none mb-4" placeholder='Cole o JSON aqui...'></textarea>
        <button onclick="processImport()" class="py-3 bg-green-700 hover:bg-green-600 text-white font-bold uppercase rounded text-xs">Confirmar</button>
    </div>

    <div class="flex-grow overflow-y-auto p-4" id="slots-list"></div>
</div>

<div class="app-container" id="app-root">
    <!-- Visualização -->
    <div id="canvas-container" onclick="handleCanvasClick()">
        <canvas id="gl-canvas"></canvas>
        <div class="ui-overlay">
            <button class="btn border-amber-500/50 text-amber-500" onclick="event.stopPropagation(); toggleSlots()">Slots (100)</button>
            <div class="h-px bg-white/10 my-1"></div>
            <button class="btn" onclick="event.stopPropagation(); togglePlay()" id="btn-play">Pausar</button>
            <button class="btn" onclick="event.stopPropagation(); handleFullscreen()" id="btn-fs">Resultado</button>
            <button class="btn" onclick="event.stopPropagation(); resetTime()">Reset Tempo</button>
            <button class="btn" onclick="event.stopPropagation(); copyCode()">Copiar Código</button>
        </div>
        <div id="status" class="status-badge bg-green-500 text-white">Ao Vivo</div>
    </div>

    <!-- Editor -->
    <div id="editor-container">
        <div class="flex items-center justify-between px-4 py-2 bg-neutral-800 border-b border-neutral-700">
            <div class="flex items-center gap-3">
                <span class="text-[10px] text-neutral-500 font-mono uppercase tracking-widest">Editor</span>
                <div class="flex items-center gap-1 bg-black/30 p-1 rounded-md border border-white/5">
                    <button class="carousel-btn" onclick="carouselNavigate(-1)">‹</button>
                    <span id="carousel-info" class="text-[9px] px-2 text-amber-500 font-bold min-w-[80px] text-center">Nenhum Slot</span>
                    <button class="carousel-btn" onclick="carouselNavigate(1)">›</button>
                </div>
            </div>
            <span id="cursor-pos" class="text-[10px] text-neutral-500 font-mono">Linha 1, Col 1</span>
        </div>
        
        <div id="code-area">
            <pre id="highlighting" aria-hidden="true"><code class="language-glsl" id="highlighting-content"></code></pre>
            <textarea id="editing" spellcheck="false" oninput="updateEditor(this.value); syncScroll(this);" onscroll="syncScroll(this);" onkeydown="handleKey(event)"></textarea>
        </div>
        <div id="error-log"></div>
    </div>
</div>

<script>
    const canvas = document.getElementById('gl-canvas');
    const gl = canvas.getContext('webgl2') || canvas.getContext('webgl');
    const isWebGL2 = gl instanceof WebGL2RenderingContext;
    const editing = document.getElementById('editing');
    const highlightingContent = document.getElementById('highlighting-content');
    const errorLog = document.getElementById('error-log');
    const statusBadge = document.getElementById('status');
    const cursorPos = document.getElementById('cursor-pos');
    const btnPlay = document.getElementById('btn-play');
    const btnFs = document.getElementById('btn-fs');
    const canvasContainer = document.getElementById('canvas-container');
    const bodyRoot = document.getElementById('body-root');
    const carouselInfo = document.getElementById('carousel-info');
    const importArea = document.getElementById('import-area');
    const importInput = document.getElementById('import-input');

    let program, positionBuffer;
    let startTime = Date.now(), pausedTime = 0, isPaused = false;
    let mouseX = 0, mouseY = 0;
    let currentSlotID = null;

    const STORAGE_KEY = 'glsl_slots_v2';
    const LEGACY_KEYS = ['glsl_slots_v1', 'glsl_slots', 'glslSlots', 'shader_slots'];

    const DEFAULT_SLOTS_JSON = `{"1":{"code":"vec2 p=(FC.xy*2.-r)/r.y*2e1;\no=tanh(vec4(1,1,2,1)/length(p*.2+tan(sin(p+=t).yx+p)));","date":"22/01/2026, 10:55:50","name":"Patterns"},"2":{"code":"vec2 p=(FC.rg*2.-r)/r.y,c,s;vec3 z=vec3(p,sqrt(1.-dot(p,p)));c=vec2(atan(z.x,z.z),z.y/=-.6),s=vec2(.2/dot(z-.6,z-.5)+sin(c.y*7.),.5*t);for(float f=8.;f<1e2;f/=.7)c+=sin(c.yx*f+s)/f;o+=z.z*.5*(cos(.3*s.x+vec4(.4,.6,.7,0)-sin(c.y/vec4(.34,.32,.3,1)))+1.);","date":"22/01/2026, 10:56:29","name":"Júpiter"},"3":{"code":"vec2 p=3.*(FC.xy*2.-r)/r.y,v=p+p+(t+r)*cos(r+ceil(p+sin(p*5.))).yx;o=tanh(.1*(cos(.6*p.x+.3*sin(v.y)+vec4(0,1,2,3))+1.)/length(.9+sin(v)));","date":"22/01/2026, 10:57:35","name":"Mirrors"},"4":{"code":"vec3 p=(FC.xy*2.-r)/r.y*mat3x2(-8,0,4,7,4,-7)*.1,f=fract(p+.5)-.5;o=tanh(.3*tan(3.*p.y-t+sin(dot(f,f)*4e1)+vec4(0,.2,.3,0)));o*=o;","date":"22/01/2026, 11:07:00","name":"Portals"},"5":{"code":"vec2 p=(FC.xy*2.-r)/r.y/.3+t*vec2(2./PI,1),w=mod(p,2.)-1.;o=sin(p.y-sqrt(1.-w*w).x*cos(ceil(p.x*.5)*PI)+vec4(0,1,2,0));","date":"22/01/2026, 11:08:23","name":"Pillars"},"6":{"code":"float l=length((FC.xy*2.)/r.x-1.)*2e1;o=smoothstep(-.7,1.,(sin(l-sin(l+t)+FC.x/r.x/.1+vec4(0,1,2,0))+.4)*cos(l));","date":"22/01/2026, 11:09:38","name":"Pool"},"7":{"code":"vec2 p=(FC.xy*2.-r)/r.y/.9;float l=length(p)-1.;o=.5+.5*tanh(.1/max(l/.1,-l)-sin(l+p.y*max(1.,-l/.1)+t+vec4(0,1,2,0)));","date":"22/01/2026, 11:11:00","name":"Glass"},"8":{"code":"vec2 u=FC.xy/r.y*45.,v=u+t*vec2(0,fract(sin(floor(u.x)*71.)*53.)*3.+2.),f=(fract(v)-.5)*2.;\nfloat c=fract(sin(dot(floor(v)+floor(t*9.)*.1,vec2(12,78)))*437.),\ng=step(abs(f.x+f.y*mix(-1.,1.,fract(c*13.))),.1)+step(abs(f.y-fract(c*7.)),.1)*step(abs(f.x),.5),\nl=fract(-v.y*.1+t*.1),h=pow(l,30.)*15.;\no.g=g*(l+h);o.rb+=g*h*.7;","date":"05/02/2026, 11:34:52","name":"Matrix Rain"},"9":{"code":"for(float z,d,i;i++<2e1;){vec3 p=z*normalize(FC.rgb*2.-r.xyx);p=vec3(atan(p.y/.2,p.x)*2.,p.z/3.,length(p.xy)-5.-z*.2);for(d=1.;d<7.;d++)p+=sin(p.yzx*d+t+.3*i)/d;z+=d=length(vec4(.4*cos(p)-.4,p.z));o+=(cos(p.x+i*.4+z+vec4(6,1,2,0))+1.)/d;}o=tanh(o*o/4e2);","date":"22/01/2026, 11:21:39","name":"Accretion"},"10":{"code":"vec2 p=(FC.xy*2.-r)/r.y/.3;for(float f;f++<1e2;p+=.02*sin(p.yx+.5*t))o+=(cos(f/27.+vec4(0,1,3,0))+1.1)/length(sin(p*sin(r+f)/.7));o=tanh(o*o/4e4);","date":"22/01/2026, 11:24:06","name":"Cleanse"},"11":{"code":"for(float z,d,i;i++<90.;){vec3 p=z*normalize(FC.rgb*2.-r.xyx);p=vec3(atan(p.y,p.x),p.z/8.-t,length(p.xy)-9.);for(d=0.;d++<7.;)p+=sin(p.yzx*d+t+i*.2)/d;z+=d=.2*length(vec4(.2*cos(6.*p)-.2,p.z));o+=(cos(p.x+vec4(0,.5,1,0))+1.)/d/z;}o=tanh(o*o/3e2);","date":"22/01/2026, 11:25:56","name":"Maelstrom"},"12":{"code":"for(float z,d,i;i++<90.;){vec3 p=z*normalize(FC.rgb*2.-r.xyx);p=vec3(atan(p.y,p.x),p.z/3.-t,length(p.xy)-9.);for(d=0.;d++<5.;)p+=sin(ceil(p.yzx*d-i*vec3(.2,0,0)))/d;z+=d=.2*length(vec4(.2*cos(6.*p)-.2,p.z));o+=(cos(p.x+vec4(0,.5,1,0))+1.)/d/z;}o=tanh(o*o/8e2);","date":"22/01/2026, 11:27:10","name":"Tunnel"},"13":{"code":"for(float i,z,d,h;i++<5e1;o+=vec4(3,z,i,1)/d)\n{vec3 p=z*normalize(FC.rgb*2.-r.xyy),a;a.y++;p.z+=7.;a=mix(dot(a,p)*a,p,sin(h=length(p)-t))+cos(h)*cross(a,p);\nfor(d=0.;d++<9.;a+=sin(round(a*d)-t).zxy/d);z+=d=.1*length(a.xz);}\no=tanh(o/1e4);","date":"22/01/2026, 11:29:52","name":"Lapse"},"14":{"code":"for(float i,z,d;i++<7e1;o+=vec4(9,i,z,1)/d){vec3 p=z*normalize(FC.rgb*2.-r.xyy),a=normalize(sin(t/4.+vec3(0,2,4))),v;p.z+=7.;v=a=dot(a,p)*a+cross(a,p);\nfor(d=2.;d++<9.;a+=sin(ceil(a*d)-t).yzx/d);z+=d=.1*length(sin(a*a))*sqrt(length(v*sin(v.yzx)));}\no=tanh(o/6e4);","date":"22/01/2026, 11:30:45","name":"Vectors"},"15":{"code":"for(float i,z,d;i++<55.;o+=vec4(9,4,2,1)/d){vec3 p=z*normalize(FC.rgb*2.-r.xyy);for(d=0.;d++<9.;p+=sin(ceil(p/9.).zxy+t));z+=d=.1*abs(p.z+40.);}o=tanh(o/6e3);","date":"22/01/2026, 11:32:04","name":"Stairs"},"16":{"code":"float i,d,w,s,n,m=1.;for(mat2 R=mat2(cos(sin(t/2.)*.785+vec4(0,33,11,0)));i++<1e2;){vec3 k,p=vec3((FC.xy*2.-r.xy)/r.y*d,d-10.);p.xz*=R;if(p.y<-6.3){p.y=-p.y-9.;m=.5;}k=p;for(p*=.5,n=.01;n<.2;n+=n)p.yz+=cos(p.xy*.01)-abs(dot(sin(.02*p.z+.03*p.y+2.*t+.3*p/n),p-p+n));s=length(k.xy)-4.;d+=w=.01+.07*abs(max(w=mix(sin(length(ceil(k*4.).z+k)),sin(length(p)-1.),smoothstep(5.,5.5,p.y)),sqrt(s*s+k*k).z-1.5)-i/150.);o+=max(sin(vec4(1,2,3,1)+i*.5)*1.3/w,-length(k*k));}o=tanh(o*o/1e6)*m;","date":"22/01/2026, 11:51:35","name":"Stormy Torus"},"17":{"code":"vec3 p;for(float d,i,z;i++<5e1;o+=(cos(i/9.+vec4(2,1,0,0))+1.)/d/z)\np=z*normalize(FC.rgb*2.-r.xyy),p.z-=t,d=abs(.01*z-.1),z+=d=max(d,.5*length(vec2(3.-abs(p.y)+dot(cos(p+.3*t),sin(.3*t-.6*p.yzx)),cos(p/.3-p.z)*.3))-d);\no=tanh(o/8e1);","date":"22/01/2026, 11:59:03","name":"Chords"},"18":{"code":"vec3 p;\nfor(float d,i,z;i++<1e2;o+=(cos(z*.3+vec4(0,1,2,0))+2.)/d/z)\np=z*normalize(FC.rgb*2.-r.xyy),p.z-=t-z*.6,d=abs(.03*z-.3),z+=d=max(d,length(max(p=cos(p),p.yzx))-d);\no=tanh(o*o/9e2);","date":"22/01/2026, 12:03:18","name":"Aperture"},"19":{"code":"for(float i,z,d,l;i++<6e1;o+=vec4(l,2,z,1)/d/l/z){vec3 p=z*normalize(FC.rgb*2.-r.xyy),a=p-.9*p.xzy;p.z+=5.;\nfor(d=1.;d++<9.;a+=sin(round(a*d).yzx+t)/d);z+=d=length(vec4(sin(a*a)*.3,cos((l=length(p))/.3)))/6.;}\no=tanh(o*o/1e6);","date":"22/01/2026, 12:08:49","name":"Magnetic"},"20":{"code":"for(float z,d,i;i++<5e1;z+=d,o+=(.9+sin(i*.1-vec4(6,1,2,0)))/d/d/z+d*z/vec4(4,2,1,0)){vec3 p=z*normalize(FC.rgb*2.-r.xyx);for(d=0.;d++<9.;)p+=.4*sin(p.yzx*d-z+t+i)/d+.5;d=length(vec4(abs(p.y+p.z*.5),sin(p-z)/7.))/(4.+z*z/1e2);}o=tanh(o/2e3);","date":"14/02/2026, 12:41:10","name":"Reef"},"21":{"code":"vec3 c,p;for(float i,z,d,h;i++<5e1;o+=max(cos(p.x*.4+vec4(0,2,4,0)),5./h/h)/d/d)p=z*normalize(FC.rgb*2.-r.xyy),p.z+=9.,h=length(p=dot(c=normalize(cos(vec3(0,2,4)-t*.5+h*.3)),p)*c-cross(c,p)),z+=d=min(abs(dot(p,sin(p).yzx))*.2+max(d=h-5.,.1),abs(--d)+.2)*.2;o=tanh(o/3e4);","date":"22/01/2026, 12:28:11","name":"Siri"},"22":{"code":"vec3 p;for(float i,z,d,b;i++<6e1;o+=vec4(1,5,2,0)/b-(dFdx(z)*r.y-z)/exp(d/.1))p=z*(FC.rgb*2.-r.xyy)/r.y-1.,p.z+=8.,z+=min(b=length(abs(p*=.1*mat3(9,0,3,0,9,2,-7,-2,8)).xy+min(.4*p.z-2.6,0.))/(cos(d/.1-t)+2.),d=max(d=length(p)-5.,d-length(p.xy)+1.-cos(d/.1)*.1))*.5;o=tanh(o/4e3);","date":"22/01/2026,12:30:35","name":"Deathbeam"},"23":{"code":"for(float i,z,d;i++<1e2;o+=(sin(z-t+vec4(6,2,4,0))+1.5)/d){vec3 p=z*normalize(FC.rgb*2.-r.xyy);p.z+=6.;for(d=1.;d<9.;d/=.8)p+=cos(p.yzx*d-t)/d;z+=d=.002+abs(length(p)-.5)/4e1;}o=tanh(o/7e3);","date":"22/01/2026, 12:53:55","name":"Vortex"},"24":{"code":"for(float i,z=fract(dot(FC,FC)/9.),d;i++<3e1;o+=vec4(2,2,3,1)/d){vec3 p=z*normalize(FC.rgb*2.-r.xyy);p.z-=t;z+=d=.01+.3*abs(cos(dot(cos(p),sin(p.yzx/.6+.1*sin(p.zxy/.1))/.1)));}o=tanh(o/1e3);","date":"22/01/2026, 12:54:46","name":"Contours"},"25":{"code":"vec2 p=FC.xy,f=(p-.5*r).yy/5e2;for(float i=1.;i<16.;i+=1./i)f*=mat2(0,.061,1.413, 0)-.737,o+=vec4(1.-f,1.+f)*max(cos(dot(cos(p=(FC.xy-r*.5+f*i)/r.y/.1-t*.5),sin(p/.4+t).yx)/.2+p.y/.6),0.);o=sqrt(tanh(o/60.));","date":"22/01/2026, 12:55:48","name":"Focus"},"26":{"code":"for(float i,z,d;i++<1e2;o+=(cos(z+vec4(4,5,7,0))+1.)/d/z){vec3 p=z*normalize(FC.rgb*2.-r.xyy);p.z+=8.;p.xz*=mat2(cos(.5*t+vec4(0,33,11,0)));z+=d=.1*(.1+abs(length(p)-3.-dot(cos(p=round(p+.6*sin(p))),sin(p/.6).yzx)));}o=tanh(o/8e2);","date":"22/01/2026, 12:56:45","name":"Orbital"},"27":{"code":"for(float i,d,z;i++<1e2;o+=(cos(z+vec4(0,2,3,0))+1.5)/d/z){vec3 p=z*normalize(FC.rgb*2.-r.xyy)+.8;d=max(-p.y,0.);p.y+=d+d-1.;z+=d=.3*(.01+.1*d+length(min(p=cos(p+t)+cos(p/.6).yzx,p.zxy))/++d/d);}o=tanh(o/7e2);","date":"22/01/2026, 12:57:38","name":"Laser Dance"},"28":{"code":"float i = 0.0, e = 0.0, R = 0.0, s = 0.0;\nvec3 q = vec3(0.0), p, d = vec3((FC.xy - 0.5 * r) / r, 0.7);\n\nmat2 rot = mat2(cos(0.8), -sin(0.8),\nsin(0.8), cos(0.8));\n\nq.z -= 1.0;\nfor (; i++ < 99.0; ) {\no.rgb += hsv(0.6, e * 0.4 + p.y, e / 30.0);\n\np = q += d * max(e, 0.01) * R * 0.14;\np.xy = rot * p.xy;\n\nR = length(p);\np = vec3(log2(max(R, 1e-6)), e = -p.z / max(R, 1e-6) - 0.8, atan(p.x * 0.08, p.y) - t * 0.2);\n\nfor (s = 1.0; s < 1e3; s += s) {\ne += abs(dot(sin(p.yzx * s), cos(p.yyz * s))) / s;\n}\n}","date":"28/02/2026, 13:05:40","name":"Polar black hole"}}`;

    const DEFAULT_SLOTS = (() => {
        try { return JSON.parse(DEFAULT_SLOTS_JSON); } catch { return {}; }
    })();

    function safeParseJSON(str) {
        try { return JSON.parse(str || '{}'); } catch { return {}; }
    }

    function getSlotsData() {
        return safeParseJSON(localStorage.getItem(STORAGE_KEY));
    }

    function setSlotsData(data) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data || {}));
    }

    function migrateLegacySlotsIfNeeded() {
        const current = getSlotsData();
        if (Object.keys(current).length > 0) return false;

        for (const key of LEGACY_KEYS) {
            const legacy = safeParseJSON(localStorage.getItem(key));
            if (legacy && Object.keys(legacy).length > 0) {
                setSlotsData(legacy);
                showToast(`Dados recuperados de ${key}`);
                return true;
            }
        }

        if (DEFAULT_SLOTS && Object.keys(DEFAULT_SLOTS).length > 0) {
            setSlotsData(DEFAULT_SLOTS);
            showToast('Slots padrão carregados');
            return true;
        }

        return false;
    }

    // Shader Inicial restaurado para a versão de 1:10pm
    const initialCode = `// Shader inicial
vec2 p = abs(FC.xy/r - .5);
o = p.xyxy / p.yxyx / vec4(3,6,9,1);
o = tanh(o + .1 * length(o));`;

    function wrapShader(code) {
        if (code.includes('void main')) return code;
        const header = isWebGL2 ? `#version 300 es
            precision highp float;
            uniform vec2 u_resolution, u_mouse;
            uniform float u_time;
            out vec4 outColor;
            #define FC gl_FragCoord
            #define r u_resolution
            #define t u_time
            #define m u_mouse
            #define o outColor
            #define PI 3.14159265
            vec3 hsv(float h,float s,float v){vec4 K=vec4(1.,2./3.,1./3.,3.);vec3 p=abs(fract(vec3(h)+K.xyz)*6.-K.www);return v*mix(K.xxx,clamp(p-K.xxx,0.,1.),s);}
            mat3 rotate3D(float a,vec3 v){float s=sin(a),c=cos(a),t=1.-c;return mat3(t*v.x*v.x+c,t*v.x*v.y-s*v.z,t*v.x*v.z+s*v.y,t*v.x*v.y+s*v.z,t*v.y*v.y+c,t*v.y*v.z-s*v.x,t*v.x*v.z-s*v.y,t*v.y*v.z+s*v.x,t*v.z*v.z+c);}
        ` : `
            precision highp float;
            uniform vec2 u_resolution, u_mouse;
            uniform float u_time;
            #define FC gl_FragCoord
            #define r u_resolution
            #define t u_time
            #define m u_mouse
            #define o gl_FragColor
            #define PI 3.14159265
            float tanh(float x){float e=exp(2.*x);return (e-1.)/(e+1.);}
            vec3 hsv(float h,float s,float v){vec4 K=vec4(1.,2./3.,1./3.,3.);vec3 p=abs(fract(vec3(h)+K.xyz)*6.-K.www);return v*mix(K.xxx,clamp(p-K.xxx,0.,1.),s);}
            mat3 rotate3D(float a,vec3 v){float s=sin(a),c=cos(a),t=1.-c;return mat3(t*v.x*v.x+c,t*v.x*v.y-s*v.z,t*v.x*v.z+s*v.y,t*v.x*v.y+s*v.z,t*v.y*v.y+c,t*v.y*v.z-s*v.x,t*v.x*v.z-s*v.y,t*v.y*v.z+s*v.x,t*v.z*v.z+c);}
        `;
        return `${header}\nvoid main(){\n  o=vec4(0,0,0,1);\n  ${code}\n  ${isWebGL2?'':'gl_FragColor=o;'}\n}`;
    }

    function initGL(source) {
        try {
            const fsSource = wrapShader(source);
            const vsSource = isWebGL2 ? `#version 300 es\nin vec4 position;void main(){gl_Position=position;}` : `attribute vec4 position;void main(){gl_Position=position;}`;
            const vs = createShader(gl, gl.VERTEX_SHADER, vsSource);
            const fs = createShader(gl, gl.FRAGMENT_SHADER, fsSource);
            const newProg = gl.createProgram();
            gl.attachShader(newProg, vs); gl.attachShader(newProg, fs);
            gl.linkProgram(newProg);
            if (!gl.getProgramParameter(newProg, gl.LINK_STATUS)) throw new Error(gl.getProgramInfoLog(newProg));
            program = newProg;
            errorLog.style.display = 'none';
            statusBadge.className = "status-badge bg-green-500 text-white";
            statusBadge.textContent = "Ao Vivo";
        } catch (e) { showError(e.message); }
    }

    function createShader(gl, type, src) {
        const s = gl.createShader(type); gl.shaderSource(s, src); gl.compileShader(s);
        if (!gl.getShaderParameter(s, gl.COMPILE_STATUS)) throw new Error(gl.getShaderInfoLog(s));
        return s;
    }

    function showError(m) { errorLog.textContent = m; errorLog.style.display = 'block'; statusBadge.className="status-badge bg-red-600 text-white"; statusBadge.textContent="Erro"; }

    function render() {
        if (!program || isPaused) { requestAnimationFrame(render); return; }
        const w = canvasContainer.clientWidth, h = canvasContainer.clientHeight;
        if (canvas.width !== w || canvas.height !== h) { canvas.width = w; canvas.height = h; }
        gl.viewport(0, 0, canvas.width, canvas.height);
        gl.clear(gl.COLOR_BUFFER_BIT);
        gl.useProgram(program);
        gl.uniform2f(gl.getUniformLocation(program, "u_resolution"), canvas.width, canvas.height);
        gl.uniform1f(gl.getUniformLocation(program, "u_time"), (Date.now() - startTime) / 1000.0);
        gl.uniform2f(gl.getUniformLocation(program, "u_mouse"), mouseX, mouseY);
        const posLoc = gl.getAttribLocation(program, "position");
        gl.enableVertexAttribArray(posLoc);
        if(!positionBuffer){
            positionBuffer = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
            gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]), gl.STATIC_DRAW);
        }
        gl.vertexAttribPointer(posLoc, 2, gl.FLOAT, false, 0, 0);
        gl.drawArrays(gl.TRIANGLES, 0, 6);
        requestAnimationFrame(render);
    }

    function updateEditor(v) { highlightingContent.textContent = v + (v.endsWith("\n")?" ":""); Prism.highlightElement(highlightingContent); initGL(v); updateCursorInfo(); }
    function syncScroll(el) { const p = document.getElementById('highlighting'); p.scrollTop = el.scrollTop; p.scrollLeft = el.scrollLeft; }
    function handleKey(e) { if(e.key==='Tab'){ e.preventDefault(); const s=editing.selectionStart, end=editing.selectionEnd; editing.value=editing.value.substring(0,s)+"    "+editing.value.substring(end); editing.selectionStart=editing.selectionEnd=s+4; updateEditor(editing.value); } }
    function updateCursorInfo() { const lines = editing.value.substring(0, editing.selectionStart).split('\n'); cursorPos.textContent = `Linha ${lines.length}, Col ${lines[lines.length-1].length+1}`; }

    // --- CARROSSEL E MEMÓRIA ---
    function getUsedSlots() {
        const data = getSlotsData();
        return Object.keys(data).filter(k => data[k].code && data[k].code.trim() !== "").sort((a, b) => parseInt(a) - parseInt(b));
    }

    function updateCarouselLabel() {
        const data = getSlotsData();
        if (currentSlotID && data[currentSlotID]) {
            carouselInfo.textContent = data[currentSlotID].name || `Slot #${currentSlotID}`;
        } else {
            carouselInfo.textContent = "Sem Slot";
        }
    }

    function carouselNavigate(dir) {
        const used = getUsedSlots();
        if (used.length === 0) { showToast("Nenhum slot"); return; }
        let index = used.indexOf(String(currentSlotID));
        if (index === -1) index = dir > 0 ? -1 : 0;
        let nextIndex = (index + dir + used.length) % used.length;
        loadSlot(used[nextIndex]);
    }

    function toggleSlots() {
        const isOpen = document.getElementById('slots-panel').classList.toggle('open');
        document.getElementById('overlay').classList.toggle('hidden', !isOpen);
        if(isOpen) { renderSlots(); hideImportUI(); }
    }

    function renderSlots() {
        const list = document.getElementById('slots-list'); list.innerHTML = '';
        const data = getSlotsData();
        for(let i=1; i<=100; i++) {
            const s = data[i], div = document.createElement('div');
            div.className = 'slot-item';
            div.innerHTML = `
                <input type="text" class="slot-name-input" value="${s?.name || 'Slot #'+i}" onblur="renameSlot(${i}, this.value)">
                <div class="flex gap-2">
                    <button class="flex-1 py-2 bg-green-900/30 text-green-400 text-[9px] font-bold rounded" onclick="saveSlot(${i})">Gravar</button>
                    <button class="flex-1 py-2 bg-blue-900/30 text-blue-400 text-[9px] font-bold rounded ${!s?'opacity-20':''}" onclick="loadSlot(${i})" ${!s?'disabled':''}>Ler</button>
                </div>`;
            list.appendChild(div);
        }
    }

    function saveSlot(id) {
        const data = getSlotsData();
        const inputs = document.querySelectorAll('.slot-name-input');
        const name = inputs[id-1].value;
        data[id] = { code: editing.value, date: new Date().toLocaleString(), name: name };
        setSlotsData(data);
        currentSlotID = id;
        updateCarouselLabel();
        showToast(`Slot ${id} salvo!`);
        renderSlots();
    }

    function loadSlot(id) {
        const data = getSlotsData();
        if(data[id]) {
            editing.value = data[id].code;
            currentSlotID = id;
            updateCarouselLabel();
            updateEditor(editing.value);
            showToast(`Carregado: ${data[id].name || id}`);
        }
    }

    function renameSlot(id, name) {
        const data = getSlotsData();
        if(!data[id]) data[id] = { code: "", date: "", name: name }; else data[id].name = name;
        setSlotsData(data);
        updateCarouselLabel();
    }

    function exportBackup() {
        const data = localStorage.getItem(STORAGE_KEY);
        const dummy = document.createElement("textarea"); document.body.appendChild(dummy);
        dummy.value = data || "{}"; dummy.select(); document.execCommand("copy");
        document.body.removeChild(dummy); showToast("JSON copiado!");
    }

    function showImportUI() { importArea.style.display = 'flex'; importInput.value = ''; importInput.focus(); }
    function hideImportUI() { importArea.style.display = 'none'; }
    function processImport() {
        const json = importInput.value.trim();
        if(!json) return;
        try { 
            JSON.parse(json); localStorage.setItem(STORAGE_KEY, json); 
            showToast("Backup Restaurado!"); renderSlots(); updateCarouselLabel(); hideImportUI();
        } catch(e) { showToast("JSON Inválido!"); }
    }

    function showToast(m) { const t = document.getElementById('toast'); t.textContent = m; t.style.display='block'; setTimeout(()=>t.style.display='none', 2000); }
    function togglePlay() { isPaused = !isPaused; btnPlay.textContent = isPaused ? 'Retomar' : 'Pausar'; if(!isPaused) startTime = Date.now()-pausedTime; else pausedTime = Date.now()-startTime; }
    
    function handleFullscreen() {
        if (!document.fullscreenElement) {
            canvasContainer.requestFullscreen().catch(() => {
                bodyRoot.classList.add('is-fullscreen');
            });
        } else {
            document.exitFullscreen();
        }
    }

    function handleCanvasClick() {
        const isManualFs = bodyRoot.classList.contains('is-fullscreen');
        if (document.fullscreenElement || isManualFs) {
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                bodyRoot.classList.remove('is-fullscreen');
                setTimeout(resizeCanvas, 100);
            }
        }
    }

    function resetTime() { startTime = Date.now(); pausedTime = 0; }
    function copyCode() { const dummy = document.createElement("textarea"); document.body.appendChild(dummy); dummy.value = editing.value; dummy.select(); document.execCommand("copy"); document.body.removeChild(dummy); showToast("Código Copiado!"); }

    document.addEventListener('fullscreenchange', () => {
        const fs = !!document.fullscreenElement;
        bodyRoot.classList.toggle('is-fullscreen', fs);
        setTimeout(resizeCanvas, 100);
    });

    canvas.addEventListener('mousemove', e => { const r = canvas.getBoundingClientRect(); mouseX = e.clientX-r.left; mouseY = r.height-(e.clientY-r.top); });
    canvas.addEventListener('touchmove', e => { const r = canvas.getBoundingClientRect(); mouseX = e.touches[0].clientX-r.left; mouseY = r.height-(e.touches[0].clientY-r.top); e.preventDefault(); }, {passive:false});

    window.onload = () => {
        migrateLegacySlotsIfNeeded();
        const used = getUsedSlots();
        if (used.length > 0) {
            loadSlot(used[0]);
        } else {
            editing.value = initialCode;
            updateEditor(initialCode);
        }
        render();
        updateCarouselLabel();
    };
</script>

</body>
</html>

