<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Local - WebGPU Mobile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .dot-pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 0.4; } 50% { opacity: 1; } }
        #chat-container::-webkit-scrollbar { width: 4px; }
        #chat-container::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 h-[100dvh] flex flex-col font-sans overflow-hidden">

    <!-- Header -->
    <header class="bg-white border-b p-4 flex justify-between items-center shrink-0">
        <div>
            <h1 class="font-bold text-slate-800 text-base">Qwen 2.5 Local</h1>
            <p id="status-text" class="text-[10px] text-slate-500 uppercase tracking-wider font-semibold">WebGPU aguardando...</p>
        </div>
        <div id="gpu-badge" class="px-2 py-1 rounded text-[10px] font-bold bg-slate-200 text-slate-600">
            OFFLINE
        </div>
    </header>

    <!-- Chat Area -->
    <main id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 flex flex-col">
        <div id="welcome-card" class="bg-white border p-4 rounded-2xl shadow-sm text-sm text-slate-600 space-y-3">
            <p>Este app roda uma IA 100% privada no seu celular usando a placa de vídeo (GPU).</p>
            <div class="bg-blue-50 p-3 rounded-lg text-blue-800 text-xs">
                <strong>Modelo:</strong> Qwen2.5 0.5B (~350MB)<br>
                <strong>Vantagem:</strong> Muito rápido e gasta pouca bateria.
            </div>
            <button id="load-btn" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg active:scale-95 transition-transform">
                Começar Download (350MB)
            </button>
        </div>
    </main>

    <!-- Error/Notice Box -->
    <div id="message-box" class="hidden mx-4 mb-2 p-3 rounded-lg text-xs font-medium"></div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-white/95 z-50 flex flex-col items-center justify-center p-8 text-center">
        <div class="relative w-20 h-20 mb-6">
            <div class="absolute inset-0 border-4 border-blue-100 rounded-full"></div>
            <div id="spinner" class="absolute inset-0 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
        </div>
        <h2 class="text-lg font-bold text-slate-800 mb-1">Preparando IA</h2>
        <p id="progress-text" class="text-sm text-slate-500 mb-4 italic">Isso pode levar um minuto no Wi-Fi...</p>
        <div class="w-full max-w-xs bg-slate-100 h-2 rounded-full overflow-hidden border">
            <div id="progress-bar" class="bg-blue-600 h-full w-0 transition-all duration-300"></div>
        </div>
    </header>

    <!-- Input Area -->
    <footer class="p-4 bg-white border-t shrink-0">
        <div class="flex gap-2">
            <input type="text" id="user-input" placeholder="Aguardando carregamento..." 
                   class="flex-1 border border-slate-200 rounded-full px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-slate-50" 
                   disabled>
            <button id="send-btn" class="bg-blue-600 text-white p-3 rounded-full hover:bg-blue-700 disabled:bg-slate-200 shadow-md disabled:shadow-none transition-all" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                    <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
                </svg>
            </button>
        </div>
    </footer>

    <script type="module">
        // Usando a versão estável 3.x
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.0.1';

        // Configurações globais para evitar erros de cache/acesso
        env.allowLocalModels = false;
        env.useBrowserCache = true;

        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const statusText = document.getElementById('status-text');
        const gpuBadge = document.getElementById('gpu-badge');
        const loadBtn = document.getElementById('load-btn');
        const loadingOverlay = document.getElementById('loading-overlay');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const messageBox = document.getElementById('message-box');

        let generator = null;

        function showMessage(text, type = 'error') {
            messageBox.innerText = text;
            messageBox.className = `mx-4 mb-2 p-3 rounded-lg text-xs font-medium block ${type === 'error' ? 'bg-red-50 text-red-700' : 'bg-green-50 text-green-700'}`;
            setTimeout(() => { messageBox.classList.add('hidden'); }, 5000);
        }

        async function checkSupport() {
            if (!navigator.gpu) {
                statusText.innerText = "WebGPU NÃO SUPORTADO";
                statusText.classList.add('text-red-500');
                loadBtn.disabled = true;
                loadBtn.innerText = "Navegador incompatível";
                showMessage("Seu navegador não suporta WebGPU. No Android use o Chrome e ative WebGPU em flags.");
                return;
            }
            gpuBadge.innerText = "WebGPU DISPONÍVEL";
            gpuBadge.className = "px-2 py-1 rounded text-[10px] font-bold bg-green-100 text-green-700";
        }

        async function startApp() {
            loadingOverlay.classList.remove('hidden');
            try {
                // Qwen2.5-0.5B é o modelo mais estável para mobile WebGPU atualmente
                const modelId = 'onnx-community/Qwen2.5-0.5B-Instruct-ONNX';
                
                generator = await pipeline('text-generation', modelId, {
                    device: 'webgpu',
                    dtype: 'q4', // 4-bit para economizar RAM e evitar erros de permissão
                    progress_callback: (data) => {
                        if (data.status === 'progress') {
                            const p = Math.round(data.progress);
                            progressBar.style.width = `${p}%`;
                            progressText.innerText = `Baixando ${data.file.split('/').pop()}: ${p}%`;
                        }
                        if (data.status === 'done') {
                            progressText.innerText = "Finalizando carregamento...";
                        }
                    }
                });

                loadingOverlay.classList.add('hidden');
                document.getElementById('welcome-card').remove();
                statusText.innerText = "ONLINE - PROCESSANDO NA GPU";
                userInput.disabled = false;
                userInput.placeholder = "Pergunte qualquer coisa...";
                sendBtn.disabled = false;
                
                addMessage("Sistema", "IA carregada! Tudo o que você digitar aqui fica no seu celular.", "bg-slate-100 text-slate-500 text-[10px] italic");

            } catch (err) {
                loadingOverlay.classList.add('hidden');
                console.error(err);
                showMessage(`Erro: ${err.message}. Tente recarregar ou verifique sua internet.`);
            }
        }

        function addMessage(sender, text, customClass = "") {
            const msgDiv = document.createElement('div');
            const isUser = sender === 'Você';
            msgDiv.className = `p-3 rounded-2xl max-w-[85%] ${isUser ? 'bg-blue-600 text-white self-end rounded-tr-none' : 'bg-white border border-slate-200 text-slate-800 self-start rounded-tl-none'} ${customClass}`;
            
            const label = isUser ? "" : `<p class="text-[9px] uppercase font-black mb-1 opacity-50 tracking-widest">${sender}</p>`;
            msgDiv.innerHTML = `${label}<div class="text-sm leading-relaxed">${text.replace(/\n/g, '<br>')}</div>`;
            
            chatContainer.appendChild(msgDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return msgDiv;
        }

        async function handleChat() {
            const prompt = userInput.value.trim();
            if (!prompt || !generator) return;

            userInput.value = '';
            userInput.disabled = true;
            sendBtn.disabled = true;

            addMessage("Você", prompt);
            const aiMsgDiv = addMessage("Qwen", "Gerando resposta...", "dot-pulse italic text-slate-400");

            try {
                const messages = [{ role: "user", content: prompt }];
                
                // Configuração otimizada para resposta rápida no mobile
                const output = await generator(messages, {
                    max_new_tokens: 256,
                    temperature: 0.6,
                    do_sample: true,
                    top_p: 0.9,
                });

                const reply = output[0].generated_text.at(-1).content;
                aiMsgDiv.innerHTML = `<p class="text-[9px] uppercase font-black mb-1 opacity-50 tracking-widest">Qwen</p><div class="text-sm leading-relaxed">${reply.replace(/\n/g, '<br>')}</div>`;
                aiMsgDiv.classList.remove('dot-pulse', 'italic', 'text-slate-400');
            } catch (err) {
                aiMsgDiv.innerText = "Erro na geração: " + err.message;
            } finally {
                userInput.disabled = false;
                sendBtn.disabled = false;
                userInput.focus();
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        loadBtn.onclick = startApp;
        sendBtn.onclick = handleChat;
        userInput.onkeypress = (e) => { if(e.key === 'Enter') handleChat(); };

        checkSupport();
    </script>
</body>
</html>

