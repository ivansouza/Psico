<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Pulley Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- MathJax configuration for LaTeX formula rendering -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; background-color: #020617; }
        canvas { display: block; }
        .glass-panel {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .side-panel { transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); z-index: 70; }
        .side-panel.hidden-panel { transform: translateX(-110%); }
        
        #explanation-modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 100;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px);
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .hud-slider-container {
            pointer-events: auto;
            width: 90%;
            max-width: 450px;
            background: rgba(15, 23, 42, 0.9);
            padding: 12px 20px;
            border-radius: 40px;
            border: 1px solid rgba(59, 130, 246, 0.3);
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            z-index: 50;
        }

        input[type=range] { -webkit-appearance: none; background: transparent; cursor: pointer; width: 100%; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px; width: 24px; border-radius: 50%;
            background: #3b82f6; border: 3px solid white;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
            margin-top: -10px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px;
        }

        .status-pill {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 4px 10px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            min-width: 85px;
        }

        #toast {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(16, 185, 129, 0.95);
            color: white;
            padding: 10px 24px;
            border-radius: 12px;
            font-weight: bold;
            display: none;
            z-index: 200;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            font-size: 14px;
            pointer-events: none;
        }

        .formula-box {
            background: rgba(0,0,0,0.3);
            padding: 1rem;
            border-radius: 0.75rem;
            border-left: 4px solid #3b82f6;
            font-family: serif;
        }
        mjx-container { margin: 0.5em 0 !important; color: white !important; }
    </style>
</head>
<body>

    <!-- Settings Button -->
    <button onclick="togglePanel()" class="fixed top-6 left-6 z-[80] p-3 bg-blue-600 hover:bg-blue-500 text-white rounded-full shadow-lg transition-all active:scale-90">
        <i data-lucide="settings"></i>
    </button>

    <div id="toast">Configuration saved and copied successfully!</div>

    <!-- Physics Explanation Modal -->
    <div id="explanation-modal" class="flex pointer-events-auto">
        <div class="glass-panel max-w-3xl w-full max-h-[85vh] overflow-y-auto rounded-3xl p-8 text-white relative border border-white/20 shadow-2xl">
            <button onclick="toggleExplanation()" class="absolute top-6 right-6 text-slate-400 hover:text-white">
                <i data-lucide="x"></i>
            </button>
            <h2 class="text-3xl font-black mb-6 text-blue-400 italic text-center border-b border-white/10 pb-4">Pulley Fundamentals</h2>
            
            <div class="space-y-8 text-slate-200 text-sm md:text-base leading-relaxed">
                <section>
                    <h3 class="text-xl font-bold text-white mb-3 flex items-center gap-2 italic text-blue-300">
                        <i data-lucide="history" class="w-5 h-5"></i> Historical Origin
                    </h3>
                    <p>
                        The systematic use of pulleys dates back to Ancient Greece. The inventor <strong>Archimedes of Syracuse</strong> (c. 287 BC) revolutionized mechanics by proving that pulley systems can multiply human force to move colossal masses.
                    </p>
                </section>

                <section>
                    <h3 class="text-xl font-bold text-white mb-3 flex items-center gap-2 italic text-emerald-300">
                        <i data-lucide="microscope" class="w-5 h-5"></i> Block and Tackle Physics
                    </h3>
                    <p class="mb-4">The system demonstrated is an industrial block and tackle, where the force is distributed across the segments of rope supporting the lower block.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="formula-box">
                            <p class="text-blue-400 text-xs uppercase font-bold mb-1">Mechanical Advantage (MA)</p>
                            $$MA = n$$
                            <p class="text-[10px] mt-1 text-slate-400">Where $n$ is the total number of pulleys in the system.</p>
                        </div>
                        <div class="formula-box">
                            <p class="text-emerald-400 text-xs uppercase font-bold mb-1">Effort Force ($F_e$)</p>
                            $$F_e = \frac{M \cdot g}{MA}$$
                            <p class="text-[10px] mt-1 text-slate-400">$M$: Mass (kg), $g$: Gravity ($\approx 9.81 m/s^2$).</p>
                        </div>
                    </div>
                </section>

                <section>
                    <h3 class="text-xl font-bold text-white mb-3 flex items-center gap-2 italic text-purple-300">
                        <i data-lucide="truck" class="w-5 h-5"></i> Real-World Applications
                    </h3>
                    <ul class="list-disc list-inside space-y-2 text-slate-300">
                        <li><strong>Construction:</strong> High-tonnage cranes using compact motors.</li>
                        <li><strong>Maritime:</strong> Sail adjustments on recreational and cargo ships.</li>
                        <li><strong>Gyms:</strong> Cable machines directing load through pulleys.</li>
                        <li><strong>Elevators:</strong> Efficient counterweight systems.</li>
                    </ul>
                </section>
            </div>
        </div>
    </div>

    <!-- Side Panel -->
    <aside id="controls-panel" class="side-panel pointer-events-auto fixed top-0 left-0 h-full w-full max-w-[300px] glass-panel p-6 text-white flex flex-col gap-4 hidden-panel shadow-2xl overflow-y-auto">
        <div class="mt-12">
            <h1 class="text-xl font-bold italic text-blue-400">3D Pulley Simulator</h1>
            <p class="text-[10px] text-slate-400 uppercase font-black tracking-widest opacity-70">Engineering Control</p>
        </div>

        <div class="space-y-4">
            <div class="space-y-1">
                <div class="flex justify-between items-end">
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Total Pulleys:</label>
                    <span id="pulley-count-label" class="text-lg font-black text-blue-400">4</span>
                </div>
                <input type="range" id="pulley-count-range" min="1" max="20" step="1" value="4">
            </div>

            <div class="space-y-1">
                <div class="flex justify-between items-end">
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Support Position:</label>
                    <span id="pulley-x-label" class="text-lg font-black text-blue-400">6.0</span>
                </div>
                <input type="range" id="pulley-x-range" min="-10" max="10" step="0.1" value="6.0">
            </div>

            <div class="space-y-1">
                <div class="flex justify-between items-end">
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Load Mass:</label>
                    <span id="mass-label" class="text-lg font-black text-blue-400">100 kg</span>
                </div>
                <input type="range" id="mass-range" min="5" max="500" step="5" value="100">
            </div>
        </div>

        <div class="bg-blue-500/10 border border-blue-500/20 p-3 rounded-xl flex justify-between items-center mt-2">
            <span class="text-[9px] font-bold text-slate-400 uppercase">Effort:</span>
            <span id="force-val" class="text-base font-black text-blue-400 tracking-tighter">245.3 N</span>
        </div>

        <div class="flex flex-col gap-2 mt-4">
            <button onclick="saveAndCopyState()" class="w-full py-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl text-xs font-bold flex items-center justify-center gap-2 transition-all shadow-lg active:scale-95">
                <i data-lucide="save" class="w-4 h-4"></i> Save Configuration
            </button>
            <button onclick="toggleExplanation()" class="w-full py-2.5 bg-slate-800 hover:bg-slate-700 text-white rounded-xl text-xs font-bold flex items-center justify-center gap-2 transition-all border border-white/10">
                <i data-lucide="book-open" class="w-4 h-4"></i> History & Formulas
            </button>
        </div>
        
        <p class="text-[9px] text-slate-500 text-center italic mt-auto pt-4">Definitions will be saved in your browser and copied as JSON.</p>
    </aside>

    <!-- HUD -->
    <div class="fixed inset-0 pointer-events-none flex flex-col justify-between items-center p-6 md:p-10">
        <div class="w-full"></div> 

        <div class="w-full flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="hidden md:block w-12"></div>

            <div class="hud-slider-container flex flex-col items-center gap-2">
                <div class="flex justify-between w-full px-4 text-[9px] font-black uppercase tracking-tighter text-blue-400/60">
                    <span>Release (10.00m)</span>
                    <span class="text-white font-bold tracking-widest uppercase italic text-[10px]">Traction Control</span>
                    <span>Lift (3.42m)</span>
                </div>
                <input type="range" id="lift-range-hud" min="0" max="100" value="0" class="hud-range">
            </div>

            <div class="flex gap-2 pointer-events-auto z-40">
                <div class="status-pill border-r-4 border-blue-500">
                    <span class="text-[8px] text-slate-500 font-bold uppercase whitespace-nowrap">Effort</span>
                    <span id="effort-kg-val" class="text-xs font-black text-blue-400">25.0kg</span>
                </div>
                <div class="status-pill border-r-4 border-emerald-500">
                    <span class="text-[8px] text-slate-500 font-bold uppercase whitespace-nowrap">Advantage</span>
                    <span id="vm-val" class="text-xs font-black text-emerald-400">4.0x</span>
                </div>
                <div class="status-pill border-r-4 border-rose-500">
                    <span class="text-[8px] text-slate-500 font-bold uppercase whitespace-nowrap">Load-Ceiling</span>
                    <span id="dist-ceil-val" class="text-xs font-black text-rose-400">10.00m</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let scene, camera, renderer, controls;
        let fixedBlock, movingBlock, weightBody, ropeMesh, knotMesh, globalAnchor, massLabelSprite, handIndicator;
        let slingMesh; 
        let pulleys = { fixed: [], moving: [] };
        
        // USER-PROVIDED INITIAL PRESET
        const USER_PRESET = {
          "config": {
            "numPulleys": 4,
            "mass": 100,
            "pulleyXOffset": 6,
            "lift": 0
          },
          "camera": {
            "position": {
              "x": -14.378755067797094,
              "y": 11.414159723935956,
              "z": 23.330875586979968
            },
            "target": {
              "x": 1.8794027693272422,
              "y": 5.622480838996374,
              "z": 0.5720045066534587
            }
          }
        };

        let config = { 
            ...USER_PRESET.config,
            pulleyRadius: 0.45, pulleyWidth: 0.22, grooveDepth: 0.12,
            ropeRadius: 0.04, ceilingY: 13.5, groundY: 1.0, dropX: 0.0
        };

        const GRAVITY = 9.81;

        function togglePanel() {
            document.getElementById('controls-panel').classList.toggle('hidden-panel');
        }

        function toggleExplanation() {
            const modal = document.getElementById('explanation-modal');
            modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
            if (window.MathJax && modal.style.display === 'flex') {
                MathJax.typesetPromise();
            }
        }

        function saveAndCopyState() {
            const state = {
                config: {
                    numPulleys: config.numPulleys,
                    mass: config.mass,
                    pulleyXOffset: config.pulleyXOffset,
                    lift: config.lift
                },
                camera: {
                    position: { x: camera.position.x, y: camera.position.y, z: camera.position.z },
                    target: { x: controls.target.x, y: controls.target.y, z: controls.target.z }
                }
            };
            const json = JSON.stringify(state, null, 2);
            localStorage.setItem('pulley_sim_v1', json);
            
            const textarea = document.createElement('textarea');
            textarea.value = json;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);

            const toast = document.getElementById('toast');
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 3000);
        }

        function createTextTexture(text) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 512; canvas.height = 256;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
            ctx.roundRect(40, 40, 432, 176, 30); ctx.fill();
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 110px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, canvas.width / 2, canvas.height / 2);
            return new THREE.CanvasTexture(canvas);
        }

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x020617);
            scene.fog = new THREE.Fog(0x020617, 15, 110);

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(USER_PRESET.camera.position.x, USER_PRESET.camera.position.y, USER_PRESET.camera.position.z);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.body.appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.target.set(USER_PRESET.camera.target.x, USER_PRESET.camera.target.y, USER_PRESET.camera.target.z);

            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            const sun = new THREE.DirectionalLight(0xffffff, 1.2);
            sun.position.set(10, 30, 20);
            scene.add(sun);

            createEnvironment();
            const hGeo = new THREE.SphereGeometry(0.12, 16, 16);
            const hMat = new THREE.MeshStandardMaterial({ color: 0xef4444, emissive: 0x991b1b });
            handIndicator = new THREE.Mesh(hGeo, hMat);
            scene.add(handIndicator);

            rebuildSystem();
            lucide.createIcons();
            animate();
        }

        function createEnvironment() {
            const grid = new THREE.GridHelper(100, 50, 0x1e293b, 0x0f172a);
            grid.position.y = config.groundY; 
            scene.add(grid);
            const ceiling = new THREE.Mesh(new THREE.BoxGeometry(40, 0.4, 20), new THREE.MeshStandardMaterial({ color: 0x1e293b, metalness: 0.8 }));
            ceiling.position.y = config.ceilingY;
            scene.add(ceiling);
            globalAnchor = new THREE.Mesh(new THREE.TorusGeometry(0.12, 0.04, 8, 16), new THREE.MeshStandardMaterial({ color: 0x94a3b8, metalness: 1 }));
            globalAnchor.rotation.x = Math.PI/2;
            globalAnchor.position.set(0, config.ceilingY - 0.2, 0); 
            scene.add(globalAnchor);
        }

        function createPulleyGeometry() {
            const pts = [
                new THREE.Vector2(0, -0.11), new THREE.Vector2(0.45, -0.11), 
                new THREE.Vector2(0.45, -0.05), new THREE.Vector2(0.33, 0), 
                new THREE.Vector2(0.45, 0.05), new THREE.Vector2(0.45, 0.11), 
                new THREE.Vector2(0, 0.11)
            ];
            const geo = new THREE.LatheGeometry(pts, 32);
            geo.rotateX(Math.PI / 2);
            return geo;
        }

        function createBlock(num, isUpper) {
            const g = new THREE.Group();
            const zS = 0.55;
            const pGeo = createPulleyGeometry();
            const steelMat = new THREE.MeshStandardMaterial({ color: 0x64748b, metalness: 0.8, roughness: 0.3 });
            const list = [];
            const totalWidth = (num - 1) * zS;
            for (let i = 0; i < num; i++) {
                const p = new THREE.Mesh(pGeo, new THREE.MeshStandardMaterial({ color: 0x94a3b8, metalness: 1 }));
                p.position.z = (i * zS) - (totalWidth / 2);
                g.add(p);
                list.push(p);
            }
            const plateLeft = new THREE.Mesh(new THREE.BoxGeometry(1.0, 1.5, 0.05), steelMat);
            plateLeft.position.set(0, isUpper ? 0.35 : -0.35, - (totalWidth / 2) - 0.1);
            const plateRight = new THREE.Mesh(new THREE.BoxGeometry(1.0, 1.5, 0.05), steelMat);
            plateRight.position.set(0, isUpper ? 0.35 : -0.35, (totalWidth / 2) + 0.1);
            g.add(plateLeft, plateRight);
            const axle = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, totalWidth + 0.4, 16), steelMat);
            axle.rotation.x = Math.PI / 2;
            g.add(axle);
            if (!isUpper) {
                const bar = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.2, totalWidth + 0.25), steelMat);
                bar.position.set(0, -1.0, 0); g.add(bar);
                const supportRing = new THREE.Mesh(new THREE.TorusGeometry(0.18, 0.05, 8, 16), steelMat);
                supportRing.position.set(0, -1.3, 0); supportRing.rotation.y = Math.PI / 2; g.add(supportRing);
            } else {
                const ring = new THREE.Mesh(new THREE.TorusGeometry(0.15, 0.05, 8, 16), steelMat);
                ring.position.y = 1.1; g.add(ring);
            }
            return { group: g, pulleys: list };
        }

        function rebuildSystem() {
            if (fixedBlock) scene.remove(fixedBlock.group);
            if (movingBlock) scene.remove(movingBlock.group);
            if (weightBody) scene.remove(weightBody);
            if (knotMesh) scene.remove(knotMesh);
            if (slingMesh) scene.remove(slingMesh);

            const n = config.numPulleys, numF = Math.ceil(n / 2), numM = Math.floor(n / 2);
            fixedBlock = createBlock(numF, true);
            scene.add(fixedBlock.group);
            pulleys.fixed = fixedBlock.pulleys;

            if (numM > 0) {
                movingBlock = createBlock(numM, false);
                scene.add(movingBlock.group);
                pulleys.moving = movingBlock.pulleys;
            } else {
                movingBlock = null; pulleys.moving = [];
            }

            const wGroup = new THREE.Group();
            const wMat = new THREE.MeshStandardMaterial({ color: 0x2563eb, roughness: 0.4 });
            const steelMat = new THREE.MeshStandardMaterial({ color: 0x64748b, metalness: 0.8 });
            const body = new THREE.Mesh(new THREE.CylinderGeometry(0.8, 1.0, 1.8, 24), wMat);
            body.position.y = -1.6; 
            wGroup.add(body);
            const weightRing = new THREE.Mesh(new THREE.TorusGeometry(0.18, 0.05, 8, 16), steelMat);
            weightRing.rotation.y = Math.PI / 2; wGroup.add(weightRing);
            massLabelSprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: createTextTexture(`${config.mass} kg`), depthTest: false }));
            massLabelSprite.scale.set(2.8, 1.4, 1); massLabelSprite.position.set(0, -1.6, 1.15); wGroup.add(massLabelSprite);
            weightBody = wGroup; scene.add(weightBody);

            knotMesh = new THREE.Mesh(new THREE.TorusGeometry(0.08, 0.04, 8, 12), new THREE.MeshStandardMaterial({ color: 0xd97706 }));
            scene.add(knotMesh);
            slingMesh = new THREE.Mesh(new THREE.CylinderGeometry(0.04, 0.04, 1, 8), new THREE.MeshStandardMaterial({ color: 0xd97706 }));
            scene.add(slingMesh);

            updatePhysics();
            updateUI();
        }

        function getArcPoints(center, radius, z, startAngle, endAngle) {
            const pts = [];
            const segments = 24, diff = endAngle - startAngle;
            for (let i = 0; i <= segments; i++) {
                const a = startAngle + (i / segments) * diff;
                pts.push(new THREE.Vector3(center.x + Math.cos(a) * radius, center.y + Math.sin(a) * radius, center.z + z));
            }
            return pts;
        }

        function updatePhysics() {
            const maxD = 10.0, minD = 3.42, liftRange = maxD - minD; 
            const liftValue = (config.lift / 100) * liftRange;
            const vm = config.numPulleys === 1 ? 1 : config.numPulleys;
            const r_in = 0.33;

            fixedBlock.group.position.set(config.pulleyXOffset, config.ceilingY - 1.2, 0);
            const weightRingY = config.ceilingY - (maxD - liftValue);
            weightBody.position.set(config.pulleyXOffset, weightRingY, 0);
            
            if (movingBlock) {
                const sLen = 1.3; 
                movingBlock.group.position.set(config.pulleyXOffset, weightRingY + sLen, 0);
                slingMesh.position.set(config.pulleyXOffset, weightRingY + (sLen/2), 0);
                slingMesh.scale.y = sLen; slingMesh.visible = true;
            } else { if(slingMesh) slingMesh.visible = false; }

            const pts = [];
            const numM = pulleys.moving.length, hX = 0, zPull = pulleys.fixed[0] ? pulleys.fixed[0].position.z : 0;

            if (config.numPulleys === 1) {
                const wAnchor = new THREE.Vector3(weightBody.position.x, weightBody.position.y, zPull);
                knotMesh.position.copy(wAnchor); pts.push(wAnchor);
                pts.push(new THREE.Vector3(config.pulleyXOffset - r_in, config.ceilingY - 1.2, zPull));
                pts.push(new THREE.Vector3(config.pulleyXOffset + r_in, config.ceilingY - 1.2, zPull));
            } else {
                const lastIdxM = numM - 1;
                const anchorPos = new THREE.Vector3(0, config.ceilingY - 0.2, pulleys.moving[lastIdxM] ? pulleys.moving[lastIdxM].position.z : 0);
                globalAnchor.position.copy(anchorPos); knotMesh.position.copy(anchorPos); pts.push(anchorPos);
                for (let i = lastIdxM; i >= 0; i--) {
                    pts.push(new THREE.Vector3(config.pulleyXOffset - r_in, movingBlock.group.position.y, pulleys.moving[i].position.z));
                    pts.push(...getArcPoints(movingBlock.group.position, r_in, pulleys.moving[i].position.z, Math.PI, 2 * Math.PI));
                    if (pulleys.fixed[i]) {
                        pts.push(new THREE.Vector3(config.pulleyXOffset + r_in, fixedBlock.group.position.y, pulleys.fixed[i].position.z));
                        pts.push(...getArcPoints(fixedBlock.group.position, r_in, pulleys.fixed[i].position.z, 0, Math.PI));
                    }
                }
            }

            const exitX = config.pulleyXOffset - r_in;
            pts.push(new THREE.Vector3(exitX, config.ceilingY - 1.2, zPull));
            pts.push(new THREE.Vector3(hX, config.groundY + 0.05, zPull));
            pts.push(new THREE.Vector3(hX, config.groundY, zPull));

            const extraLen = liftValue * vm;
            if (extraLen > 0.05) {
                const baseR = 0.16, rGrow = 0.038, lH = 0.045, turnsLayer = 5;
                const b = (rGrow / (2 * Math.PI));
                const maxTh = (-baseR + Math.sqrt(baseR * baseR + 2 * b * extraLen)) / b;
                const segments = Math.floor(maxTh * 6) + 12;
                for (let i = 1; i <= segments; i++) {
                    const theta = (i / segments) * maxTh;
                    const numTurns = theta / (2 * Math.PI);
                    const layerIdx = Math.floor(numTurns / turnsLayer);
                    const currentRadius = baseR + (numTurns % turnsLayer) * rGrow;
                    pts.push(new THREE.Vector3(hX + Math.cos(theta) * currentRadius, config.groundY + (layerIdx * lH) + (theta * 0.001), zPull + Math.sin(theta) * currentRadius));
                }
            }

            handIndicator.position.set(hX, config.groundY + 0.1, zPull);

            if (ropeMesh) { scene.remove(ropeMesh); ropeMesh.geometry.dispose(); }
            if (pts.length > 1) {
                const curve = new THREE.CatmullRomCurve3(pts, false, 'catmullrom', 0.01);
                ropeMesh = new THREE.Mesh(new THREE.TubeGeometry(curve, Math.max(pts.length * 4, 450), config.ropeRadius, 8, false),
                                          new THREE.MeshStandardMaterial({ color: 0xd97706, roughness: 1 }));
                scene.add(ropeMesh);
            }
        }

        function updateUI() {
            const vm = config.numPulleys === 1 ? 1 : config.numPulleys;
            const force = (config.mass * GRAVITY) / vm;
            const maxD = 10.0, minD = 3.42, liftRange = maxD - minD;
            const currentDist = maxD - (config.lift / 100 * liftRange);
            const ropeDist = (config.lift / 100 * liftRange) * vm;

            document.getElementById('pulley-count-label').innerText = config.numPulleys;
            document.getElementById('pulley-x-label').innerText = config.pulleyXOffset.toFixed(1);
            document.getElementById('effort-kg-val').innerText = `${(config.mass / vm).toFixed(1)}kg`;
            document.getElementById('mass-label').innerText = `${config.mass} kg`;
            document.getElementById('force-val').innerText = `${force.toFixed(1)} N`;
            document.getElementById('vm-val').innerText = `${vm.toFixed(1)}x`;
            document.getElementById('dist-ceil-val').innerText = `${currentDist.toFixed(2)}m`;
            if (massLabelSprite) { 
                massLabelSprite.material.map.dispose(); 
                massLabelSprite.material.map = createTextTexture(`${config.mass} kg`); 
            }
        }

        function animate() { 
            requestAnimationFrame(animate); 
            if (controls) controls.update(); 
            renderer.render(scene, camera); 
        }

        window.addEventListener('resize', () => { 
            camera.aspect = window.innerWidth / window.innerHeight; 
            camera.updateProjectionMatrix(); 
            renderer.setSize(window.innerWidth, window.innerHeight); 
        });

        document.getElementById('pulley-count-range').addEventListener('input', (e) => { config.numPulleys = parseInt(e.target.value); config.lift = 0; rebuildSystem(); });
        document.getElementById('pulley-x-range').addEventListener('input', (e) => { config.pulleyXOffset = parseFloat(e.target.value); updatePhysics(); updateUI(); });
        document.getElementById('mass-range').addEventListener('input', (e) => { config.mass = parseInt(e.target.value); updateUI(); });
        document.getElementById('lift-range-hud').addEventListener('input', (e) => { config.lift = parseInt(e.target.value); updatePhysics(); updateUI(); });

        window.onload = init;
    </script>
</body>
</html>