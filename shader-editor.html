<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Editor GLSL Mobile - Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-glsl.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body, html {
            margin: 0; padding: 0; height: 100%; overflow: hidden;
            background: #1a1a1a;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        }

        .app-container {
            display: grid; grid-template-rows: 40% 60%; height: 100vh;
            background: #1a1a1a; transition: all 0.3s ease;
        }

        @media (min-width: 768px) {
            .app-container { grid-template-rows: 1fr; grid-template-columns: 1fr 1fr; }
        }

        /* Estilos de Tela Cheia Limpa */
        body.is-fullscreen #editor-container,
        body.is-fullscreen .ui-overlay,
        body.is-fullscreen .status-badge { 
            display: none !important; 
        }
        
        body.is-fullscreen .app-container { 
            grid-template-rows: 100% 0%; 
            grid-template-columns: 100% 0%; 
        }

        #canvas-container {
            position: relative; background: #000;
            display: flex; align-items: center; justify-content: center; overflow: hidden;
            cursor: pointer;
        }
        canvas { width: 100%; height: 100%; object-fit: contain; touch-action: none; }

        #editor-container {
            position: relative; background: #2d2d2d;
            border-top: 1px solid #444;
            display: flex; flex-direction: column; overflow: hidden;
        }

        #code-area { position: relative; flex-grow: 1; overflow: hidden; }

        #editing, #highlighting {
            margin: 0; padding: 20px;
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            border: none; outline: none;
            font-family: inherit !important;
            font-size: 14px !important;
            line-height: 22px !important; 
            tab-size: 4; white-space: pre;
            overflow-wrap: normal; box-sizing: border-box;
        }

        #editing {
            z-index: 1; color: transparent; background: transparent;
            caret-color: #60a5fa; resize: none;
            -webkit-text-fill-color: transparent; overflow: auto;
        }

        #highlighting { z-index: 0; pointer-events: none; overflow: hidden; background: #0d0d0d; }

        #error-log {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: rgba(185, 28, 28, 0.9); color: white;
            padding: 10px 20px; font-size: 12px; max-height: 30%;
            overflow-y: auto; display: none; z-index: 50;
        }

        .ui-overlay {
            position: absolute; top: 10px; right: 10px;
            display: flex; flex-direction: column; gap: 8px; z-index: 20;
        }

        .btn {
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2); color: white;
            padding: 8px 12px; border-radius: 6px; font-size: 11px;
            cursor: pointer; transition: all 0.2s; text-align: center;
            font-weight: bold; text-transform: uppercase;
        }
        .btn:hover { background: rgba(255, 255, 255, 0.2); }

        .status-badge {
            position: absolute; bottom: 10px; left: 10px;
            padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold;
            text-transform: uppercase;
        }

        /* Painel Lateral */
        #slots-panel {
            position: fixed; top: 0; right: -100%; width: 320px; height: 100%;
            background: #121212; border-left: 1px solid #333; z-index: 300;
            transition: right 0.3s ease; display: flex; flex-direction: column;
        }
        #slots-panel.open { right: 0; }

        .carousel-btn {
            background: #222; color: white; width: 24px; height: 24px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 4px; font-size: 14px; transition: 0.2s;
            border: 1px solid #444;
        }
        .carousel-btn:hover { background: #60a5fa; }
        .carousel-btn:active { transform: scale(0.9); }

        #toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #22c55e; color: white; padding: 10px 20px;
            border-radius: 20px; font-size: 13px; font-weight: bold;
            z-index: 500; display: none;
        }

        /* Área de Importação */
        #import-area {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #121212; z-index: 310; display: none; flex-direction: column;
            padding: 20px;
        }

        .slot-item {
            background: #1e1e1e; border: 1px solid #333; margin-bottom: 8px;
            border-radius: 6px; padding: 10px; display: flex; flex-direction: column; gap: 8px;
        }

        .slot-name-input { background: transparent; border: none; color: #fbbf24; font-weight: bold; width: 100%; outline: none; }
    </style>
</head>
<body id="body-root">

<div id="toast">Pronto!</div>
<div id="overlay" class="fixed inset-0 bg-black/50 z-[250] hidden" onclick="toggleSlots()"></div>

<!-- Painel de Gerenciamento -->
<div id="slots-panel">
    <div class="p-4 border-b border-white/10 flex justify-between items-center bg-black">
        <span class="text-xs font-bold uppercase text-zinc-500">Gerenciar Memória</span>
        <button onclick="toggleSlots()" class="text-zinc-500 text-xl">✕</button>
    </div>
    
    <div class="p-3 grid grid-cols-2 gap-2 border-b border-white/5">
        <button onclick="exportBackup()" class="py-2 text-[10px] bg-zinc-800 hover:bg-zinc-700 rounded uppercase font-bold text-zinc-300">Exportar JSON</button>
        <button onclick="showImportUI()" class="py-2 text-[10px] bg-zinc-800 hover:bg-zinc-700 rounded uppercase font-bold text-zinc-300">Importar JSON</button>
    </div>

    <div id="import-area">
        <div class="flex justify-between items-center mb-4">
            <span class="text-xs font-bold uppercase text-zinc-400">Colar Backup</span>
            <button onclick="hideImportUI()" class="text-zinc-500">Voltar</button>
        </div>
        <textarea id="import-input" class="flex-grow bg-black border border-white/10 p-3 rounded text-[10px] text-green-500 font-mono outline-none mb-4" placeholder='Cole o JSON aqui...'></textarea>
        <button onclick="processImport()" class="py-3 bg-green-700 hover:bg-green-600 text-white font-bold uppercase rounded text-xs">Confirmar</button>
    </div>

    <div class="flex-grow overflow-y-auto p-4" id="slots-list"></div>
</div>

<div class="app-container" id="app-root">
    <!-- Visualização -->
    <div id="canvas-container" onclick="handleCanvasClick()">
        <canvas id="gl-canvas"></canvas>
        <div class="ui-overlay">
            <button class="btn border-amber-500/50 text-amber-500" onclick="event.stopPropagation(); toggleSlots()">Slots (50)</button>
            <div class="h-px bg-white/10 my-1"></div>
            <button class="btn" onclick="event.stopPropagation(); togglePlay()" id="btn-play">Pausar</button>
            <button class="btn" onclick="event.stopPropagation(); handleFullscreen()" id="btn-fs">Resultado</button>
            <button class="btn" onclick="event.stopPropagation(); resetTime()">Reset Tempo</button>
            <button class="btn" onclick="event.stopPropagation(); copyCode()">Copiar Código</button>
        </div>
        <div id="status" class="status-badge bg-green-500 text-white">Ao Vivo</div>
    </div>

    <!-- Editor -->
    <div id="editor-container">
        <div class="flex items-center justify-between px-4 py-2 bg-neutral-800 border-b border-neutral-700">
            <div class="flex items-center gap-3">
                <span class="text-[10px] text-neutral-500 font-mono uppercase tracking-widest">Editor</span>
                <div class="flex items-center gap-1 bg-black/30 p-1 rounded-md border border-white/5">
                    <button class="carousel-btn" onclick="carouselNavigate(-1)">‹</button>
                    <span id="carousel-info" class="text-[9px] px-2 text-amber-500 font-bold min-w-[80px] text-center">Nenhum Slot</span>
                    <button class="carousel-btn" onclick="carouselNavigate(1)">›</button>
                </div>
            </div>
            <span id="cursor-pos" class="text-[10px] text-neutral-500 font-mono">Linha 1, Col 1</span>
        </div>
        
        <div id="code-area">
            <pre id="highlighting" aria-hidden="true"><code class="language-glsl" id="highlighting-content"></code></pre>
            <textarea id="editing" spellcheck="false" oninput="updateEditor(this.value); syncScroll(this);" onscroll="syncScroll(this);" onkeydown="handleKey(event)"></textarea>
        </div>
        <div id="error-log"></div>
    </div>
</div>

<script>
    const canvas = document.getElementById('gl-canvas');
    const gl = canvas.getContext('webgl2') || canvas.getContext('webgl');
    const isWebGL2 = gl instanceof WebGL2RenderingContext;
    const editing = document.getElementById('editing');
    const highlightingContent = document.getElementById('highlighting-content');
    const errorLog = document.getElementById('error-log');
    const statusBadge = document.getElementById('status');
    const cursorPos = document.getElementById('cursor-pos');
    const btnPlay = document.getElementById('btn-play');
    const btnFs = document.getElementById('btn-fs');
    const canvasContainer = document.getElementById('canvas-container');
    const bodyRoot = document.getElementById('body-root');
    const carouselInfo = document.getElementById('carousel-info');
    const importArea = document.getElementById('import-area');
    const importInput = document.getElementById('import-input');

    let program, positionBuffer;
    let startTime = Date.now(), pausedTime = 0, isPaused = false;
    let mouseX = 0, mouseY = 0;
    let currentSlotID = null;

    // Shader Inicial restaurado para a versão de 1:10pm
    const initialCode = `// Shader inicial
vec2 p = abs(FC.xy/r - .5);
o = p.xyxy / p.yxyx / vec4(3,6,9,1);
o = tanh(o + .1 * length(o));`;

    function wrapShader(code) {
        if (code.includes('void main')) return code;
        const header = isWebGL2 ? `#version 300 es
            precision highp float;
            uniform vec2 u_resolution, u_mouse;
            uniform float u_time;
            out vec4 outColor;
            #define FC gl_FragCoord
            #define r u_resolution
            #define t u_time
            #define m u_mouse
            #define o outColor
            #define PI 3.14159265
            vec3 hsv(float h,float s,float v){vec4 K=vec4(1.,2./3.,1./3.,3.);vec3 p=abs(fract(vec3(h)+K.xyz)*6.-K.www);return v*mix(K.xxx,clamp(p-K.xxx,0.,1.),s);}
            mat3 rotate3D(float a,vec3 v){float s=sin(a),c=cos(a),t=1.-c;return mat3(t*v.x*v.x+c,t*v.x*v.y-s*v.z,t*v.x*v.z+s*v.y,t*v.x*v.y+s*v.z,t*v.y*v.y+c,t*v.y*v.z-s*v.x,t*v.x*v.z-s*v.y,t*v.y*v.z+s*v.x,t*v.z*v.z+c);}
        ` : `
            precision highp float;
            uniform vec2 u_resolution, u_mouse;
            uniform float u_time;
            #define FC gl_FragCoord
            #define r u_resolution
            #define t u_time
            #define m u_mouse
            #define o gl_FragColor
            #define PI 3.14159265
            float tanh(float x){float e=exp(2.*x);return (e-1.)/(e+1.);}
            vec3 hsv(float h,float s,float v){vec4 K=vec4(1.,2./3.,1./3.,3.);vec3 p=abs(fract(vec3(h)+K.xyz)*6.-K.www);return v*mix(K.xxx,clamp(p-K.xxx,0.,1.),s);}
            mat3 rotate3D(float a,vec3 v){float s=sin(a),c=cos(a),t=1.-c;return mat3(t*v.x*v.x+c,t*v.x*v.y-s*v.z,t*v.x*v.z+s*v.y,t*v.x*v.y+s*v.z,t*v.y*v.y+c,t*v.y*v.z-s*v.x,t*v.x*v.z-s*v.y,t*v.y*v.z+s*v.x,t*v.z*v.z+c);}
        `;
        return `${header}\nvoid main(){\n  o=vec4(0,0,0,1);\n  ${code}\n  ${isWebGL2?'':'gl_FragColor=o;'}\n}`;
    }

    function initGL(source) {
        try {
            const fsSource = wrapShader(source);
            const vsSource = isWebGL2 ? `#version 300 es\nin vec4 position;void main(){gl_Position=position;}` : `attribute vec4 position;void main(){gl_Position=position;}`;
            const vs = createShader(gl, gl.VERTEX_SHADER, vsSource);
            const fs = createShader(gl, gl.FRAGMENT_SHADER, fsSource);
            const newProg = gl.createProgram();
            gl.attachShader(newProg, vs); gl.attachShader(newProg, fs);
            gl.linkProgram(newProg);
            if (!gl.getProgramParameter(newProg, gl.LINK_STATUS)) throw new Error(gl.getProgramInfoLog(newProg));
            program = newProg;
            errorLog.style.display = 'none';
            statusBadge.className = "status-badge bg-green-500 text-white";
            statusBadge.textContent = "Ao Vivo";
        } catch (e) { showError(e.message); }
    }

    function createShader(gl, type, src) {
        const s = gl.createShader(type); gl.shaderSource(s, src); gl.compileShader(s);
        if (!gl.getShaderParameter(s, gl.COMPILE_STATUS)) throw new Error(gl.getShaderInfoLog(s));
        return s;
    }

    function showError(m) { errorLog.textContent = m; errorLog.style.display = 'block'; statusBadge.className="status-badge bg-red-600 text-white"; statusBadge.textContent="Erro"; }

    function render() {
        if (!program || isPaused) { requestAnimationFrame(render); return; }
        const w = canvasContainer.clientWidth, h = canvasContainer.clientHeight;
        if (canvas.width !== w || canvas.height !== h) { canvas.width = w; canvas.height = h; }
        gl.viewport(0, 0, canvas.width, canvas.height);
        gl.clear(gl.COLOR_BUFFER_BIT);
        gl.useProgram(program);
        gl.uniform2f(gl.getUniformLocation(program, "u_resolution"), canvas.width, canvas.height);
        gl.uniform1f(gl.getUniformLocation(program, "u_time"), (Date.now() - startTime) / 1000.0);
        gl.uniform2f(gl.getUniformLocation(program, "u_mouse"), mouseX, mouseY);
        const posLoc = gl.getAttribLocation(program, "position");
        gl.enableVertexAttribArray(posLoc);
        if(!positionBuffer){
            positionBuffer = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
            gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]), gl.STATIC_DRAW);
        }
        gl.vertexAttribPointer(posLoc, 2, gl.FLOAT, false, 0, 0);
        gl.drawArrays(gl.TRIANGLES, 0, 6);
        requestAnimationFrame(render);
    }

    function updateEditor(v) { highlightingContent.textContent = v + (v.endsWith("\n")?" ":""); Prism.highlightElement(highlightingContent); initGL(v); updateCursorInfo(); }
    function syncScroll(el) { const p = document.getElementById('highlighting'); p.scrollTop = el.scrollTop; p.scrollLeft = el.scrollLeft; }
    function handleKey(e) { if(e.key==='Tab'){ e.preventDefault(); const s=editing.selectionStart, end=editing.selectionEnd; editing.value=editing.value.substring(0,s)+"    "+editing.value.substring(end); editing.selectionStart=editing.selectionEnd=s+4; updateEditor(editing.value); } }
    function updateCursorInfo() { const lines = editing.value.substring(0, editing.selectionStart).split('\n'); cursorPos.textContent = `Linha ${lines.length}, Col ${lines[lines.length-1].length+1}`; }

    // --- CARROSSEL E MEMÓRIA ---
    function getUsedSlots() {
        const data = JSON.parse(localStorage.getItem('glsl_slots_v2') || '{}');
        return Object.keys(data).filter(k => data[k].code && data[k].code.trim() !== "").sort((a, b) => parseInt(a) - parseInt(b));
    }

    function updateCarouselLabel() {
        const data = JSON.parse(localStorage.getItem('glsl_slots_v2') || '{}');
        if (currentSlotID && data[currentSlotID]) {
            carouselInfo.textContent = data[currentSlotID].name || `Slot #${currentSlotID}`;
        } else {
            carouselInfo.textContent = "Sem Slot";
        }
    }

    function carouselNavigate(dir) {
        const used = getUsedSlots();
        if (used.length === 0) { showToast("Nenhum slot"); return; }
        let index = used.indexOf(String(currentSlotID));
        if (index === -1) index = dir > 0 ? -1 : 0;
        let nextIndex = (index + dir + used.length) % used.length;
        loadSlot(used[nextIndex]);
    }

    function toggleSlots() {
        const isOpen = document.getElementById('slots-panel').classList.toggle('open');
        document.getElementById('overlay').classList.toggle('hidden', !isOpen);
        if(isOpen) { renderSlots(); hideImportUI(); }
    }

    function renderSlots() {
        const list = document.getElementById('slots-list'); list.innerHTML = '';
        const data = JSON.parse(localStorage.getItem('glsl_slots_v2') || '{}');
        for(let i=1; i<=50; i++) {
            const s = data[i], div = document.createElement('div');
            div.className = 'slot-item';
            div.innerHTML = `
                <input type="text" class="slot-name-input" value="${s?.name || 'Slot #'+i}" onblur="renameSlot(${i}, this.value)">
                <div class="flex gap-2">
                    <button class="flex-1 py-2 bg-green-900/30 text-green-400 text-[9px] font-bold rounded" onclick="saveSlot(${i})">Gravar</button>
                    <button class="flex-1 py-2 bg-blue-900/30 text-blue-400 text-[9px] font-bold rounded ${!s?'opacity-20':''}" onclick="loadSlot(${i})" ${!s?'disabled':''}>Ler</button>
                </div>`;
            list.appendChild(div);
        }
    }

    function saveSlot(id) {
        const data = JSON.parse(localStorage.getItem('glsl_slots_v2') || '{}');
        const inputs = document.querySelectorAll('.slot-name-input');
        const name = inputs[id-1].value;
        data[id] = { code: editing.value, date: new Date().toLocaleString(), name: name };
        localStorage.setItem('glsl_slots_v2', JSON.stringify(data));
        currentSlotID = id;
        updateCarouselLabel();
        showToast(`Slot ${id} salvo!`);
        renderSlots();
    }

    function loadSlot(id) {
        const data = JSON.parse(localStorage.getItem('glsl_slots_v2') || '{}');
        if(data[id]) {
            editing.value = data[id].code;
            currentSlotID = id;
            updateCarouselLabel();
            updateEditor(editing.value);
            showToast(`Carregado: ${data[id].name || id}`);
        }
    }

    function renameSlot(id, name) {
        const data = JSON.parse(localStorage.getItem('glsl_slots_v2') || '{}');
        if(!data[id]) data[id] = { code: "", date: "", name: name }; else data[id].name = name;
        localStorage.setItem('glsl_slots_v2', JSON.stringify(data));
        updateCarouselLabel();
    }

    function exportBackup() {
        const data = localStorage.getItem('glsl_slots_v2');
        const dummy = document.createElement("textarea"); document.body.appendChild(dummy);
        dummy.value = data || "{}"; dummy.select(); document.execCommand("copy");
        document.body.removeChild(dummy); showToast("JSON copiado!");
    }

    function showImportUI() { importArea.style.display = 'flex'; importInput.value = ''; importInput.focus(); }
    function hideImportUI() { importArea.style.display = 'none'; }
    function processImport() {
        const json = importInput.value.trim();
        if(!json) return;
        try { 
            JSON.parse(json); localStorage.setItem('glsl_slots_v2', json); 
            showToast("Backup Restaurado!"); renderSlots(); updateCarouselLabel(); hideImportUI();
        } catch(e) { showToast("JSON Inválido!"); }
    }

    function showToast(m) { const t = document.getElementById('toast'); t.textContent = m; t.style.display='block'; setTimeout(()=>t.style.display='none', 2000); }
    function togglePlay() { isPaused = !isPaused; btnPlay.textContent = isPaused ? 'Retomar' : 'Pausar'; if(!isPaused) startTime = Date.now()-pausedTime; else pausedTime = Date.now()-startTime; }
    
    function handleFullscreen() {
        if (!document.fullscreenElement) {
            canvasContainer.requestFullscreen().catch(() => {
                bodyRoot.classList.add('is-fullscreen');
            });
        } else {
            document.exitFullscreen();
        }
    }

    function handleCanvasClick() {
        const isManualFs = bodyRoot.classList.contains('is-fullscreen');
        if (document.fullscreenElement || isManualFs) {
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                bodyRoot.classList.remove('is-fullscreen');
                setTimeout(resizeCanvas, 100);
            }
        }
    }

    function resetTime() { startTime = Date.now(); pausedTime = 0; }
    function copyCode() { const dummy = document.createElement("textarea"); document.body.appendChild(dummy); dummy.value = editing.value; dummy.select(); document.execCommand("copy"); document.body.removeChild(dummy); showToast("Código Copiado!"); }

    document.addEventListener('fullscreenchange', () => {
        const fs = !!document.fullscreenElement;
        bodyRoot.classList.toggle('is-fullscreen', fs);
        setTimeout(resizeCanvas, 100);
    });

    canvas.addEventListener('mousemove', e => { const r = canvas.getBoundingClientRect(); mouseX = e.clientX-r.left; mouseY = r.height-(e.clientY-r.top); });
    canvas.addEventListener('touchmove', e => { const r = canvas.getBoundingClientRect(); mouseX = e.touches[0].clientX-r.left; mouseY = r.height-(e.touches[0].clientY-r.top); e.preventDefault(); }, {passive:false});

    window.onload = () => { editing.value = initialCode; updateEditor(initialCode); render(); updateCarouselLabel(); };
</script>

</body>
</html>
