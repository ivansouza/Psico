<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pacote de Onda Gaussiano Interativo</title>
    <style>
        body { margin: 0; overflow: hidden; background: #050505; font-family: 'Segoe UI', Roboto, sans-serif; }
        canvas { display: block; }
        
        /* Bot√£o de Engrenagem */
        #settings-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 44px;
            height: 44px;
            background: rgba(30, 30, 35, 0.9);
            border: 1px solid #555;
            border-radius: 50%;
            color: #fff;
            font-size: 22px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            user-select: none;
        }
        #settings-btn:hover {
            background: #00ffff;
            color: #000;
            transform: rotate(90deg) scale(1.1);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.4);
        }

        /* Painel de Configura√ß√µes */
        #ui-container {
            position: absolute;
            top: 75px;
            left: 20px;
            width: 320px;
            color: #e0e0e0;
            background: rgba(18, 18, 24, 0.95);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #444;
            backdrop-filter: blur(12px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.7);
            
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
            pointer-events: none;
            transition: all 0.3s ease-out;
            z-index: 99;
            max-height: 80vh;
            overflow-y: auto;
        }

        #ui-container.visible {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: auto;
        }

        /* Tipografia e Layout do Painel */
        h1 { margin: 0 0 15px 0; font-size: 1.1rem; color: #00ffff; border-bottom: 1px solid #333; padding-bottom: 10px; font-weight: 600; letter-spacing: 0.5px; }
        
        .math-eq {
            font-family: 'Courier New', monospace;
            background: #000;
            padding: 10px;
            border-radius: 6px;
            color: #0f0;
            border: 1px solid #333;
            text-align: center;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        /* Sliders Customizados */
        .control-group { margin-bottom: 15px; }
        .control-group label { display: flex; justify-content: space-between; font-size: 0.85rem; color: #aaa; margin-bottom: 5px; }
        .control-group span { color: #fff; font-weight: bold; }
        
        input[type=range] {
            width: 100%;
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 14px;
            width: 14px;
            border-radius: 50%;
            background: #00ffff;
            cursor: pointer;
            margin-top: -5px;
            box-shadow: 0 0 5px rgba(0,255,255,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #444;
            border-radius: 2px;
        }

        /* Bot√µes */
        .btn-row { display: flex; gap: 10px; margin-top: 20px; }
        
        button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.2s;
            text-transform: uppercase;
        }

        .btn-primary { background: #2a2a35; color: white; border: 1px solid #555; }
        .btn-primary:hover { background: #00ffff; color: #000; }
        
        .btn-stack { display: flex; flex-direction: column; gap: 8px; margin-top: 15px; }

        .btn-save { background: #1a441a; color: #4caf50; border: 1px solid #2e7d32; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px;}
        .btn-save:hover { background: #2e7d32; color: #fff; }
        
        .btn-copy { background: #1a3c44; color: #4dd0e1; border: 1px solid #0097a7; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px;}
        .btn-copy:hover { background: #0097a7; color: #fff; }

        button:active { transform: scale(0.98); }

        /* Legenda */
        .legend { margin-top: 15px; font-size: 0.8rem; border-top: 1px solid #333; padding-top: 15px; }
        .item { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; color: #ccc; }
        .color-box { width: 12px; height: 12px; border-radius: 3px; }

        /* Labels Flutuantes */
        .axis-label {
            position: absolute;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 700;
            font-size: 13px;
            pointer-events: none;
            user-select: none;
            text-shadow: 0 2px 4px #000;
            background: rgba(0,0,0,0.6);
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.1);
            white-space: nowrap;
        }

        /* Instru√ß√µes de Rodap√© */
        .instructions {
            position: absolute;
            bottom: 15px;
            width: 100%;
            text-align: center;
            color: rgba(255, 255, 255, 0.4);
            font-size: 12px;
            pointer-events: none;
            user-select: none;
            font-family: 'Segoe UI', sans-serif;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            letter-spacing: 0.5px;
        }
    </style>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

<!-- Bot√£o Engrenagem -->
<div id="settings-btn" title="Configura√ß√µes">‚öôÔ∏è</div>

<!-- Painel de Configura√ß√µes -->
<div id="ui-container">
    <h1>Configura√ß√£o da Onda</h1>
    <div class="math-eq">œà(t) = A¬∑e<sup>-Œ≥t¬≤</sup> ¬∑ e<sup>iœât</sup></div>

    <!-- Controles -->
    <div class="control-group">
        <label>Amplitude (A): <span id="val-amp">3.5</span></label>
        <input type="range" id="inp-amp" min="1.0" max="6.0" step="0.1" value="3.5">
    </div>

    <div class="control-group">
        <label>Frequ√™ncia (œâ): <span id="val-omega">2.5</span></label>
        <input type="range" id="inp-omega" min="0.5" max="8.0" step="0.1" value="2.5">
    </div>

    <div class="control-group">
        <label>Largura do Pacote (Œ≥): <span id="val-gamma">0.04</span></label>
        <input type="range" id="inp-gamma" min="0.01" max="0.15" step="0.005" value="0.04">
    </div>

    <div class="btn-row">
        <button class="btn-primary" id="btn-pause">Pausar</button>
        <button class="btn-primary" id="btn-reset">Reiniciar</button>
    </div>

    <div class="btn-stack">
        <button class="btn-save" id="btn-save">
            <span>üíæ</span> Guardar Estado
        </button>
        <button class="btn-copy" id="btn-copy">
            <span>üìã</span> Copiar JSON
        </button>
    </div>
    
    <div class="legend">
        <div class="item"><div class="color-box" style="background: #00ffff;"></div><span>Onda Complexa (3D)</span></div>
        <div class="item"><div class="color-box" style="background: #ff00ff;"></div><span>Parte Real (Proje√ß√£o)</span></div>
        <div class="item"><div class="color-box" style="background: #00ff00;"></div><span>Parte Imagin√°ria (Proje√ß√£o)</span></div>
    </div>
</div>

<div id="labels-container"></div>

<!-- Instru√ß√µes de Navega√ß√£o -->
<div class="instructions">
    Rota√ß√£o: Clique Esq. | Zoom: Scroll | Mover: Clique Dir.
</div>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    // --- Configura√ß√£o Inicial (Atualizada) ---
    const defaultParams = {
        gamma: 0.04,
        omega: 2.5,
        tMin: -25,
        tMax: 25,
        resolution: 1500,
        amplitude: 3.5,
        offset: 5.5
    };

    let params = { ...defaultParams };

    // Elementos DOM
    const ui = {
        container: document.getElementById('ui-container'),
        btnSettings: document.getElementById('settings-btn'),
        inpAmp: document.getElementById('inp-amp'),
        inpOmega: document.getElementById('inp-omega'),
        inpGamma: document.getElementById('inp-gamma'),
        valAmp: document.getElementById('val-amp'),
        valOmega: document.getElementById('val-omega'),
        valGamma: document.getElementById('val-gamma'),
        btnPause: document.getElementById('btn-pause'),
        btnReset: document.getElementById('btn-reset'),
        btnSave: document.getElementById('btn-save'),
        btnCopy: document.getElementById('btn-copy'),
    };

    let isMenuVisible = false;

    // --- Three.js Setup ---
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x050505);
    scene.fog = new THREE.FogExp2(0x050505, 0.015);

    const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
    
    // POSI√á√ÉO DA C√ÇMARA INICIAL
    camera.position.set(20.16, 13.58, -38.52);

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    document.body.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    // TARGET INICIAL
    controls.target.set(0, 0, 0);

    // --- Gerenciamento de Geometria ---
    
    let waveMesh, lineReal, lineImag, gridReal, gridImag;
    let points3D = [], pointsReal = [], pointsImag = [];

    function updateWaveGeometry() {
        // Remover geometrias antigas
        if (waveMesh) {
            waveMesh.geometry.dispose();
            scene.remove(waveMesh);
        }
        if (lineReal) {
            lineReal.geometry.dispose();
            scene.remove(lineReal);
        }
        if (lineImag) {
            lineImag.geometry.dispose();
            scene.remove(lineImag);
        }
        if (gridReal) scene.remove(gridReal);
        if (gridImag) scene.remove(gridImag);

        points3D = [];
        pointsReal = [];
        pointsImag = [];

        // Atualizar offsets de parede baseados na amplitude para evitar sobreposi√ß√£o
        const dynamicOffset = params.amplitude + 2.0;
        const floorY = -dynamicOffset;
        const wallX = -dynamicOffset;

        // Recalcular pontos
        for (let i = 0; i <= params.resolution; i++) {
            const t = params.tMin + (params.tMax - params.tMin) * (i / params.resolution);
            
            const envelope = params.amplitude * Math.exp(-params.gamma * t * t);
            const real = envelope * Math.cos(params.omega * t);
            const imag = envelope * Math.sin(params.omega * t);
            
            const p = new THREE.Vector3(real, imag, t);
            points3D.push(p);
            pointsReal.push(new THREE.Vector3(p.x, floorY, p.z));
            pointsImag.push(new THREE.Vector3(wallX, p.y, p.z));
        }

        // Criar Tubo Principal
        const curvePath = new THREE.CatmullRomCurve3(points3D);
        const tubeGeo = new THREE.TubeGeometry(curvePath, 800, 0.08, 8, false);
        const tubeMat = new THREE.MeshBasicMaterial({ color: 0x00ffff });
        waveMesh = new THREE.Mesh(tubeGeo, tubeMat);
        scene.add(waveMesh);

        // Criar Linhas de Proje√ß√£o
        lineReal = new THREE.Line(
            new THREE.BufferGeometry().setFromPoints(pointsReal),
            new THREE.LineBasicMaterial({ color: 0xff00ff, opacity: 0.6, transparent: true })
        );
        scene.add(lineReal);

        lineImag = new THREE.Line(
            new THREE.BufferGeometry().setFromPoints(pointsImag),
            new THREE.LineBasicMaterial({ color: 0x00ff00, opacity: 0.6, transparent: true })
        );
        scene.add(lineImag);

        // Atualizar Grids para acompanhar as paredes
        const gridColor = 0x333333;
        const subGridColor = 0x111111;
        
        gridReal = new THREE.GridHelper(60, 30, gridColor, subGridColor);
        gridReal.position.y = floorY;
        scene.add(gridReal);

        gridImag = new THREE.GridHelper(60, 30, gridColor, subGridColor);
        gridImag.rotation.z = Math.PI / 2;
        gridImag.position.x = wallX;
        scene.add(gridImag);

        // Atualizar posi√ß√µes dos labels no objeto global (usado no animate)
        labelPositions.floorY = floorY;
        labelPositions.wallX = wallX;
    }

    // --- Elementos Din√¢micos (Slicer) ---
    const slicerGroup = new THREE.Group();
    scene.add(slicerGroup);

    const arrowHelper = new THREE.ArrowHelper(new THREE.Vector3(1, 0, 0), new THREE.Vector3(0, 0, 0), 1, 0xffff00);
    slicerGroup.add(arrowHelper);

    // Plano Slicer (agora reativo ao tamanho)
    let slicerPlane;
    function updateSlicerPlane() {
        if(slicerPlane) {
            slicerPlane.geometry.dispose();
            slicerGroup.remove(slicerPlane);
        }
        const size = (params.amplitude + 2.0) * 2.2;
        slicerPlane = new THREE.Mesh(
            new THREE.PlaneGeometry(size, size),
            new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.03, side: THREE.DoubleSide, depthWrite: false })
        );
        slicerGroup.add(slicerPlane);
    }

    const sphereGeo = new THREE.SphereGeometry(0.2, 16, 16);
    const pointMain = new THREE.Mesh(sphereGeo, new THREE.MeshBasicMaterial({ color: 0xffff00 }));
    slicerGroup.add(pointMain);
    
    const pointReal = new THREE.Mesh(sphereGeo, new THREE.MeshBasicMaterial({ color: 0xff00ff }));
    scene.add(pointReal);
    
    const pointImag = new THREE.Mesh(sphereGeo, new THREE.MeshBasicMaterial({ color: 0x00ff00 }));
    scene.add(pointImag);

    // Eixo Tempo
    const timeAxisGeo = new THREE.BufferGeometry().setFromPoints([
        new THREE.Vector3(0, 0, params.tMin), new THREE.Vector3(0, 0, params.tMax)
    ]);
    scene.add(new THREE.Line(timeAxisGeo, new THREE.LineBasicMaterial({ color: 0x555555, dashed: true })));


    // --- Labels HTML ---
    const labelPositions = { floorY: -5.5, wallX: -5.5 }; // Valores iniciais
    const labels = {
        real: { el: document.createElement('div'), text: 'Re' },
        imag: { el: document.createElement('div'), text: 'Im' },
        time: { el: document.createElement('div'), text: 'Tempo (t)' }
    };

    const labelContainer = document.getElementById('labels-container');
    Object.values(labels).forEach(l => {
        l.el.className = 'axis-label';
        l.el.textContent = l.text;
        labelContainer.appendChild(l.el);
    });

    // --- L√≥gica de Carregamento e Salvamento ---

    function getStateObject() {
        return {
            params: params,
            camera: { 
                x: parseFloat(camera.position.x.toFixed(2)), 
                y: parseFloat(camera.position.y.toFixed(2)), 
                z: parseFloat(camera.position.z.toFixed(2)) 
            },
            target: { 
                x: parseFloat(controls.target.x.toFixed(2)), 
                y: parseFloat(controls.target.y.toFixed(2)), 
                z: parseFloat(controls.target.z.toFixed(2)) 
            }
        };
    }

    function loadState() {
        const savedData = localStorage.getItem('waveSimState');
        if (savedData) {
            try {
                const state = JSON.parse(savedData);
                
                // Carregar Params
                if (state.params) {
                    params = { ...defaultParams, ...state.params };
                    // Atualizar UI
                    ui.inpAmp.value = params.amplitude;
                    ui.valAmp.textContent = params.amplitude;
                    ui.inpOmega.value = params.omega;
                    ui.valOmega.textContent = params.omega;
                    ui.inpGamma.value = params.gamma;
                    ui.valGamma.textContent = params.gamma;
                }

                // Carregar C√¢mera
                if (state.camera) {
                    camera.position.set(state.camera.x, state.camera.y, state.camera.z);
                    controls.target.set(state.target.x, state.target.y, state.target.z);
                    controls.update();
                }
                
                console.log("Estado carregado com sucesso!");
            } catch (e) {
                console.error("Erro ao carregar estado salvo", e);
            }
        }
    }

    function saveState() {
        const state = getStateObject();
        localStorage.setItem('waveSimState', JSON.stringify(state));
        
        // Feedback visual no bot√£o
        const originalText = ui.btnSave.innerHTML;
        ui.btnSave.innerHTML = "<span>‚úÖ</span> Salvo!";
        ui.btnSave.style.background = "#2e7d32";
        setTimeout(() => {
            ui.btnSave.innerHTML = originalText;
            ui.btnSave.style.background = "";
        }, 1500);
    }

    function copyState() {
        const state = getStateObject();
        const jsonString = JSON.stringify(state, null, 2);

        // M√©todo de c√≥pia para iframes (fallback robusto)
        const textarea = document.createElement('textarea');
        textarea.value = jsonString;
        document.body.appendChild(textarea);
        textarea.select();
        
        try {
            document.execCommand('copy');
            
            // Feedback
            const originalText = ui.btnCopy.innerHTML;
            ui.btnCopy.innerHTML = "<span>‚úÖ</span> Copiado!";
            ui.btnCopy.style.background = "#006064";
            setTimeout(() => {
                ui.btnCopy.innerHTML = originalText;
                ui.btnCopy.style.background = "";
            }, 1500);
            
        } catch (err) {
            console.error('Falha ao copiar', err);
            ui.btnCopy.innerHTML = "<span>‚ùå</span> Erro";
        }
        
        document.body.removeChild(textarea);
    }

    // --- Inicializa√ß√£o ---
    
    // Atualiza a geometria e UI com os par√¢metros padr√£o atuais
    ui.inpAmp.value = params.amplitude;
    ui.valAmp.textContent = params.amplitude;
    ui.inpOmega.value = params.omega;
    ui.valOmega.textContent = params.omega;
    ui.inpGamma.value = params.gamma;
    ui.valGamma.textContent = params.gamma;
    
    updateWaveGeometry();
    updateSlicerPlane();

    // --- Event Listeners UI ---

    function handleParamChange() {
        params.amplitude = parseFloat(ui.inpAmp.value);
        params.omega = parseFloat(ui.inpOmega.value);
        params.gamma = parseFloat(ui.inpGamma.value);

        ui.valAmp.textContent = params.amplitude.toFixed(1);
        ui.valOmega.textContent = params.omega.toFixed(1);
        ui.valGamma.textContent = params.gamma.toFixed(3);

        updateWaveGeometry();
        updateSlicerPlane();
    }

    ui.inpAmp.addEventListener('input', handleParamChange);
    ui.inpOmega.addEventListener('input', handleParamChange);
    ui.inpGamma.addEventListener('input', handleParamChange);
    
    ui.btnSave.addEventListener('click', saveState);
    ui.btnCopy.addEventListener('click', copyState);

    ui.btnSettings.addEventListener('click', (e) => {
        e.stopPropagation();
        isMenuVisible = !isMenuVisible;
        if (isMenuVisible) {
            ui.container.classList.add('visible');
            ui.btnSettings.style.transform = "rotate(90deg)";
            ui.btnSettings.style.background = "#00ffff";
            ui.btnSettings.style.color = "#000";
        } else {
            ui.container.classList.remove('visible');
            ui.btnSettings.style.transform = "rotate(0deg)";
            ui.btnSettings.style.background = "";
            ui.btnSettings.style.color = "";
        }
    });

    let isPaused = false;
    let time = params.tMin;
    const timeSpeed = 0.08;

    ui.btnPause.addEventListener('click', () => {
        isPaused = !isPaused;
        ui.btnPause.textContent = isPaused ? "Resumir" : "Pausar";
        ui.btnPause.style.background = isPaused ? "#ff9800" : "";
    });

    ui.btnReset.addEventListener('click', () => {
        time = params.tMin;
        isPaused = false;
        ui.btnPause.textContent = "Pausar";
        ui.btnPause.style.background = "";
    });

    // --- Animation Loop ---
    
    function animate() {
        requestAnimationFrame(animate);
        controls.update();

        if (!isPaused) {
            time += timeSpeed;
            if (time > params.tMax) time = params.tMin;
        }

        // 1. Atualizar posi√ß√£o Z
        slicerGroup.position.z = time;

        // 2. Calcular fasor atual
        const envelope = params.amplitude * Math.exp(-params.gamma * time * time);
        const real = envelope * Math.cos(params.omega * time);
        const imag = envelope * Math.sin(params.omega * time);

        const localVec = new THREE.Vector3(real, imag, 0);
        const len = localVec.length();

        if (len > 0.001) {
            arrowHelper.setDirection(localVec.normalize());
            arrowHelper.setLength(len);
        } else {
            arrowHelper.setLength(0.001); // Evitar erros de escala zero
        }

        // 3. Atualizar Esferas
        pointMain.position.set(real, imag, 0); // Local
        pointReal.position.set(real, labelPositions.floorY, time); // Global
        pointImag.position.set(labelPositions.wallX, imag, time); // Global

        // 4. Atualizar Labels
        updateLabels(real, imag);

        renderer.render(scene, camera);
    }

    function updateLabels(currentReal, currentImag) {
        const widthHalf = window.innerWidth / 2;
        const heightHalf = window.innerHeight / 2;

        // Posi√ß√µes ideais para os labels
        const posReal = new THREE.Vector3(params.amplitude + 1, labelPositions.floorY, 0);
        const posImag = new THREE.Vector3(labelPositions.wallX, params.amplitude + 1, 0);
        const posTime = new THREE.Vector3(0, 0, params.tMax + 2);

        function projectAndSet(obj, pos3D) {
            const v = pos3D.clone().project(camera);
            if (v.z < 1) {
                obj.el.style.display = 'block';
                const x = (v.x * widthHalf) + widthHalf;
                const y = -(v.y * heightHalf) + heightHalf;
                obj.el.style.transform = `translate(-50%, -50%) translate(${x}px, ${y}px)`;
                obj.el.style.left = '0'; obj.el.style.top = '0';
            } else {
                obj.el.style.display = 'none';
            }
        }

        projectAndSet(labels.real, posReal);
        projectAndSet(labels.imag, posImag);
        projectAndSet(labels.time, posTime);
    }

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    animate();

</script>
</body>
</html>