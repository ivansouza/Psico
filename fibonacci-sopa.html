<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ensopado Perpétuo de Fibonacci 3D</title>
    
    <!-- Bibliotecas 3D -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    <!-- Configuração e Carregamento do MathJax para fórmulas LaTeX -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            options: {
                enableMenu: false
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        :root {
            --primary: #ff3333;
            --soup-green: #2ecc71;
            --bg-glass: rgba(15, 15, 15, 0.9);
            --accent: #ffcc00;
        }

        body { 
            margin: 0; 
            overflow: hidden; 
            background: #000; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            touch-action: none;
        }

        /* Título Superior */
        #main-header {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 50;
            text-align: center;
            width: 100%;
            pointer-events: none;
        }

        #main-header h1 {
            margin: 0;
            color: white;
            font-size: 1.4em;
            text-transform: uppercase;
            letter-spacing: 3px;
            font-weight: 900;
            text-shadow: 0 0 15px rgba(255, 51, 51, 0.6);
            opacity: 0.9;
        }

        /* Rodapé com Texto da Imagem Original */
        #original-text-footer {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 50;
            text-align: center;
            width: 100%;
            pointer-events: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.75em;
            line-height: 1.6;
            letter-spacing: 0.5px;
        }

        #original-text-footer b { color: rgba(255, 255, 255, 0.85); font-weight: 600; }
        #original-text-footer .formula { display: block; margin-top: 4px; color: var(--soup-green); }

        @media (max-width: 600px) {
            #main-header h1 { font-size: 1em; letter-spacing: 1px; padding: 0 60px; }
            #original-text-footer { font-size: 0.65em; bottom: 15px; padding: 0 20px; box-sizing: border-box; }
        }

        /* Botão de Engrenagem (Configurações) */
        #settings-trigger {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 45px;
            height: 45px;
            background: var(--primary);
            border: 2px solid white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 200;
            color: white;
            box-shadow: 0 0 20px rgba(255, 51, 51, 0.5);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* Painel Lateral */
        #interface {
            position: absolute;
            top: 75px;
            right: 20px;
            background: var(--bg-glass);
            color: white;
            padding: 16px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 280px;
            max-width: calc(100vw - 40px);
            pointer-events: auto;
            backdrop-filter: blur(15px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            display: none;
            z-index: 150;
        }

        #interface.visible { display: block; }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 8px;
        }

        h2 { color: var(--primary); margin: 0; font-size: 0.85em; text-transform: uppercase; letter-spacing: 1px; font-weight: 800; }

        #help-btn {
            background: var(--accent);
            border: none;
            color: #000;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control { margin-bottom: 14px; }
        label { display: flex; justify-content: space-between; font-size: 0.65em; margin-bottom: 6px; color: #bbb; text-transform: uppercase; }
        .value-display { color: #fff; font-weight: bold; font-family: monospace; font-size: 1em; }
        .soup-value { color: var(--soup-green) !important; }

        input[type="range"] { 
            width: 100%; accent-color: var(--primary); height: 5px; background: rgba(255,255,255,0.1); border-radius: 3px; appearance: none; outline: none;
        }

        .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .actions-full { display: block; margin-top: 10px; }
        
        button.action-btn { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 10px; border-radius: 10px; cursor: pointer; font-size: 0.8em; font-weight: 700; width: 100%; transition: 0.2s; }
        button.primary { background: var(--primary); border: none; }
        button.export { background: #3498db; border: none; }

        /* Modal de Ajuda com Scroll */
        #help-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92);
            display: none;
            z-index: 300;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(15px);
        }

        .modal-content {
            background: #111;
            border: 2px solid var(--primary);
            border-radius: 24px;
            width: 92%;
            max-width: 600px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(255, 51, 51, 0.3);
        }

        .modal-header {
            padding: 20px;
            background: #181818;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 { margin: 0; color: var(--primary); text-transform: uppercase; letter-spacing: 2px; font-size: 1.1em; }

        .modal-body {
            padding: 25px;
            overflow-y: auto;
            color: #ddd;
            font-size: 0.95em;
            line-height: 1.7;
        }

        .modal-body::-webkit-scrollbar { width: 8px; }
        .modal-body::-webkit-scrollbar-track { background: #000; }
        .modal-body::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 4px; }

        .modal-body h4 { color: var(--primary); margin: 25px 0 10px 0; border-left: 3px solid var(--primary); padding-left: 10px; }
        .modal-body p { margin-bottom: 15px; text-align: justify; }
        
        .formula-box {
            background: #000;
            padding: 15px;
            border-radius: 12px;
            margin: 20px 0;
            border: 1px solid #222;
            text-align: center;
            font-size: 1.15em;
            color: #fff;
        }

        .modal-footer { padding: 15px; background: #181818; border-top: 1px solid #333; }

        #close-modal {
            background: var(--primary);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 12px;
            width: 100%;
            cursor: pointer;
            font-weight: 800;
            font-size: 1em;
            text-transform: uppercase;
        }

        #toast {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: white; color: black; padding: 10px 24px; border-radius: 30px; font-size: 0.85em; font-weight: bold;
            opacity: 0; transition: 0.4s; pointer-events: none; z-index: 1000;
            white-space: nowrap;
        }
    </style>
</head>
<body>

<header id="main-header">
    <h1>Ensopado perpétuo de Fibonacci</h1>
</header>

<div id="original-text-footer">
    <b>Especial de Hoje:</b> Ensopado perpétuo de Fibonacci<br>
    <b>Ingredientes:</b> Ensopado de Ontem e Ensopado de Anteontem
    <span class="formula">$F(n) = F(n-1) + F(n-2)$</span>
</div>

<div id="settings-trigger" title="Configurações">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
    </svg>
</div>

<div id="interface">
    <div class="header">
        <h2>Painel de Controle</h2>
        <button id="help-btn">?</button>
    </div>
    
    <div class="control">
        <label>Grãos Tigela <span class="value-display" id="val-points">3263</span></label>
        <input type="range" id="points" min="100" max="8000" value="3263">
    </div>
    
    <div class="control">
        <label>Nível Sopa <span class="value-display soup-value" id="val-soupLevel">69%</span></label>
        <input type="range" id="soupLevel" min="0" max="100" value="69">
    </div>

    <div class="control">
        <label>Curvatura <span class="value-display" id="val-curvature">0.6</span></label>
        <input type="range" id="curvature" min="0.1" max="2.5" step="0.1" value="0.6">
    </div>
    
    <div class="control">
        <label>Escala Grão <span class="value-display" id="val-thickness">0.15</span></label>
        <input type="range" id="thickness" min="0.02" max="0.5" step="0.01" value="0.15">
    </div>

    <div class="actions">
        <button id="btn-load" class="action-btn">Carregar</button>
        <button id="btn-save" class="action-btn primary">Salvar</button>
    </div>
    <div class="actions-full">
        <button id="btn-export" class="action-btn export">Exportar JSON</button>
    </div>
</div>

<div id="help-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Geometria do Ensopado</h3>
        </div>
        <div class="modal-body">
            <p>Esta simulação demonstra como princípios matemáticos universais criam padrões de eficiência e beleza na natureza, desde o micro (sementes) ao macro (galáxias).</p>
            
            <h4>1. A Sequência e o Número de Ouro</h4>
            <p>A sequência de Fibonacci é definida por $F_n = F_{n-1} + F_{n-2}$. À medida que avançamos, a razão entre termos consecutivos aproxima-se da <b>Proporção Áurea</b> ($\phi$):</p>
            <div class="formula-box">$$\phi = \frac{1 + \sqrt{5}}{2} \approx 1,6180339...$$</div>

            <h4>2. O Ângulo de Ouro ($\theta$)</h4>
            <p>Para distribuir pontos uniformemente sem criar alinhamentos artificiais ou espaços vazios, utilizamos o <b>Ângulo de Ouro</b>. Ele é a divisão do círculo ($360^\circ$) pela proporção áurea:</p>
            <div class="formula-box">$$\theta = 2\pi \cdot (1 - \frac{1}{\phi}) \approx 137,508^\circ$$</div>
            <p>Este ângulo irracional garante que cada novo grão se encaixe no espaço livre deixado pelos anteriores de forma otimizada.</p>

            <h4>3. Modelo de Vogel (Distribuição)</h4>
            <p>Para manter a densidade de grãos constante do centro até à borda, o raio $r$ cresce com a raiz quadrada do índice do ponto ($n$):</p>
            <div class="formula-box">$$r_n = R_{base} \cdot \sqrt{\frac{n}{N_{total}}}$$</div>
            <p>Isso é conhecido como o <b>Disco de Vogel</b>, comum na filotaxia das plantas.</p>

            <h4>4. Forma do Parabolóide</h4>
            <p>A tigela é um <b>Parabolóide de Revolução</b>. A altura vertical $y$ é calculada proporcionalmente ao quadrado da distância radial:</p>
            <div class="formula-box">$$y_n = \left(\frac{r_n}{R_{max}}\right)^2 \cdot \text{Profundidade}$$</div>
            <p>Esta forma permite que o ensopado se acumule naturalmente no fundo central.</p>

            <h4>5. Volume e Sopa</h4>
            <p>A sopa verde é um sólido gerado via <code>LatheGeometry</code>, que rotaciona o perfil da parábola calculada em 360°, criando um volume estanque que preenche o recipiente até ao nível selecionado.</p>
        </div>
        <div class="modal-footer">
            <button id="close-modal">Fechar Explicação</button>
        </div>
    </div>
</div>

<div id="toast">Ação concluída!</div>

<script>
    /** * ENSOPADO DE FIBONACCI - MOTOR 3D
     */
    let scene, camera, renderer, controls, bowlMesh, soupVolume;
    const GOLDEN_ANGLE = Math.PI * (3 - Math.sqrt(5));
    const BOWL_RADIUS = 8;
    const STORAGE_KEY = 'fibonacci_soup_v13_restored';

    // Configuração Inicial Solicitada
    const INIT_PARAMS = {
        config: { points: 3263, soup: 69, curv: 0.6, thick: 0.15 },
        cam: {
            pos: [-1.1866895298439588, 11.357444446007714, 27.076275858201164],
            target: [0.2373635322153126, 7.184758003224262, -3.545807535737603]
        }
    };

    window.onload = init;

    function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(...INIT_PARAMS.cam.pos);

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.body.appendChild(renderer.domElement);

        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.target.set(...INIT_PARAMS.cam.target);
        controls.enableDamping = true;

        // Luzes
        scene.add(new THREE.AmbientLight(0xffffff, 0.4));
        const sun = new THREE.DirectionalLight(0xffffff, 1);
        sun.position.set(10, 20, 10);
        scene.add(sun);
        
        const soupFill = new THREE.PointLight(0x2ecc71, 0.6);
        soupFill.position.set(-15, 5, -15);
        scene.add(soupFill);

        setupUI();
        updateGeometry();
        animate();
    }

    function setupUI() {
        const trigger = document.getElementById('settings-trigger');
        const panel = document.getElementById('interface');
        const hBtn = document.getElementById('help-btn');
        const modal = document.getElementById('help-modal');

        trigger.onclick = () => panel.classList.toggle('visible');
        
        hBtn.onclick = () => {
            modal.style.display = 'flex';
            if (window.MathJax) MathJax.typesetPromise([modal]);
        };
        
        document.getElementById('close-modal').onclick = () => modal.style.display = 'none';
        modal.onclick = (e) => { if (e.target === modal) modal.style.display = 'none'; };

        // Sincronizar Sliders
        ['points', 'soupLevel', 'curvature', 'thickness'].forEach(id => {
            const input = document.getElementById(id === 'soupLevel' ? 'soupLevel' : (id === 'curvature' ? 'curvature' : (id === 'thickness' ? 'thickness' : 'points')));
            // Mapeamento de IDs do HTML para os internos
            const targetId = id === 'soupLevel' ? 'soupLevel' : (id === 'curvature' ? 'curvature' : (id === 'thickness' ? 'thickness' : 'points'));
            const el = document.getElementById(targetId);
            
            el.oninput = () => {
                const valTxt = document.getElementById(`val-${targetId}`);
                valTxt.innerText = targetId === 'soupLevel' ? el.value + '%' : el.value;
                updateGeometry();
            };
        });

        document.getElementById('btn-save').onclick = () => {
            const state = {
                p: { points: document.getElementById('points').value, soup: document.getElementById('soupLevel').value, curv: document.getElementById('curvature').value, thick: document.getElementById('thickness').value },
                c: { pos: camera.position.toArray(), tar: controls.target.toArray() }
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            showToast("Estado Salvo!");
        };

        document.getElementById('btn-load').onclick = () => {
            const data = JSON.parse(localStorage.getItem(STORAGE_KEY));
            if (!data) return;
            document.getElementById('points').value = data.p.points;
            document.getElementById('soupLevel').value = data.p.soup;
            document.getElementById('curvature').value = data.p.curv;
            document.getElementById('thickness').value = data.p.thick;
            
            document.getElementById('val-points').innerText = data.p.points;
            document.getElementById('val-soupLevel').innerText = data.p.soup + '%';
            document.getElementById('val-curvature').innerText = data.p.curv;
            document.getElementById('val-thickness').innerText = data.p.thick;

            camera.position.fromArray(data.c.pos);
            controls.target.fromArray(data.c.tar);
            updateGeometry();
            showToast("Restaurado!");
        };

        document.getElementById('btn-export').onclick = () => {
            const json = {
                configuracao: {
                    pontos: document.getElementById('points').value,
                    nivel_sopa: document.getElementById('soupLevel').value + "%",
                    curvatura: document.getElementById('curvature').value,
                    espessura: document.getElementById('thickness').value
                },
                camera: { posicao: camera.position.toArray(), foco: controls.target.toArray() },
                metadados: { nome: "Ensopado Perpétuo de Fibonacci", data: new Date().toISOString() }
            };
            const textArea = document.createElement("textarea");
            textArea.value = JSON.stringify(json, null, 2);
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showToast("JSON no Clipboard!");
        };
    }

    function updateGeometry() {
        if (bowlMesh) { scene.remove(bowlMesh); bowlMesh.geometry.dispose(); }
        if (soupVolume) { scene.remove(soupVolume); soupVolume.geometry.dispose(); }

        const N = parseInt(document.getElementById('points').value);
        const curv = parseFloat(document.getElementById('curvature').value);
        const thick = parseFloat(document.getElementById('thickness').value);
        const level = parseInt(document.getElementById('soupLevel').value) / 100;
        const hMax = BOWL_RADIUS * curv;

        // BOWL
        const geo = new THREE.SphereGeometry(thick, 8, 8);
        const mat = new THREE.MeshPhongMaterial({ color: 0xee2222, shininess: 80 });
        bowlMesh = new THREE.InstancedMesh(geo, mat, N);
        
        const dummy = new THREE.Object3D();
        for (let i = 0; i < N; i++) {
            const t = i / (N - 1);
            const r = Math.sqrt(t) * BOWL_RADIUS;
            const y = Math.pow(r / BOWL_RADIUS, 2) * hMax;
            const theta = i * GOLDEN_ANGLE;
            dummy.position.set(Math.cos(theta) * r, y, Math.sin(theta) * r);
            dummy.scale.setScalar(0.7 + t * 0.6);
            dummy.updateMatrix();
            bowlMesh.setMatrixAt(i, dummy.matrix);
        }
        scene.add(bowlMesh);

        // SOPA
        if (level > 0.02) {
            const sY = level * hMax;
            const pts = [new THREE.Vector2(0, 0)];
            for (let j = 1; j <= 25; j++) {
                const y = (j / 25) * sY;
                const r = BOWL_RADIUS * Math.sqrt(y / hMax);
                pts.push(new THREE.Vector2(r, y));
            }
            pts.push(new THREE.Vector2(0, sY));
            const sGeo = new THREE.LatheGeometry(pts, 64);
            const sMat = new THREE.MeshPhongMaterial({ color: 0x27ae60, transparent: true, opacity: 0.9, shininess: 120 });
            soupVolume = new THREE.Mesh(sGeo, sMat);
            scene.add(soupVolume);
        }
    }

    function showToast(m) {
        const t = document.getElementById('toast');
        t.innerText = m; t.style.opacity = 1;
        setTimeout(() => t.style.opacity = 0, 2500);
    }

    function onResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }
    window.addEventListener('resize', onResize);

    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        if(bowlMesh) bowlMesh.rotation.y += 0.0003;
        if(soupVolume) soupVolume.rotation.y += 0.0003;
        renderer.render(scene, camera);
    }
</script>
</body>
</html>