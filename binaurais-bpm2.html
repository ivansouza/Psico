<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harmonia - Biofeedback & Meditação</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Inter', sans-serif; color: white; }
        canvas { display: block; }
        .glass { background: rgba(10, 12, 20, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .panel-anim { transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1); transform-origin: bottom right; }
        .hidden-panel { opacity: 0; transform: scale(0.95) translateY(40px); pointer-events: none; }
        
        #pulse-graph { width: 100%; height: 50px; background: rgba(239, 68, 68, 0.05); border-radius: 12px; margin-top: 10px; }
        .btn-active { background: rgba(99, 102, 241, 0.4) !important; border-color: #818cf8 !important; }
        
        /* Preview da lente para calibração */
        #cam-preview {
            position: fixed; top: 20px; right: 20px; width: 70px; height: 70px;
            border-radius: 50%; overflow: hidden; border: 2px solid rgba(255,255,255,0.3);
            z-index: 50; background: #111;
        }
        #video-feed { width: 100%; height: 100%; object-fit: cover; }
        input[type="range"] { accent-color: #818cf8; height: 4px; }
    </style>
</head>
<body>

    <!-- Preview de Lente (Fundamental para o Poco F6 Pro) -->
    <div id="cam-preview" class="hidden">
        <video id="video-feed" autoplay playsinline muted></video>
    </div>
    <canvas id="canvas-ppg" width="50" height="50" class="hidden"></canvas>

    <!-- UI Overlay -->
    <div class="fixed inset-0 pointer-events-none z-10 flex flex-col justify-between p-6 md:p-10">
        
        <!-- Topo: Dados Biométricos -->
        <div class="flex justify-between items-start">
            <div class="opacity-40">
                <h1 class="text-xs font-light tracking-[0.5em] uppercase">Harmonia</h1>
                <p id="system-status" class="text-[8px] uppercase tracking-[0.2em] mt-1 text-indigo-400">Bio-Sincronização</p>
            </div>
            
            <div id="bpm-display" class="hidden glass px-6 py-4 rounded-[2.5rem] flex flex-col items-center border-indigo-500/20">
                <div class="flex items-center gap-4">
                    <div id="heart-dot" class="w-3 h-3 bg-red-600 rounded-full shadow-[0_0_15px_rgba(220,38,38,1)]"></div>
                    <span class="text-3xl font-bold tabular-nums"><span id="bpm-val">--</span></span>
                    <span class="text-[10px] opacity-40 uppercase tracking-widest">BPM</span>
                </div>
                <canvas id="pulse-graph"></canvas>
            </div>
        </div>

        <!-- Painel de Controlos -->
        <div class="flex flex-col items-end gap-3 self-end">
            
            <div id="settings-panel" class="panel-anim hidden-panel glass p-8 rounded-[3rem] w-80 md:w-96 pointer-events-auto shadow-2xl mb-2 max-h-[80vh] overflow-y-auto">
                <h2 class="text-[10px] font-bold uppercase tracking-widest text-indigo-400 mb-6">Configurações Avançadas</h2>

                <div class="space-y-6">
                    <!-- Configuração de Câmara -->
                    <div class="space-y-2">
                        <p class="text-[9px] uppercase opacity-50">Sensor de Batimento</p>
                        <button id="btn-init-cam" class="w-full text-[10px] py-4 glass rounded-2xl border border-white/5 uppercase tracking-widest hover:bg-white/5">Ativar Câmara</button>
                        <div class="flex gap-2">
                            <button id="btn-switch-cam" class="flex-1 text-[9px] py-3 glass rounded-xl border border-white/5 opacity-30" disabled>Trocar Lente</button>
                            <button id="btn-flash" class="w-16 glass rounded-xl border border-white/5 flex items-center justify-center opacity-30" disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2 L3 14 L12 14 L11 22 L21 10 L12 10 Z"/></svg>
                            </button>
                        </div>
                    </div>

                    <!-- Configuração de Som -->
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-4 bg-white/5 rounded-2xl">
                            <span class="text-[9px] uppercase tracking-widest opacity-50">Sincronia Sonora</span>
                            <button id="toggle-sound-sync" class="w-10 h-6 bg-white/10 rounded-full relative transition-colors">
                                <div id="knob" class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform"></div>
                            </button>
                        </div>
                        <div>
                            <div class="flex justify-between text-[9px] mb-2 uppercase opacity-50">
                                <span>Batimento Binaural: <span id="hz-val">7.8</span> Hz</span>
                            </div>
                            <input type="range" id="hz-range" min="0.5" max="15" step="0.1" value="7.8" class="w-full">
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="setNoise('pink')" id="n-pink" class="text-[8px] py-2 glass rounded-lg">Rosa</button>
                            <button onclick="setNoise('brown')" id="n-brown" class="text-[8px] py-2 glass rounded-lg">Fundo</button>
                            <button onclick="setNoise('none')" class="text-[8px] py-2 glass rounded-lg">Off</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botões Rápidos -->
            <div class="flex gap-2 pointer-events-auto items-center">
                <button id="btn-psy" class="glass w-12 h-12 rounded-2xl flex items-center justify-center hover:bg-pink-500/10 transition-all" title="Modo Transcendência">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
                </button>
                <button id="btn-info" class="glass w-12 h-12 rounded-2xl flex items-center justify-center hover:bg-white/10">
                    <span class="text-lg font-serif italic text-indigo-300">?</span>
                </button>
                <button id="btn-play" class="glass w-14 h-14 rounded-2xl flex items-center justify-center hover:bg-white/10 shadow-2xl">
                    <div id="play-icon" class="w-0 h-0 border-t-[8px] border-t-transparent border-l-[14px] border-l-white border-b-[8px] border-b-transparent ml-1"></div>
                    <div id="pause-icon" class="hidden flex gap-1.5"><div class="w-1.5 h-5 bg-white rounded-full"></div><div class="w-1.5 h-5 bg-white rounded-full"></div></div>
                </button>
                <button id="btn-gear" class="glass w-14 h-14 rounded-2xl flex items-center justify-center hover:bg-white/10">
                    <svg id="gear-svg" class="transition-transform duration-700" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Informativo -->
    <div id="modal-info" class="fixed inset-0 z-50 bg-black/80 backdrop-blur-md opacity-0 pointer-events-none transition-opacity duration-500 flex items-center justify-center p-6">
        <div class="glass max-w-xl w-full p-10 rounded-[3rem] shadow-2xl relative">
            <h2 class="text-xl font-light text-indigo-400 mb-6 font-light uppercase tracking-widest">A Ciência do Harmonia</h2>
            <div id="modal-body" class="text-sm text-gray-400 space-y-4 leading-relaxed font-light">
                <p><strong>Biofeedback Adaptativo:</strong> O sistema utiliza a câmara para detetar micro-variações no fluxo sanguíneo (PPG). Quando o stress é detetado, a música pulsa em sincronia e a frequência binaural desce para induzir calma profunda.</p>
                <p><strong>Instruções Poco F6 Pro:</strong> Cubra a lente traseira principal. Se não houver sinal, use o botão "Trocar Lente" no painel de definições até que o preview no topo fique totalmente vermelho com o seu dedo.</p>
            </div>
            <button id="btn-close-modal" class="mt-8 px-8 py-2 border border-white/10 rounded-full text-[10px] uppercase tracking-widest hover:bg-white/10">Entendido</button>
        </div>
    </div>

    <!-- Shaders -->
    <script id="vertexShader" type="x-shader/x-vertex">
        varying vec2 vUv; void main() { vUv = uv; gl_Position = vec4(position, 1.0); }
    </script>

    <script id="fragmentShader" type="x-shader/x-fragment">
        uniform float u_time;
        uniform vec2 u_res;
        uniform float u_intensity;
        uniform float u_bpm_pulse;
        uniform bool u_psy;
        varying vec2 vUv;

        mat2 rot(float a) { return mat2(cos(a), -sin(a), sin(a), cos(a)); }

        void main() {
            vec2 uv = (gl_FragCoord.xy * 2.0 - u_res.xy) / min(u_res.y, u_res.x);
            uv *= (1.0 - u_bpm_pulse * 0.08); // Pulsação visual com o coração
            
            vec3 final = vec3(0.0);
            float t = u_time * 0.12;

            if(u_psy) {
                uv += sin(uv.yx * 3.5 + t) * 0.15;
                uv *= rot(t * 0.4);
            }

            for(float i = 0.0; i < 3.0; i++) {
                uv = fract(uv * 1.5) - 0.5;
                float d = length(uv) * exp(-length(uv));
                vec3 col = mix(vec3(0.1, 0.2, 0.5), vec3(0.5, 0.1, 0.7), u_bpm_pulse);
                if(u_psy) col = mix(col, vec3(0.8, 0.4, 0.1), sin(t));
                
                d = abs(sin(d * 8.0 + t)) / 12.0;
                final += col * pow(0.008 / d, 1.2);
            }

            gl_FragColor = vec4(final * u_intensity, 1.0);
        }
    </script>

    <script>
        /** MOTOR DE ÁUDIO **/
        let audioCtx, oscL, oscR, masterGain, noiseNode, noiseGain, isPlaying = false;
        let isSoundSync = false;

        function initAudio() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            masterGain = audioCtx.createGain(); masterGain.gain.value = 0;
            masterGain.connect(audioCtx.destination);

            const pL = audioCtx.createStereoPanner(); pL.pan.value = -1; pL.connect(masterGain);
            const pR = audioCtx.createStereoPanner(); pR.pan.value = 1; pR.connect(masterGain);

            oscL = audioCtx.createOscillator(); oscR = audioCtx.createOscillator();
            oscL.connect(pL); oscR.connect(pR);
            oscL.start(); oscR.start();

            noiseGain = audioCtx.createGain(); noiseGain.gain.value = 0.05;
            noiseGain.connect(masterGain);

            updateAudio();
        }

        function updateAudio(time = 0.5) {
            if(!audioCtx) return;
            const b = parseFloat(document.getElementById('hz-range').value);
            oscL.frequency.setTargetAtTime(432 - b/2, audioCtx.currentTime, time);
            oscR.frequency.setTargetAtTime(432 + b/2, audioCtx.currentTime, time);
            document.getElementById('hz-val').innerText = b.toFixed(1);
        }

        function setNoise(type) {
            if(!audioCtx) initAudio();
            if(noiseNode) { noiseNode.stop(); noiseNode.disconnect(); }
            if(type === 'none') return;
            const buf = audioCtx.createBuffer(1, audioCtx.sampleRate * 2, audioCtx.sampleRate);
            const data = buf.getChannelData(0);
            for(let i=0; i<buf.length; i++) data[i] = Math.random() * 2 - 1;
            noiseNode = audioCtx.createBufferSource();
            noiseNode.buffer = buf; noiseNode.loop = true;
            noiseNode.connect(noiseGain); noiseNode.start();
        }

        function pulseSound() {
            if(!isPlaying || !isSoundSync || !audioCtx) return;
            const now = audioCtx.currentTime;
            noiseGain.gain.cancelScheduledValues(now);
            noiseGain.gain.setTargetAtTime(0.25, now, 0.04);
            noiseGain.gain.setTargetAtTime(0.08, now + 0.08, 0.2);
        }

        /** BIOFEEDBACK PPG PRO **/
        let video = document.getElementById('video-feed'),
            canvasIn = document.getElementById('canvas-ppg'),
            ctxIn = canvasIn.getContext('2d'),
            gCanvas = document.getElementById('pulse-graph'),
            gCtx = gCanvas.getContext('2d'),
            stream, track, cameras = [], camIdx = 0, ppgData = [], bpm = 0;

        async function initPPG() {
            if(stream) stream.getTracks().forEach(t => t.stop());
            const all = await navigator.mediaDevices.enumerateDevices();
            cameras = all.filter(d => d.kind === 'videoinput');
            
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { deviceId: cameras[camIdx].deviceId, width: 128, height: 128 } 
                });
                video.srcObject = stream;
                track = stream.getTracks()[0];
                document.getElementById('cam-preview').classList.remove('hidden');
                document.getElementById('bpm-display').classList.remove('hidden');
                document.getElementById('btn-switch-cam').disabled = false;
                document.getElementById('btn-switch-cam').classList.remove('opacity-30');
                
                const caps = track.getCapabilities();
                if(caps.torch) {
                    document.getElementById('btn-flash').disabled = false;
                    document.getElementById('btn-flash').classList.remove('opacity-30');
                }
                
                processPPG();
            } catch(e) { console.error("Falha na câmara:", e); }
        }

        function processPPG() {
            if(!stream) return;
            ctxIn.drawImage(video, 0, 0, 50, 50);
            const d = ctxIn.getImageData(0,0,50,50).data;
            let v = 0; for(let i=0; i<d.length; i+=4) v += (d[i] + d[i+1]) / 2; // Média R+G
            v /= (d.length / 4);
            ppgData.push(v); if(ppgData.length > 150) ppgData.shift();
            
            detectBPM();
            drawGraph();
            requestAnimationFrame(processPPG);
        }

        function detectBPM() {
            if(ppgData.length < 60) return;
            let peaks = 0, rising = false, last = ppgData[0];
            const min = Math.min(...ppgData), max = Math.max(...ppgData), 
                  thresh = min + (max - min) * 0.75;

            for(let i=1; i<ppgData.length; i++) {
                if(ppgData[i] > last && !rising && ppgData[i] > thresh) {
                    peaks++; rising = true;
                    pulseSound(); // Gatilho de som no batimento!
                } else if(ppgData[i] < last) rising = false;
                last = ppgData[i];
            }
            
            const est = Math.round((peaks / (ppgData.length / 30)) * 60);
            if(est > 45 && est < 170) {
                bpm = Math.round(bpm * 0.9 + est * 0.1);
                document.getElementById('bpm-val').innerText = bpm;
                document.getElementById('heart-dot').style.transform = 'scale(1.5)';
                setTimeout(() => document.getElementById('heart-dot').style.transform = 'scale(1)', 100);

                // BIOFEEDBACK ADAPTATIVO
                if(isPlaying && bpm > 85) {
                    const el = document.getElementById('hz-range');
                    if(parseFloat(el.value) > 2.0) {
                        el.value = (parseFloat(el.value) - 0.05).toFixed(1);
                        updateAudio();
                    }
                }
            }
        }

        function drawGraph() {
            gCtx.clearRect(0,0, gCanvas.width, gCanvas.height);
            gCtx.beginPath(); gCtx.strokeStyle = '#ef4444'; gCtx.lineWidth = 2;
            const min = Math.min(...ppgData), max = Math.max(...ppgData), r = max - min || 1;
            for(let i=0; i<ppgData.length; i++) {
                const x = (i/150) * gCanvas.width, y = gCanvas.height - ((ppgData[i]-min)/r) * gCanvas.height;
                if(i===0) gCtx.moveTo(x,y); else gCtx.lineTo(x,y);
            }
            gCtx.stroke();
        }

        /** VISUALS & ENGINE **/
        let scene, camera, renderer, material;
        function setupVisuals() {
            scene = new THREE.Scene();
            camera = new THREE.OrthographicCamera(-1, 1, 1, -1, 0, 1);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.prepend(renderer.domElement);
            material = new THREE.ShaderMaterial({
                uniforms: { u_time: {value:0}, u_res: {value: new THREE.Vector2(window.innerWidth, window.innerHeight)}, u_intensity: {value:0.5}, u_bpm_pulse: {value:0}, u_psy: {value:false} },
                vertexShader: document.getElementById('vertexShader').textContent,
                fragmentShader: document.getElementById('fragmentShader').textContent
            });
            scene.add(new THREE.Mesh(new THREE.PlaneGeometry(2,2), material));
        }

        /** UI BINDINGS **/
        document.getElementById('btn-play').addEventListener('click', () => {
            if(!audioCtx) initAudio();
            if(audioCtx.state === 'suspended') audioCtx.resume();
            isPlaying = !isPlaying;
            masterGain.gain.setTargetAtTime(isPlaying ? 0.6 : 0, audioCtx.currentTime, 1.5);
            document.getElementById('play-icon').classList.toggle('hidden', isPlaying);
            document.getElementById('pause-icon').classList.toggle('hidden', !isPlaying);
            document.getElementById('system-status').innerText = isPlaying ? "Sessão Ativa" : "Pausado";
        });

        document.getElementById('btn-init-cam').addEventListener('click', function() {
            initPPG(); this.classList.add('btn-active');
            document.getElementById('system-status').innerText = "Calibrando Sensor...";
        });

        document.getElementById('btn-switch-cam').addEventListener('click', () => {
            camIdx = (camIdx + 1) % cameras.length;
            initPPG();
        });

        document.getElementById('btn-flash').addEventListener('click', async function() {
            const on = !(track.getConstraints().advanced?.[0]?.torch);
            await track.applyConstraints({ advanced: [{ torch: on }] });
            this.classList.toggle('btn-active', on);
        });

        document.getElementById('toggle-sound-sync').addEventListener('click', function() {
            isSoundSync = !isSoundSync;
            document.getElementById('knob').style.transform = isSoundSync ? 'translateX(16px)' : 'translateX(0)';
            this.classList.toggle('bg-indigo-600', isSoundSync);
        });

        document.getElementById('btn-psy').addEventListener('click', function() {
            material.uniforms.u_psy.value = !material.uniforms.u_psy.value;
            this.classList.toggle('btn-active', material.uniforms.u_psy.value);
        });

        document.getElementById('btn-gear').addEventListener('click', () => {
            document.getElementById('settings-panel').classList.toggle('hidden-panel');
            document.getElementById('gear-svg').style.transform = document.getElementById('settings-panel').classList.contains('hidden-panel') ? 'rotate(0deg)' : 'rotate(180deg)';
        });

        document.getElementById('btn-info').addEventListener('click', () => {
            document.getElementById('modal-info').classList.remove('opacity-0', 'pointer-events-none');
        });

        document.getElementById('btn-close-modal').addEventListener('click', () => {
            document.getElementById('modal-info').classList.add('opacity-0', 'pointer-events-none');
        });

        document.getElementById('hz-range').addEventListener('input', () => updateAudio());
        window.onload = () => { setupVisuals(); (function loop(t){ 
            requestAnimationFrame(loop); 
            material.uniforms.u_time.value = t * 0.001;
            material.uniforms.u_intensity.value = isPlaying ? 0.75 : 0.35;
            if(bpm > 0) material.uniforms.u_bpm_pulse.value = (Math.sin(t * 0.006 * (bpm/60)) + 1) / 2;
            renderer.render(scene, camera); 
        })(0); };
    </script>
</body>
</html>

