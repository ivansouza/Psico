<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ethereal Particle Flow Field</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
</head>
<body>
    <script>
        // Global variables
        let particles = [];
        let numParticles = 1500;
        let noiseScale = 0.005;
        let zOff = 0;
        let baseHue = 0;

        // Particle class
        class Particle {
            constructor() {
                // Random initial position and size for organic distribution and depth variation
                this.pos = createVector(random(width), random(height));
                this.vel = createVector(0, 0);
                this.acc = createVector(0, 0);
                this.size = random(1, 4); // Variable size for depth illusion
                // Fixed hue offset for pentadic color harmony (5 discrete colors, offset by 72 degrees)
                this.hueOffset = floor(random(5)) * 72;
            }

            // Update particle physics and forces
            update() {
                // Multi-layered Perlin noise for flow field: base + 0.5 * finer octave at 2x scale
                // This creates more complex, turbulent fluid-like motion (mathematical enhancement: fractal noise approximation)
                let xOff = this.pos.x * noiseScale;
                let yOff = this.pos.y * noiseScale;
                let baseNoise = noise(xOff, yOff, zOff);
                let octaveNoise = noise(xOff * 2, yOff * 2, zOff);
                let combinedNoise = baseNoise + 0.5 * octaveNoise;
                // Map to angle for directional flow (0 to ~3Ï€ for swirling variety)
                let angle = combinedNoise * TWO_PI;
                // Apply flow force as unit vector scaled by 0.15
                let force = p5.Vector.fromAngle(angle);
                force.mult(0.15);
                this.acc.add(force);

                // Mouse interaction: attraction force (vector math: direction normalized, inverse distance falloff)
                // Enhances interactivity; strength inversely proportional to distance for subtle pull near cursor
                if (mouseIsPressed) {
                    let mousePos = createVector(mouseX, mouseY);
                    let dir = p5.Vector.sub(mousePos, this.pos);
                    let dist = dir.mag();
                    if (dist > 0) {
                        dir.normalize();
                        let strength = 0.05 / (dist + 1); // Avoid division by zero, gentle falloff
                        dir.mult(strength);
                        this.acc.add(dir);
                    }
                }

                // Standard physics: Euler integration with velocity limiting
                this.vel.add(this.acc);
                this.vel.limit(3); // maxSpeed = 3 for controlled flow
                this.pos.add(this.vel);
                this.acc.mult(0); // Reset acceleration

                // Edge wrapping for seamless toroidal field (prevents particles from escaping canvas)
                this.edges();
            }

            // Wrap around edges for continuous flow
            edges() {
                if (this.pos.x > width) this.pos.x = 0;
                else if (this.pos.x < 0) this.pos.x = width;
                if (this.pos.y > height) this.pos.y = 0;
                else if (this.pos.y < 0) this.pos.y = height;
            }

            // Display with dynamic coloring for cosmic, glowing trails
            display() {
                // Time-based hue shift for evolving palette (enhancement: subtle animation over frames)
                let h = (baseHue + this.hueOffset) % 360;
                fill(h, 80, 100, 8); // HSV pentadic palette, low alpha for additive trails
                ellipse(this.pos.x, this.pos.y, this.size);
            }
        }

        // P5.js setup: Initialize canvas, mode, and particles
        function setup() {
            createCanvas(windowWidth, windowHeight);
            colorMode(HSB, 360, 100, 100, 100); // HSV for intuitive color control
            blendMode(ADD); // Additive blending for ethereal glow accumulation
            noStroke(); // Clean, no outlines for fluid aesthetics
            // Instantiate particles
            for (let i = 0; i < numParticles; i++) {
                particles.push(new Particle());
            }
        }

        // Main draw loop: Fade background, update globals, simulate particles
        function draw() {
            // Background fade for persistent trails (enhancement: alpha 5 creates glowing afterimages)
            fill(0, 0, 0, 5);
            rect(0, 0, width, height);

            // Update time-based elements
            baseHue = (frameCount * 0.1) % 360; // Slow hue rotation for cosmic color cycling
            zOff += 0.002; // Incremental z-offset for evolving 3D noise field over time

            // Update and display all particles
            for (let particle of particles) {
                particle.update();
                particle.display();
            }
        }

        // Handle window resize: Maintain full-screen, reset background fade (no particle reinitialization to preserve flow)
        function windowResized() {
            resizeCanvas(windowWidth, windowHeight);
            // Trigger a fade to clear artifacts from resize
            fill(0, 0, 0, 5);
            rect(0, 0, width, height);
        }
    </script>
</body>
</html>