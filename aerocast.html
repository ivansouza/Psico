<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AeroCast Global | HUD de Piloto</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body, html { 
            margin: 0; padding: 0; overflow: hidden; 
            background: #000; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            height: 100%; width: 100%;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        #canvas-container { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; 
        }

        .glass-panel {
            background: rgba(10, 25, 41, 0.85);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(0, 255, 255, 0.25);
            color: #00f2ff;
            text-shadow: 0 0 5px rgba(0, 242, 255, 0.5);
        }

        .status-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: 30px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; font-size: 10px; z-index: 100; font-weight: bold;
            color: rgba(0, 255, 255, 0.8);
            background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent);
        }

        #weather-sheet, #add-city-sheet {
            position: fixed; bottom: -100%; left: 0; width: 100%; height: 85%;
            z-index: 60; transition: bottom 0.6s cubic-bezier(0.22, 1, 0.36, 1);
            border-top-left-radius: 30px; border-top-right-radius: 30px;
            padding: 24px; display: flex; flex-direction: column;
        }
        #weather-sheet.active, #add-city-sheet.active { bottom: 0; }

        .sheet-handle {
            width: 50px; height: 5px; background: rgba(0, 255, 255, 0.2);
            border-radius: 10px; margin: 0 auto 20px auto;
        }

        .telemetry-log {
            font-size: 0.6rem; height: 50px; overflow: hidden;
            mask-image: linear-gradient(to top, black, transparent);
        }

        .hud-scanline {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: repeating-linear-gradient(0deg, rgba(0,0,0,0.03) 0px, rgba(0,0,0,0) 2px);
            pointer-events: none; z-index: 50;
        }

        .loading-screen {
            position: fixed; inset: 0; background: black; z-index: 200;
            display: flex; flex-direction: column; justify-content: center;
            align-items: center; color: #00f2ff;
        }

        input {
            background: rgba(0, 242, 255, 0.05);
            border: 1px solid rgba(0, 242, 255, 0.3);
            color: #00f2ff;
            padding: 16px;
            border-radius: 16px;
            width: 100%;
            outline: none;
            font-family: monospace;
        }

        .tide-indicator {
            height: 40px; background: rgba(0,242,255,0.05);
            position: relative; border-radius: 12px; overflow: hidden; border: 1px solid rgba(0,242,255,0.15);
        }
        .tide-wave {
            position: absolute; top: 0; left: 0; height: 100%;
            background: linear-gradient(90deg, rgba(0,242,255,0.2), rgba(0,242,255,0.5));
            transition: width 1.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .loader-dots::after {
            content: '...';
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } 80%, 100% { content: ''; } }
    </style>
</head>
<body>

    <div id="loading" class="loading-screen">
        <div class="text-xl mb-4 tracking-[0.4em] font-black italic">AEROCAST GLOBAL</div>
        <div class="w-56 h-[1px] bg-cyan-900 overflow-hidden">
            <div id="loader-bar" class="h-full bg-[#00f2ff] w-0 transition-all duration-300 shadow-[0_0_10px_#00f2ff]"></div>
        </div>
        <div id="status-text" class="mt-4 text-[10px] uppercase opacity-50 tracking-widest font-mono">Calibrando Uplink Hidrometeo...</div>
    </div>

    <div class="status-bar">
        <div id="status-clock">00:00</div>
        <div class="flex gap-2 items-center">
            <span class="text-[8px] border border-cyan-500/30 px-1 font-mono tracking-tighter uppercase">Protocolo_Costa_v3.0</span>
            <svg class="w-3 h-3 fill-current" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z"/></svg>
        </div>
    </div>

    <div class="hud-scanline"></div>
    <div id="canvas-container"></div>

    <!-- Interface Superior HUD -->
    <div class="fixed top-12 left-0 w-full px-5 z-10 flex justify-between items-start pointer-events-none">
        <div class="glass-panel p-3 rounded-2xl flex flex-col gap-1 pointer-events-auto">
            <div class="text-[0.5rem] opacity-70 font-mono tracking-tighter uppercase">Status do Sat√©lite</div>
            <div class="telemetry-log font-mono" id="mini-log">
                <div>> SISTEMA OPERACIONAL</div>
            </div>
        </div>
        <div class="text-right flex flex-col items-end">
            <div class="text-[0.6rem] bg-cyan-500/20 text-cyan-400 px-2 py-0.5 rounded border border-cyan-500/50 font-bold mb-2 italic uppercase tracking-widest">Aerocast v6.0</div>
            <div class="text-[0.5rem] opacity-50 font-mono uppercase">Zoom: <span id="hud-zoom">1.00</span>x</div>
            <div class="text-[0.5rem] opacity-50 font-mono uppercase">Marcadores: <span id="marker-count">0</span></div>
        </div>
    </div>

    <!-- Barra de A√ß√µes Inferior -->
    <div class="fixed bottom-0 left-0 w-full p-6 pb-10 z-10 flex justify-between items-end pointer-events-none">
        <div class="flex gap-2 pointer-events-auto">
            <button onclick="resetGlobe()" class="bg-cyan-500/10 border border-cyan-500/40 text-cyan-400 px-4 py-2 rounded-xl text-[10px] font-bold uppercase tracking-widest active:scale-95 transition-transform">
                Recalibrar
            </button>
            <button onclick="toggleAddCity()" class="bg-[#00f2ff]/20 border border-[#00f2ff]/60 text-[#00f2ff] px-4 py-2 rounded-xl text-[10px] font-bold uppercase tracking-widest shadow-[0_0_10px_rgba(0,242,255,0.2)] transition-all">
                + Localizar Alvo
            </button>
        </div>
        <div class="text-right glass-panel p-2 px-3 rounded-xl border-none">
            <div class="text-[0.5rem] opacity-60 uppercase">Estado da Conex√£o</div>
            <div id="hud-city" class="text-[10px] font-black italic text-white uppercase">Varredura Livre</div>
        </div>
    </div>

    <!-- Painel de Meteorologia Completo -->
    <div id="weather-sheet" class="glass-panel">
        <div class="sheet-handle" onclick="closeWeather()"></div>
        
        <div class="flex justify-between items-start mb-6">
            <div class="flex-grow">
                <div class="flex items-center gap-2 mb-1">
                    <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
                    <span class="text-[0.6rem] font-bold tracking-widest text-red-400 uppercase">Dados Hidrometeo Sincronizados</span>
                </div>
                <h2 id="city-name" class="text-4xl font-black italic tracking-tighter uppercase leading-none mb-1">---</h2>
                <div class="flex flex-col gap-2">
                    <div id="city-coords" class="text-[0.6rem] opacity-60 font-mono tracking-widest">0.00¬∞N, 0.00¬∞E</div>
                    <div class="text-[0.7rem] font-bold text-cyan-400 flex items-center gap-1.5 bg-cyan-400/10 px-3 py-1.5 rounded-lg border border-cyan-400/30 w-fit">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.4 0-8-3.6-8-8s3.6-8 8-8 8 3.6 8 8-3.6 8-8 8zm.5-13H11v6l5.2 3.2.8-1.3-4.5-2.7V7z"/></svg>
                        HORA LOCAL: <span id="city-local-time" class="font-mono text-white tracking-widest uppercase">--:--</span>
                    </div>
                </div>
            </div>
            <div class="text-right">
                <div id="current-temp" class="text-6xl font-black italic leading-none mb-1">--¬∞C</div>
                <div id="weather-desc" class="text-[0.6rem] uppercase tracking-widest text-[#00f2ff] font-bold italic">Processando...</div>
            </div>
        </div>

        <div class="flex-grow flex flex-col gap-4 overflow-y-auto pr-1">
            <!-- M√≥dulo Lunar e Mar√© -->
            <div id="marine-telemetry" class="grid grid-cols-2 gap-3 hidden">
                <div class="bg-white/5 border border-white/10 p-5 rounded-3xl flex items-center justify-between">
                    <div>
                        <div class="text-[0.5rem] opacity-50 mb-1 uppercase tracking-wider">Ciclo Lunar</div>
                        <div id="moon-phase-name" class="text-[0.75rem] font-black uppercase text-white italic">---</div>
                    </div>
                    <div id="moon-icon-container" class="text-4xl">
                        <!-- √çcone Injetado -->
                    </div>
                </div>
                <div class="bg-white/5 border border-white/10 p-5 rounded-3xl">
                    <div class="text-[0.5rem] opacity-50 mb-1 uppercase tracking-wider">T√°bua de Mar√©</div>
                    <div class="flex justify-between items-end mb-2">
                        <span id="tide-status" class="text-[0.75rem] font-black italic uppercase text-cyan-400">---</span>
                        <span id="tide-percentage" class="text-[0.6rem] font-mono opacity-80">0%</span>
                    </div>
                    <div class="tide-indicator">
                        <div id="tide-wave-bar" class="tide-wave" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Dados Atmosf√©ricos -->
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-white/5 border border-white/10 p-5 rounded-3xl">
                    <div class="text-[0.5rem] opacity-50 mb-1 uppercase tracking-wider">Vento M√©dio</div>
                    <div id="wind-speed" class="text-2xl font-black italic">-- <span class="text-[10px] opacity-50 font-normal">KM/H</span></div>
                </div>
                <div class="bg-white/5 border border-white/10 p-5 rounded-3xl">
                    <div class="text-[0.5rem] opacity-50 mb-1 uppercase tracking-wider">Humidade Rel.</div>
                    <div id="humidity-val" class="text-2xl font-black italic">-- <span class="text-[10px] opacity-50 font-normal">%</span></div>
                </div>
            </div>

            <div class="bg-white/5 border border-white/10 rounded-3xl p-5 h-48">
                <div class="text-[0.5rem] opacity-30 mb-3 uppercase font-bold tracking-widest">Varia√ß√£o T√©rmica Satelital (12h)</div>
                <canvas id="weather-chart"></canvas>
            </div>

            <div id="obs-list" class="p-5 bg-cyan-400/5 border border-cyan-400/20 rounded-2xl text-[0.65rem] font-mono grid grid-cols-2 gap-y-3 opacity-90 uppercase italic"></div>

            <button onclick="closeWeather()" class="w-full btn-primary py-5 rounded-2xl font-black uppercase tracking-[0.2em] text-[11px] mt-2 mb-8 border border-cyan-500/20 shadow-lg shadow-cyan-500/10">
                Encerrar Monitoriza√ß√£o
            </button>
        </div>
    </div>

    <!-- Painel de Busca -->
    <div id="add-city-sheet" class="glass-panel">
        <div class="sheet-handle" onclick="toggleAddCity()"></div>
        <div class="mb-8">
            <h2 class="text-3xl font-black italic tracking-tighter uppercase leading-tight">Alvo de Geocodifica√ß√£o</h2>
            <p class="text-[0.6rem] opacity-50 font-mono uppercase tracking-widest">Introduza o nome da cidade para varredura satelital</p>
        </div>
        <div class="flex flex-col gap-6">
            <input type="text" id="in-name" placeholder="Ex: Macei√≥, Lisboa, Bras√≠lia..." autocomplete="off">
            <div id="search-status" class="text-[0.6rem] font-mono text-cyan-400 hidden italic">Sincronizando coordenadas via uplink<span class="loader-dots"></span></div>
            <button id="btn-submit" onclick="submitNewCity()" class="w-full bg-[#00f2ff] text-black py-5 rounded-2xl font-black uppercase tracking-widest text-[11px] shadow-[0_0_20px_rgba(0,242,255,0.4)]">
                Confirmar Localiza√ß√£o
            </button>
            <button onclick="toggleAddCity()" class="w-full py-4 text-[10px] uppercase font-bold opacity-50 tracking-widest">Abortar Busca</button>
        </div>
    </div>

    <script>
        // --- BASE DE DADOS AMPLIADA E NORMALIZADA ---
        const COASTAL_KEYWORDS = [
            "LISBOA", "RIO DE JANEIRO", "RECIFE", "PORTO", "SYDNEY", "NEW YORK", "MIAMI", 
            "SALVADOR", "FORTALEZA", "FLORIANOPOLIS", "MACEIO", "SANTOS", "VITORIA", 
            "NATAL", "JOAO PESSOA", "ARACAJU", "SAO LUIS", "MANGARATIBA", "ANGRA DOS REIS",
            "CABO FRIO", "BUZIOS", "BARCELONA", "VALENCIA", "MARSEILLE", "NAPOLI", "DUBAI",
            "MUMBAI", "SHANGHAI", "SINGAPORE", "VANCOUVER", "LOS ANGELES", "LUANDA", "MAPUTO"
        ];

        const CITIES = [
            { n: "Bras√≠lia", lat: -15.78, lng: -47.93, isCoastal: false },
            { n: "Macei√≥", lat: -9.66, lng: -35.73, isCoastal: true },
            { n: "Rio de Janeiro", lat: -22.9, lng: -43.1, isCoastal: true }, 
            { n: "Lisboa", lat: 38.7, lng: -9.1, isCoastal: true },
            { n: "Recife", lat: -8.05, lng: -34.88, isCoastal: true },
            { n: "S√£o Paulo", lat: -23.55, lng: -46.63, isCoastal: false }
        ];

        let scene, camera, renderer, globe, clouds, controls;
        let markers = [];
        let raycaster = new THREE.Raycaster();
        let mouse = new THREE.Vector2();
        let isZoomingToCity = false;
        let weatherChart = null;
        let timeUpdateInterval = null;

        // --- UTILIT√ÅRIOS ---

        function normalizeStr(str) {
            return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().trim();
        }

        function checkIfCoastal(name) {
            const cleanName = normalizeStr(name);
            // Verifica se alguma palavra-chave est√° contida no nome ou vice-versa
            return COASTAL_KEYWORDS.some(kw => {
                const normKw = normalizeStr(kw);
                return cleanName.includes(normKw) || normKw.includes(cleanName);
            });
        }

        function getMoonPhase(date) {
            const cycle = 29.530588853;
            const baseDate = new Date(2000, 0, 6, 18, 14);
            const diff = (date.getTime() - baseDate.getTime()) / 1000 / 60 / 60 / 24;
            const phase = (diff % cycle) / cycle;
            if (phase < 0.06) return { name: "Lua Nova", icon: "üåë" };
            if (phase < 0.25) return { name: "Crescente", icon: "üåí" };
            if (phase < 0.31) return { name: "Quarto Crescente", icon: "üåì" };
            if (phase < 0.50) return { name: "Gibosa Crescente", icon: "üåî" };
            if (phase < 0.56) return { name: "Lua Cheia", icon: "üåï" };
            if (phase < 0.75) return { name: "Gibosa Minguante", icon: "üåñ" };
            if (phase < 0.81) return { name: "Quarto Minguante", icon: "üåó" };
            return { name: "Minguante", icon: "üåò" };
        }

        function getSimulatedTide(lng) {
            const now = new Date();
            const hour = now.getUTCHours() + (lng / 15);
            const wave = (Math.sin(hour * Math.PI / 6.2) + 1) / 2; 
            return {
                percentage: Math.round(wave * 100),
                status: (Math.cos(hour * Math.PI / 6.2) > 0) ? "Enchendo" : "Vazando"
            };
        }

        // --- MOTOR 3D ---

        function init() {
            updateStatus("Mapping Geometry...", 30);
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 2000);
            camera.position.z = 320;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 0.4;

            const ambient = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambient);
            const sun = new THREE.DirectionalLight(0xffffff, 1.2);
            sun.position.set(5, 3, 5);
            scene.add(sun);

            createGlobe();
            CITIES.forEach(city => createMarker(city));

            updateStatus("Uplink Established", 100);
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                updateMarkerCounter();
                animate();
                startClock();
            }, 1000);

            window.addEventListener('resize', onResize);
            renderer.domElement.addEventListener('mousedown', (e) => processClick(e.clientX, e.clientY));
            renderer.domElement.addEventListener('touchstart', (e) => processClick(e.touches[0].clientX, e.touches[0].clientY));
        }

        function updateStatus(text, progress) {
            document.getElementById('status-text').innerText = text;
            document.getElementById('loader-bar').style.width = progress + '%';
        }

        function createGlobe() {
            const loader = new THREE.TextureLoader();
            const geo = new THREE.SphereGeometry(100, 64, 64);
            const mat = new THREE.MeshPhongMaterial({
                map: loader.load('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg'),
                bumpMap: loader.load('https://unpkg.com/three-globe/example/img/earth-topology.png'),
                bumpScale: 1.5, shininess: 5
            });
            globe = new THREE.Mesh(geo, mat);
            scene.add(globe);

            const cloudMat = new THREE.MeshPhongMaterial({
                map: loader.load('https://unpkg.com/three-globe/example/img/earth-clouds.png'),
                transparent: true, opacity: 0.3
            });
            clouds = new THREE.Mesh(new THREE.SphereGeometry(102, 64, 64), cloudMat);
            scene.add(clouds);

            const atmos = new THREE.Mesh(
                new THREE.SphereGeometry(118, 64, 64),
                new THREE.MeshBasicMaterial({ color: 0x00f2ff, transparent: true, opacity: 0.08, side: THREE.BackSide })
            );
            scene.add(atmos);
        }

        function createMarker(city) {
            const phi = (90 - city.lat) * (Math.PI / 180);
            const theta = (city.lng + 180) * (Math.PI / 180);
            const x = -(101 * Math.sin(phi) * Math.cos(theta));
            const z = (101 * Math.sin(phi) * Math.sin(theta));
            const y = (101 * Math.cos(phi));
            
            const group = new THREE.Group();
            group.position.set(x, y, z);
            group.add(new THREE.Mesh(new THREE.SphereGeometry(1.4, 8, 8), new THREE.MeshBasicMaterial({ color: 0x00f2ff })));
            const halo = new THREE.Mesh(new THREE.RingGeometry(1.8, 3.2, 16), new THREE.MeshBasicMaterial({ color: 0x00f2ff, transparent: true, opacity: 0.4, side: THREE.DoubleSide }));
            halo.lookAt(0,0,0);
            group.add(halo);
            group.userData = city;
            scene.add(group);
            markers.push(group);
        }

        function toggleAddCity() { document.getElementById('add-city-sheet').classList.toggle('active'); }

        async function submitNewCity() {
            const nameInput = document.getElementById('in-name');
            const searchStatus = document.getElementById('search-status');
            const cityName = nameInput.value.trim();
            if (!cityName) return;
            searchStatus.classList.remove('hidden');

            try {
                const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(cityName)}&count=1&language=pt&format=json`);
                const geoData = await geoRes.json();
                if (geoData.results && geoData.results.length > 0) {
                    const res = geoData.results[0];
                    const coastalStatus = checkIfCoastal(res.name);
                    const newCity = { n: res.name, lat: res.latitude, lng: res.longitude, isCoastal: coastalStatus };
                    createMarker(newCity);
                    updateMarkerCounter();
                    toggleAddCity();
                    zoomToCity(newCity, markers[markers.length-1].position);
                    logTelemetry(`LOCALIZADO: ${res.name.toUpperCase()}`);
                } else {
                    logTelemetry(`ALVO N√ÉO IDENTIFICADO`);
                }
            } catch (err) { logTelemetry("ERRO_GEOLOC_FAIL"); }
            finally { searchStatus.classList.add('hidden'); nameInput.value = ""; }
        }

        function updateMarkerCounter() { document.getElementById('marker-count').innerText = markers.length; }

        function processClick(x, y) {
            mouse.x = (x / window.innerWidth) * 2 - 1;
            mouse.y = -(y / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const hits = raycaster.intersectObjects(markers, true);
            if (hits.length > 0) {
                let obj = hits[0].object;
                while(obj.parent && !obj.userData.n) obj = obj.parent;
                if (obj.userData.n) zoomToCity(obj.userData, obj.position);
            }
        }

        function zoomToCity(city, pos) {
            if (isZoomingToCity) return;
            isZoomingToCity = true;
            controls.autoRotate = false;
            const targetPos = pos.clone().normalize().multiplyScalar(175);
            gsap.to(camera.position, {
                x: targetPos.x, y: targetPos.y, z: targetPos.z,
                duration: 1.5, ease: "power3.inOut",
                onUpdate: () => camera.lookAt(0,0,0),
                onComplete: () => { isZoomingToCity = false; openWeather(city); }
            });
        }

        async function openWeather(city) {
            document.getElementById('weather-sheet').classList.add('active');
            document.getElementById('city-name').innerText = city.n;
            document.getElementById('city-coords').innerText = `${city.lat.toFixed(2)}¬∞N, ${city.lng.toFixed(2)}¬∞E`;
            document.getElementById('hud-city').innerText = city.n.toUpperCase();
            
            if (timeUpdateInterval) clearInterval(timeUpdateInterval);

            // M√≥dulo Mar√©/Lua - Corre√ß√£o para Macei√≥ e cidades com acento
            const marineBox = document.getElementById('marine-telemetry');
            if (city.isCoastal) {
                marineBox.classList.remove('hidden');
                const phase = getMoonPhase(new Date());
                document.getElementById('moon-phase-name').innerText = phase.name;
                document.getElementById('moon-icon-container').innerText = phase.icon;
                
                const tide = getSimulatedTide(city.lng);
                document.getElementById('tide-status').innerText = tide.status;
                document.getElementById('tide-percentage').innerText = tide.percentage + "%";
                gsap.to("#tide-wave-bar", { width: tide.percentage + "%", duration: 1.5, ease: "power2.out" });
            } else {
                marineBox.classList.add('hidden');
            }

            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lng}&current_weather=true&hourly=temperature_2m&timezone=auto`);
                const data = await res.json();
                
                document.getElementById('current-temp').innerText = `${Math.round(data.current_weather.temperature)}¬∞C`;
                document.getElementById('wind-speed').innerText = data.current_weather.windspeed;
                document.getElementById('humidity-val').innerText = Math.floor(Math.random()*20 + 60);
                document.getElementById('weather-desc').innerText = data.current_weather.weathercode === 0 ? "C√âU LIMPO" : "SINAL ATMOSF√âRICO";
                
                const updateLocalTime = () => {
                    const localTimeStr = new Date().toLocaleTimeString('pt-BR', {
                        timeZone: data.timezone, hour: '2-digit', minute: '2-digit', hour12: false
                    });
                    document.getElementById('city-local-time').innerText = localTimeStr;
                };
                updateLocalTime();
                timeUpdateInterval = setInterval(updateLocalTime, 20000);
                renderChart(data.hourly.temperature_2m.slice(0, 12));
                updateObs();
            } catch (err) { logTelemetry("ERR_UPLINK_FAIL"); }
        }

        function updateObs() {
            document.getElementById('obs-list').innerHTML = `
                <div>Visibilidade</div><div class="text-white">12.4 KM</div>
                <div>Press√£o</div><div class="text-white">1012 HPA</div>
                <div>√çndice UV</div><div class="text-white">${Math.floor(Math.random()*7)}</div>
                <div>Orvalho</div><div class="text-white">${Math.floor(Math.random()*5+5)}¬∞C</div>
            `;
        }

        function renderChart(tempData) {
            const ctx = document.getElementById('weather-chart').getContext('2d');
            if (weatherChart) weatherChart.destroy();
            weatherChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['-12h', '-10h', '-8h', '-6h', '-4h', '-2h', 'AGORA', '+2h', '+4h', '+6h', '+8h', '+10h'],
                    datasets: [{ data: tempData, borderColor: '#00f2ff', backgroundColor: 'rgba(0, 242, 255, 0.1)', fill: true, tension: 0.4, borderWidth: 2, pointRadius: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: 'rgba(0,242,255,0.4)', font: { size: 7 } } }, y: { display: false } } }
            });
        }

        function closeWeather() { 
            document.getElementById('weather-sheet').classList.remove('active'); 
            document.getElementById('hud-city').innerText = "VIGIL√ÇNCIA GLOBAL";
        }
        function resetGlobe() { closeWeather(); gsap.to(camera.position, { x: 0, y: 0, z: 320, duration: 2, ease: "power2.inOut", onUpdate: () => camera.lookAt(0,0,0), onComplete: () => controls.autoRotate = true }); }
        function animate() { requestAnimationFrame(animate); controls.update(); clouds.rotation.y += 0.001; markers.forEach(m => m.lookAt(camera.position)); renderer.render(scene, camera); }
        function logTelemetry(msg) { const log = document.getElementById('mini-log'); const d = document.createElement('div'); d.innerText = `> ${msg}`; log.prepend(d); if(log.childNodes.length > 5) log.removeChild(log.lastChild); }
        function startClock() { setInterval(() => { const n = new Date(); document.getElementById('status-clock').innerText = n.getHours().toString().padStart(2,'0') + ":" + n.getMinutes().toString().padStart(2,'0'); }, 1000); }
        function onResize() { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); }

        init();
    </script>
</body>
</html>

